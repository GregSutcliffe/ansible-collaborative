<h1>Getting Started With OSPFV2 Resource Modules</h1>
<p>With the increasing size and complexity of modern enterprise networks,
the demand on simplifying the networks management becomes more intense.
The introduction of resources modules with Ansible 2.9
provide a path to users to ease the network management, especially
across multiple different product vendors.</p>
<p>In the past, we've already covered resource modules for
VLAN management and for <code>ACLs</code>.
However, simplifying network management is not limited to rather local
network setups: Open Shortest Path First (OSPFv2) is a
protocol used to distribute IP routing information throughout a single
Autonomous System (AS). It is used in larger network setups, as the
<a href="https://en.wikipedia.org/w/index.php?title=Open_Shortest_Path_First&amp;oldid=967345042">Wikipedia page so aptly observes</a></p>
<p><em>OSPF is a widely used IGP in large enterprise networks. IS-IS, another LSR-based protocol, is more common in large service provider networks.</em></p>
<p>Managing OSPFv2 manually for a network device can be a very difficult
and tedious task, and more often this needs to be performed carefully,
as the manual process is more prone to human error.</p>
<p>This blog post goes through the OSPFV2 resource module for the VyOS
network platform. We will walk through several examples and describe the
use cases for each state parameter and how we envision these being used
in real world scenarios.</p>
<h2>OSPFv2 resource modules example: Vyos</h2>
<p>The goal of OSPFv2 resource modules is to make sure configurations are
consistently applied across the infrastructure with less effort. It
simplifies management and makes it faster and easier to scale without
worrying about the actual implementation details of the network
platforms working under the hood.</p>
<p>In October of 2019, as part of Red Hat Ansible Engine 2.9, the Ansible
Network Automation team introduced the
concept of resource modules to make network automation easier and
more consistent for those automating various network platforms in
production.</p>
<p>Ansible Content refers to Ansible Playbooks, modules, module utilities
and plugins. Basically all of the Ansible tools that users utilize to
create their Ansible and the OSPFv2 resource module is part of Ansible
Content Collections.</p>
<p>Let's have a closer look at how the OSPFv2 resource modules work. As an
example, we pick the <a href="https://docs.ansible.com/ansible/latest/modules/eos_vlans_module.html">vyos_</a> ospfv2 resource module. In this blog, we'll be using a VyOS router with version
1.1.8 (helium) for all the configuration management specific operations.
Also, to better showcase the effect of the modules, we will start with
some <a href="https://gist.github.com/rohitthakur2590/4446ba7c274659395381495e28229943">OSPF version 2 specific attributes</a>
already configured. Check out the linked listing for further details.</p>
<h3>Accessing and using the VyOS Collection</h3>
<p>To download the VyOS Collection, refer to Automation Hub (fully
supported, requires a Red Hat Ansible Automation Platform subscription)
or Ansible Galaxy (upstream community
supported):</p>
<ul>
<li><a href="https://cloud.redhat.com/ansible/automation-hub/vyos/vyos">Automation Hub Collection</a>: <code>vyos.vyos</code></li>
<li><a href="https://galaxy.ansible.com/vyos/vyos">Ansible Galaxy Collection</a>: <code>vyos.vyos</code></li>
</ul>
<p>Before we get started, let's quickly explain the rationale behind
naming the network resource modules. Notice for resource modules that
configure OSPFV2 routes, the newly added modules will be named based on
the IP address type. This was done so that those using existing network
modules would not have their Ansible Playbooks stop working and have
sufficient time to migrate to the new network automation modules.</p>
<p>A module to configure OSPFv2 is also available for the following
supported platforms:</p>
<ul>
<li><a href="https://galaxy.ansible.com/arista/eos">Arista EOS (arista.eos.eos_ospfv2)</a></li>
<li><a href="https://galaxy.ansible.com/cisco/ios">Cisco IOS (cisco.ios.ios_ospfv2)</a> </li>
<li><a href="https://galaxy.ansible.com/cisco/iosxr">Cisco IOSXR (cisco.ios.iosxr_ospfv2)</a></li>
<li><a href="https://galaxy.ansible.com/cisco/nxos">Cisco NXOS (cisco.nxos.nxos_ospfv2)</a></li>
<li><a href="https://galaxy.ansible.com/junipernetworks/junos">Juniper junos (junipernetwork.junos.junos_ospfv2)</a></li>
<li><a href="https://galaxy.ansible.com/vyos/vyos">Vyos (vyos.vyos.vyos_ospfv2)</a></li>
</ul>
<p>The OSPFV2 resource module provides the same level functionality that a
user can achieve when configuring manually on to the VyOS device with
all advantages of Ansible, plus with an added edge of
Ansible facts gathering and resource
module approach, which is more closely aligned with network professionals day
to day working.</p>
<h2>Use Case: OSPFv2 configuration changes</h2>
<h3>Using state gathered - Building an Ansible inventory</h3>
<p>Resource modules allow the user to read in existing network
configuration and convert that into a structured data model. The
<strong>state: gathered</strong> is the equivalent for gathering
Ansible Facts for this specific resource. This example will read in the
existing network configuration and store it as a
flat-file.</p>
<p>Here is an Ansible Playbook example of using
<strong>state: gathered</strong> and storing the result as YAML into
host_vars. If you are new to Ansible Inventory and want to learn about
group_vars and host_vars, please refer to the
<a href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html">documentation here.</a></p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">convert configured OSPFV2 resource to structured data</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vyos</span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">inventory_dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;lab_inventory&quot;</span>
<span class="w">    </span><span class="nt">inventory_hostname</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;vyos&quot;</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Use the OSPFV2 resource module to gather the current config</span>
<span class="w">    </span><span class="nt">vyos.vyos.vyos_ospfv2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gathered</span>
<span class="w">    </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ospfv2</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create inventory directory</span>
<span class="w">    </span><span class="nt">file</span><span class="p">:</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">inventory_dir</span><span class="nv"> </span><span class="s">}}/host_vars/{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">directory</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Write the OSPFV2 configuration to a file</span>
<span class="w">    </span><span class="nt">copy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">{&#39;ospfv2&#39;:</span><span class="nv"> </span><span class="s">ospfv2[&#39;gathered&#39;]}</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">to_nice_yaml</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">inventory_dir</span><span class="nv"> </span><span class="s">}}/host_vars/{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}/ospfv2.yaml&quot;</span>
</pre></div>

<p>Execute the Ansible Playbook with the ansible-playbook command:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>ansible-playbook<span class="w"> </span>example.yml
</pre></div>

<p>Here is the data structure that was created from reading/gathered
operation  in a brown-field configuration:</p>
<div class="code"><pre class="code literal-block"><span class="l l-Scalar l-Scalar-Plain">$ cat nw_inventory/host_vars/vyos/ospfv2.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">ospfv2</span><span class="p p-Indicator">:</span>
<span class="w">  </span><span class="nt">areas</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">area_id</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2&#39;</span>
<span class="w">    </span><span class="nt">area_type</span><span class="p">:</span>
<span class="w">      </span><span class="nt">normal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">authentication</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plaintext-password</span>
<span class="w">    </span><span class="nt">shortcut</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">area_id</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;4&#39;</span>
<span class="w">    </span><span class="nt">area_type</span><span class="p">:</span>
<span class="w">      </span><span class="nt">stub</span><span class="p">:</span>
<span class="w">        </span><span class="nt">default_cost</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
<span class="w">        </span><span class="nt">set</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>

<p>You can check out the full detailed listing of the output of this
example in the <a href="https://gist.github.com/rohitthakur2590/0e18173ee73a07a050d5b02ec6777c3d">state: gathered reference gist</a>.</p>
<h3>Using state merged - Pushing configuration changes</h3>
<p>The state merged will take your Ansible configuration data (i.e.
Ansible variables) and merges them into the network device's running
configuration. This will not affect existing configuration not specified
in your Ansible configuration data. Let's walk through an
example.</p>
<p>We will modify the flat-file created in the first example with a
<a href="https://gist.github.com/rohitthakur2590/31cf81adff5ff538ee201eae8f66fc7a">configuration to be merged</a>.</p>
<p>Here are the most important pieces:</p>
<div class="code"><pre class="code literal-block"><span class="nt">areas</span><span class="p">:</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">area_id</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2&#39;</span>
<span class="w">   </span><span class="nt">area_type</span><span class="p">:</span>
<span class="w">     </span><span class="nt">normal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">   </span><span class="nt">authentication</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;plaintext-password&quot;</span>
<span class="w">   </span><span class="nt">shortcut</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;enable&#39;</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">area_id</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3&#39;</span>
<span class="w">   </span><span class="nt">area_type</span><span class="p">:</span>
<span class="w">     </span><span class="nt">nssa</span><span class="p">:</span>
<span class="w">       </span><span class="nt">set</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>

<p>Now let's create an Ansible Playbook to merge this new configuration
into the network device's running configuration:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Merged state play</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vyos</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Merge OSPFV2 config with device existing OSPFV2 config</span>
<span class="w">      </span><span class="nt">vyos.vyos.vyos_ospfv2</span><span class="p">:</span>
<span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">merged</span>
<span class="w">        </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ospfv2</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>

<p>Execute the Ansible Playbook with the ansible-playbook command:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>ansible-playbook<span class="w"> </span>merged.yml
</pre></div>

<p>And, once we run the respective Merge play, all of the provided
parameters will be configured on the VyOS router with Ansible
<strong>changed=True.</strong></p>
<p>Note the network configuration after the merge operation:</p>
<div class="code"><pre class="code literal-block">vyos@vyos:~$<span class="w"> </span>show<span class="w"> </span>configuration<span class="w"> </span>commands<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ospf
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>ospf<span class="w"> </span>area<span class="w"> </span><span class="m">2</span><span class="w"> </span>area-type<span class="w"> </span><span class="s1">&#39;normal&#39;</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>ospf<span class="w"> </span>area<span class="w"> </span><span class="m">2</span><span class="w"> </span>authentication<span class="w"> </span><span class="s1">&#39;plaintext-password&#39;</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>ospf<span class="w"> </span>area<span class="w"> </span><span class="m">2</span><span class="w"> </span>shortcut<span class="w"> </span><span class="s1">&#39;enable&#39;</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>ospf<span class="w"> </span>area<span class="w"> </span><span class="m">3</span><span class="w"> </span>area-type<span class="w"> </span><span class="s1">&#39;nssa&#39;</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>ospf<span class="w"> </span>area<span class="w"> </span><span class="m">4</span><span class="w"> </span>area-type<span class="w"> </span>stub<span class="w"> </span>default-cost<span class="w"> </span><span class="s1">&#39;20&#39;</span>
</pre></div>

<p>Note that this listing only shows a few highlights; the full listing is
available in the <a href="https://gist.github.com/rohitthakur2590/9d59ca2b4e2b396bea1af32eefcc2d9d">merged gist</a>.</p>
<p>Let's take a look at what has changed through this operation: if we go
through the device output, there are a few
observations:</p>
<ul>
<li>Attribute area with area_id '3' got added to the OSPF areas list. </li>
<li>The redistribute and parameter attribute got configured for OSPF.</li>
<li>If there was an already configured OSPF with AREA and the user
    wanted to update any parameter for that particular AREA, then the
    user can also use the Merged state to update the AREA under OSPFV2.</li>
</ul>
<p>With the second run, the respective Merge Play runs again and Ansible
charm of Idempotency comes to picture. If nothing's changed, play run
results into changed=False, which confirms to the user that all of
the provided configurations in the play are already configured on the IOS device.</p>
<h3>Using state replaced - Replacing configuration</h3>
<p>If the user wants to re-configure the VyOS device entirely
pre-configured OSPFV2 with the provided OSPFV2 configuration, then the
resource module <em>replaced</em> state comes into picture.</p>
<p>The scope of the replaced operation is up to the individual processes.
In the case of VyOS only a single process is supported. As a result, the
replaced state acts similar to the overridden state. For that reason a
dedicated overridden state is not required with the VyOS modules. Other
network platforms that support multiple OSPFV2 processes do have the
overridden state operation.</p>
<p>Using the overridden state, a user can override all OSPFV2 resource
attributes with user-provided OSPFV2 configuration. Since this resource
module state overrides all pre-existing attributes of the resource
module, the overridden state should be used cautiously, as OSPFV2
configurations are very important; if all the configurations are
mistakenly replaced with the play input configuration, it might create
unnecessary issues for the network administrators. </p>
<p>In this scenario, OSPF with 'n' number AREAs are already configured on
the VyOS device, and now the user wants to update the AREA list with a
new set of AREAs and discard all the already configured OSPF AREAs.
Here, the resource module replaced state will be an ideal choice and, as
the name suggests, the replaced state will replace OSPF existing AREA
list with a new set of AREAs given as input by the user.</p>
<p>If a user tries to configure any new OSPFV2 AREA/attribute that's not
already pre-configured on the device, it'll act as a merged state and
the vyos_ospfv2 module will try to configure the OSPF AREAs given as
input by the user inside the replace play.</p>
<p>We will modify the flat-file created in the first example:</p>
<div class="code"><pre class="code literal-block"><span class="nt">areas</span><span class="p">:</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">area_id</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2&#39;</span>
<span class="w">   </span><span class="nt">area_type</span><span class="p">:</span>
<span class="w">     </span><span class="nt">normal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">   </span><span class="nt">authentication</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;plaintext-password&quot;</span>
<span class="w">   </span><span class="nt">shortcut</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;enable&#39;</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">area_id</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;4&#39;</span>
<span class="w">   </span><span class="nt">area_type</span><span class="p">:</span>
<span class="w">     </span><span class="nt">stub</span><span class="p">:</span>
<span class="w">      </span><span class="nt">default_cost</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
</pre></div>

<p>Check out the
<a href="https://gist.github.com/rohitthakur2590/31b2cce1f5157382025ae6a9d89add04">full input config structure</a>
if you want to learn more details.</p>
<p>Again, we create an Ansible Playbook to merge this new configuration
into the network device's running configuration:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Replaced state play</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vyos</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Replace OSPFV2 config with device existing OSPFV2 config</span>
<span class="w">      </span><span class="nt">vyos.vyos.vyos_ospfv2</span><span class="p">:</span>
<span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replaced</span>
<span class="w">        </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ospfv2</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>

<p>Once we run the respective Replaced play, all of the provided
parameters will override all the existing OSPFv2 resource specific
config on the VyOS router with Ansible
<strong>changed=True</strong>.</p>
<p>The network device configuration after the Replaced
operation:</p>
<div class="code"><pre class="code literal-block">vyos@vyos:~$<span class="w"> </span>show<span class="w"> </span>configuration<span class="w"> </span>commands<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ospf
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>ospf<span class="w"> </span>area<span class="w"> </span><span class="m">2</span><span class="w"> </span>area-type<span class="w"> </span><span class="s1">&#39;normal&#39;</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>ospf<span class="w"> </span>area<span class="w"> </span><span class="m">2</span><span class="w"> </span>authentication<span class="w"> </span><span class="s1">&#39;plaintext-password&#39;</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>ospf<span class="w"> </span>area<span class="w"> </span><span class="m">2</span><span class="w"> </span>shortcut<span class="w"> </span><span class="s1">&#39;enable&#39;</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>ospf<span class="w"> </span>area<span class="w"> </span><span class="m">4</span><span class="w"> </span>area-type<span class="w"> </span>stub<span class="w"> </span>default-cost<span class="w"> </span><span class="s1">&#39;20&#39;</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>ospf<span class="w"> </span>area<span class="w"> </span><span class="m">4</span><span class="w"> </span>network<span class="w"> </span><span class="s1">&#39;192.0.2.0/24&#39;</span>
</pre></div>

<p>Check out the <a href="https://gist.github.com/rohitthakur2590/57bf71dbe2c8417426e7ddcb4f8fd7c0">corresponding gist</a> for more details.</p>
<p>If we dig into the above output, we note the following
changes:</p>
<ul>
<li>Replaced negates all of the pre-existing OSPFV2 resource-specific
    attributes and deletes those configurations, which are not present
    inside the replaced play. In the above example, ospfv2 area-id 3 got
    deleted.</li>
<li>For the OSPFV2 configurations that are pre-existing and also in the
    play, vyos_ospfv2 replaced state will try to delete/negate all the
    pre-existing OSPFV2 config and then configure the new OSPFV2 config
    as mentioned in the play.</li>
<li>For any non-existing OSPFV2 specific attribute, the replaced state
    will configure the OSPFV2 in the same manner as the Merged state. In
    the above example, a new network address configured for OSPFv2
    area-id 4.</li>
</ul>
<p>With the second run of the above play, there
are no changes reported which satisfies the Ansible
idempotency.</p>
<h3>Using state deleted - Delete configuration</h3>
<p>Now that we've talked about how we can configure OSPFV2 specific
attributes on the VyOS device by using vyos_ospfv2 resource module
merged and replaced state, it's time we talk about how we can delete the
pre-configured OSPFV2 attributes and what level of granularity is
available with the deleted operational state for the
user.</p>
<p>Deleting <strong>ALL OSPFV2</strong> config in one go leads to deleting all the pre-configured
<strong>OSPFV2 specific attributes from the VyOS</strong> device. But that said, this is a very critical delete operation and if not used judiciously, it has the power to delete all pre-configured
<strong>OSPFV2</strong> and can result in the production environment with the router having
<strong>no</strong> pre-configured <strong>OSPFV2 attributes</strong>.</p>
<p>Let's create an Ansible Playbook to merge this new configuration into the network device's running configuration:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deleted state play</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vyos</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Delete ALL OSPFV2 config</span>
<span class="w">      </span><span class="nt">vyos.vyos.vyos_ospfv2</span><span class="p">:</span>
<span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deleted</span>
</pre></div>

<p>After we execute the playbook, the network device configuration changed:</p>
<div class="code"><pre class="code literal-block">vyos@vyos:~$<span class="w"> </span>show<span class="w"> </span>configuration<span class="w"> </span>commands<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ospf
vyos@vyos:~$
</pre></div>

<p>Make sure to look at the <a href="https://gist.github.com/rohitthakur2590/bb93302da90fe9f0865313b112998602">full listing of the changed values</a>.
If we dig into the above output briefly, we can see that all the ospfv2
resource-specific config has been removed from the network
configuration.</p>
<h3>Using state rendered - Development and working offline</h3>
<p>Ansible renders the provided configuration in the task in the
device-native format (for example, VyOS CLI). Ansible returns this
rendered configuration in the rendered key in the result. Note this
state does not communicate with the network device and can be used
offline.</p>
<p>To have a config to be rendered, modify the YAML file created in the
first scenario.  For example, if this is the vyos_ospfv2 module, you can
just add a few more attributes to show we change the data model yet
again.</p>
<div class="code"><pre class="code literal-block"><span class="nt">areas</span><span class="p">:</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">area_id</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2&#39;</span>
<span class="w">   </span><span class="nt">area_type</span><span class="p">:</span>
<span class="w">     </span><span class="nt">normal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">   </span><span class="nt">authentication</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;plaintext-password&quot;</span>
</pre></div>

<p>See the full listing in the <a href="https://gist.github.com/rohitthakur2590/d6f6cd599c3e2fecb51dfe628d640a8f">corresponding rendered gist</a>.</p>
<p>We create a playbook to execute this:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Rendered state play</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vyos</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Render the provided configuration</span>
<span class="w">      </span><span class="nt">vyos.vyos.vyos_ospfv2</span><span class="p">:</span>
<span class="w">        </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ospfv2</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rendered</span>
</pre></div>

<p>This produces the following output:</p>
<div class="code"><pre class="code literal-block"><span class="s">&quot;rendered&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">       </span><span class="s">&quot;set</span><span class="nv"> </span><span class="s">protocols</span><span class="nv"> </span><span class="s">ospf</span><span class="nv"> </span><span class="s">log-adjacency-changes</span><span class="nv"> </span><span class="s">&#39;detail&#39;&quot;</span><span class="p p-Indicator">,</span>
<span class="w">       </span><span class="s">&quot;set</span><span class="nv"> </span><span class="s">protocols</span><span class="nv"> </span><span class="s">ospf</span><span class="nv"> </span><span class="s">max-metric</span><span class="nv"> </span><span class="s">router-lsa</span><span class="nv"> </span><span class="s">administrative&quot;</span><span class="p p-Indicator">,</span>
<span class="w">       </span><span class="s">&quot;set</span><span class="nv"> </span><span class="s">protocols</span><span class="nv"> </span><span class="s">ospf</span><span class="nv"> </span><span class="s">max-metric</span><span class="nv"> </span><span class="s">router-lsa</span><span class="nv"> </span><span class="s">on-shutdown</span><span class="nv"> </span><span class="s">10&quot;</span><span class="p p-Indicator">,</span>
</pre></div>

<p>Check out the <a href="https://gist.github.com/rohitthakur2590/862b2321283aafb7c41af342f227d1e8">corresponding gist</a> for more details.</p>
<p>If we dig into the above output, we can see that nothing has changed at
all; rendered doesn't even require the connection establishment with an
actual network device.</p>
<h3>Using state parsed - Development and working offline</h3>
<p>Ansible parses the configuration from the running_configuration option
into Ansible structured data in the parsed key in the result. Note this
does not gather the configuration from the network device, so this state
can be used offline.</p>
<p>As the config to be parsed we take device-native format configuration:</p>
<div class="code"><pre class="code literal-block"><span class="l l-Scalar l-Scalar-Plain">set protocols ospf area 2 area-type &#39;normal&#39;</span>
<span class="l l-Scalar l-Scalar-Plain">set protocols ospf area 2 authentication &#39;plaintext-password&#39;</span>
<span class="l l-Scalar l-Scalar-Plain">set protocols ospf area 2 shortcut &#39;enable&#39;</span>
<span class="l l-Scalar l-Scalar-Plain">set protocols ospf area 4 area-type stub default-cost &#39;20&#39;</span>
<span class="l l-Scalar l-Scalar-Plain">set protocols ospf area 4 network &#39;192.0.2.0/24&#39;</span>
<span class="l l-Scalar l-Scalar-Plain">set protocols ospf area 4 range 192.0.3.0/24 cost &#39;10&#39;</span>
</pre></div>

<p>The playbook to apply this configuration is:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Parsed state play</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vyos</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Parse the provided OSPFV2 configuration</span>
<span class="w">      </span><span class="nt">vyos.vyos.vyos_ospfv2</span><span class="p">:</span>
<span class="w">        </span><span class="nt">running_config</span><span class="p">:</span>
<span class="w">           </span><span class="s">&quot;set</span><span class="nv"> </span><span class="s">protocols</span><span class="nv"> </span><span class="s">ospf</span><span class="nv"> </span><span class="s">area</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">area-type</span><span class="nv"> </span><span class="s">&#39;normal&#39;</span>
<span class="w">            </span><span class="s">set</span><span class="nv"> </span><span class="s">protocols</span><span class="nv"> </span><span class="s">ospf</span><span class="nv"> </span><span class="s">area</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">authentication</span><span class="nv"> </span><span class="s">&#39;plaintext-password&#39;</span>
<span class="w">            </span><span class="s">set</span><span class="nv"> </span><span class="s">protocols</span><span class="nv"> </span><span class="s">ospf</span><span class="nv"> </span><span class="s">area</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">shortcut</span><span class="nv"> </span><span class="s">&#39;enable&#39;</span>
<span class="w">        </span><span class="s">state:</span><span class="nv"> </span><span class="s">parsed</span>
</pre></div>

<p>Execute the playbook generates the following output:</p>
<div class="code"><pre class="code literal-block"><span class="s">&quot;parsed&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">        </span><span class="s">&quot;areas&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">            </span><span class="p p-Indicator">{</span>
<span class="w">                </span><span class="s">&quot;area_id&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;2&quot;</span><span class="p p-Indicator">,</span>
<span class="w">                </span><span class="s">&quot;area_type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">                    </span><span class="s">&quot;normal&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">true</span>
<span class="w">                </span><span class="p p-Indicator">},</span>
<span class="w">                </span><span class="s">&quot;authentication&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;plaintext-password&quot;</span><span class="p p-Indicator">,</span>
<span class="w">                </span><span class="s">&quot;shortcut&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;enable&quot;</span>
<span class="w">             </span><span class="p p-Indicator">}</span>

<span class="w">                </span><span class="p p-Indicator">]</span>
<span class="w">            </span><span class="p p-Indicator">}</span>
<span class="nn">...</span>
</pre></div>

<p>If we dig into the above output, we can see that nothing has changed at
all, parsed operation doesn't even require the connection establishment
with an actual network device.</p>
<p>Note: parsed input to be provided as value to running_config key.</p>
<h2>Takeaways &amp; Next Steps</h2>
<p>As shown above, with the help of the resource modules management of
OSPFV2, resource-specific configurations can be greatly simplified.
Users don't need to bother much about OSPFV2 implementation details for
each platform, they can just enter the actual data. By using the merged,
replaced and overridden parameters, we allow much more flexibility for
network engineers to adopt automation in incremental steps. The other
operations like gathered, rendered and parsed allow a better, user
friendly handling of the facts and the data managed within these
tasks.</p>