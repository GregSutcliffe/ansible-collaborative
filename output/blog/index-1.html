<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Ansible Collaborative Website">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ansible Collaborative (old posts, page 1) | Ansible Collaborative</title>
<link href="../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<!-- Red Hat fonts --><link rel="stylesheet" href="https://static.redhat.com/libs/redhat/redhat-font/2.0.0/webfonts/red-hat-font.css">
<!-- Font Awesome --><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
<!-- Fork Awesome --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css" integrity="sha256-XoaMnoYC5TH6/+ihMEnospgm0J1PM/nioxbOUdnM8HY=" crossorigin="anonymous">
<!-- Sass compiled css  --><link rel="stylesheet" href="../assets/css/main.css">
<link rel="stylesheet" href="../assets/css/redhat-footer.css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://ansible.com/blog/index-1.html">
<link rel="prev" href="index-2.html" type="text/html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]-->
</head>
<body id="top">

<div class="global-container" id="content" role="main">
<!-- Start menubar -->
<nav class="navbar navbar-expand-lg static-top mb-4 navbar-padding full-width-bg   navbar-dark   bg-pool   "><div class="masthead">
    <!-- This keeps the margins nice -->
    <a class="navbar-brand" href="../">
        <img src="../images/ansible_logo-small-15.png" alt="Ansible community logo" id="logo" class="d-inline-block align-top" width="50" height="50"></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon nav-toggle-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="bs-navbar">
      <ul class="navbar-nav mr-auto"></ul>
<ul class="navbar-nav navbar-right">
<li class="nav-item dropdown">
	        <a href="#" class="nav-link nav-link-color dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		    <i class=""></i> Documentation
                </a>
		<div class="dropdown-menu dropdown-menu-border">
	    
                    <a href="https://docs.ansible.com/" class="dropdown-item">
		        <i class=""></i> Project documentation
                    </a>
                    <a href="https://access.redhat.com/documentation/en-us/red_hat_ansible_automation_platform/" class="dropdown-item">
		        <i class=""></i> Ansible Automation Platform documentation
                    </a>
            </div>
                 </li>
<li class="nav-item">
		     <a href="https://galaxy.ansible.com/" target="_blank" class="nav-link nav-link-color">
		         <i class=""></i> Galaxy
		     </a>
		 </li>
                 <li class="nav-item">
		     <a href="https://forum.ansible.com/" target="_blank" class="nav-link nav-link-color">
		         <i class=""></i> Forum
		     </a>
		 </li>
            <li class="nav-item dropdown">
	        <a href="#" class="nav-link nav-link-color dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		    <i class=""></i> Resources
                </a>
		<div class="dropdown-menu dropdown-menu-border">
	    
                    <a href="../how-ansible-works/" class="dropdown-item">
		        <i class=""></i> How Ansible works
                    </a>
                    <a href="../ecosystem/" class="dropdown-item">
		        <i class=""></i> Ansible ecosystem
                    </a>
                    <a href="archive.html" class="dropdown-item">
		        <i class=""></i> Blog
                    </a>
                    <a href="../faq/" class="dropdown-item">
		        <i class=""></i> Frequently asked questions
                    </a>
                    <a href="../ansible-community-training/" class="dropdown-item">
		        <i class=""></i> Ansible community training
                    </a>
                    <a href="../contact-us/" class="dropdown-item">
		        <i class=""></i> Contact us
                    </a>
            </div>
                 </li>
<li class="nav-item">
		     <a href="https://www.redhat.com/en/technologies/management/ansible?sc_cid=7015Y000003szaKQAQ" target="_blank" class="nav-link nav-link-color">
		         <i class=""></i> Ansible Automation Platform
		     </a>
		 </li>

        
      </ul>
</div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav><!-- End default Menubar --><div class="body-content center-band">
        <!--Body content-->
        
    
  <div class="postindex ansible-content">
      <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="command-module-deep-dive-for-networks/" class="u-url">Command Module Deep Dive for Networks</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/sean-cavanaugh/">Sean Cavanaugh</a>
              </span>
            </p>
            <p class="dateline">
              <a href="command-module-deep-dive-for-networks/" rel="bookmark">
                <time class="published dt-published" datetime="2018-06-07T00:00:00Z" itemprop="datePublished" title="2018-06-07 00:00">2018-06-07 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Command Module Deep Dive for Networks</h2>
<p>Enterprise customers often ask the Ansible Network team about the most
common use cases for network automation. For this blog post I want to
talk about one of the most used (and most versatile) set of network
modules: the <code>command</code> modules. The command modules let you run
networking commands with Ansible, the same way a network engineer would
type them on the command line. With Ansible, though, the output doesn't
just fly by the terminal window to be lost forever; it can be stored and
used in subsequent tasks. It can also be captured in variables, parsed
for use by other tasks, and stored in host variables for future
reference.
Today we're going to cover basic use of the network <code>command</code> modules,
including retaining command output with the <code>register</code> parameter. We'll
also cover scaling to multiple network devices with <code>hostvars</code> and
adding conditional requirements with the <code>wait_for</code> parameter and three
related parameters: <code>interval</code>, <code>retries</code>, and <code>match</code>. The takeaway
from this blog post is that any repeatable network operations task can
be automated. Ansible is more than configuration management, it allows
network operators the freedom to decouple themselves from routine tasks
and save themselves time.</p>
<p>There are command modules for a variety of platforms, including all the
modules <a href="https://access.redhat.com/solutions/3184741">supported</a> under
the network offering:</p>
<table>
<thead><tr>
<th>Network Platform</th>
<th>*os_command Module</th>
</tr></thead>
<tbody>
<tr>
<td>Arista EOS</td>
<td><a href="https://docs.ansible.com/ansible/2.4/eos_command_module.html">eos_command</a></td>
</tr>
<tr>
<td>Cisco IOS / IOS-XE</td>
<td><a href="http://docs.ansible.com/ansible/latest/modules/ios_command_module.html">ios_command</a></td>
</tr>
<tr>
<td>Cisco IOS-XR</td>
<td><a href="http://docs.ansible.com/ansible/latest/modules/iosxr_command_module.html">iosxr_command</a></td>
</tr>
<tr>
<td>Cisco NX-OS</td>
<td><a href="http://docs.ansible.com/ansible/latest/modules/nxos_command_module.html">nxos_command</a></td>
</tr>
<tr>
<td>Juniper Junos</td>
<td><a href="http://docs.ansible.com/ansible/latest/modules/junos_command_module.html">junos_command</a></td>
</tr>
<tr>
<td>VyOS</td>
<td><a href="http://docs.ansible.com/ansible/latest/modules/vyos_command_module.html">vyos_command</a></td>
</tr>
</tbody>
</table>
<h3>Basic Command Module Usage</h3>
<p>Here is a simple playbook using eos_command to run <strong>show version</strong>:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">COMMAND MODULE PLAYBOOK</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eos</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">network_cli</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EXECUTE ARISTA EOS COMMAND</span>
<span class="w">     </span><span class="nt">eos_command</span><span class="p">:</span>
<span class="w">       </span><span class="nt">commands</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show version</span>
<span class="w">     </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>

<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PRINT OUT THE OUTPUT VARIABLE</span>
<span class="w">     </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">       </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>
</pre></div>

<p>There are two tasks; the first task uses eos_command with a single
parameter called <strong>commands</strong>. Since I am only running one command I can
just type <code>show version</code> on the same line as commands. If I had more
than one command, I would list each one on a separate line below the
<strong>commands</strong>: parameter. In this example I use the <a href="http://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#registered-variables">register
keyword</a>
to save the output of the show version command. You can use the
<strong>register</strong> parameter at the task level with any Ansible task. The
register parameter defines a variable to store the output of the task
for use in subsequent tasks. In my playbook the variable is called
<strong>output</strong>.</p>
<p>The second task uses the <a href="http://docs.ansible.com/ansible/latest/modules/debug_module.html">debug
module</a>
to print out the content of the variable <strong>output</strong>, from the previous
task. In this case I will see the same output I would have seen if I'd
typed "show version" at the command line directly on the EOS device. My
playbook prints this output in the terminal window where I ran the
playbook. The Ansible <a href="http://docs.ansible.com/ansible/latest/modules/debug_module.html">debug
module</a>
is great for checking variables.</p>
<p>Below is the output from running the playbook:</p>
<div class="code"><pre class="code literal-block">PLAY<span class="w"> </span><span class="o">[</span>eos<span class="o">]</span><span class="w"> </span>*************************************************************************

TASK<span class="w"> </span><span class="o">[</span>execute<span class="w"> </span>Arista<span class="w"> </span>eos<span class="w"> </span>command<span class="o">]</span><span class="w"> </span>**************************************************
ok:<span class="w"> </span><span class="o">[</span>eos<span class="o">]</span>

TASK<span class="w"> </span><span class="o">[</span>print<span class="w"> </span>out<span class="w"> </span>the<span class="w"> </span>output<span class="w"> </span>variable<span class="o">]</span><span class="w"> </span>***********************************************
ok:<span class="w"> </span><span class="o">[</span>eos<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">"output"</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">"changed"</span>:<span class="w"> </span>false,
<span class="w">        </span><span class="s2">"failed"</span>:<span class="w"> </span>false,
<span class="w">        </span><span class="s2">"stdout"</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="s2">"Arista vEOS\nHardware version:    \nSerial number:       \nSystem MAC address:  0800.27ec.005e\n\nSoftware image version: 4.20.1F\nArchitecture:           i386\nInternal build version: 4.20.1F-6820520.4201F\nInternal build ID:      790a11e8-5aaf-4be7-a11a-e61795d05b91\n\nUptime:                 1 day, 3 hours and 23 minutes\nTotal memory:           2017324 kB\nFree memory:            1111848 kB"</span>
<span class="w">        </span><span class="o">]</span>,
<span class="w">        </span><span class="s2">"stdout_lines"</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="o">[</span>
<span class="w">                </span><span class="s2">"Arista vEOS"</span>,
<span class="w">                </span><span class="s2">"Hardware version:    "</span>,
<span class="w">                </span><span class="s2">"Serial number:       "</span>,
<span class="w">                </span><span class="s2">"System MAC address:  0800.27ec.005e"</span>,
<span class="w">                </span><span class="s2">""</span>,
<span class="w">                </span><span class="s2">"Software image version: 4.20.1F"</span>,
<span class="w">                </span><span class="s2">"Architecture:           i386"</span>,
<span class="w">                </span><span class="s2">"Internal build version: 4.20.1F-6820520.4201F"</span>,
<span class="w">                </span><span class="s2">"Internal build ID:      790a11e8-5aaf-4be7-a11a-e61795d05b91"</span>,
<span class="w">                </span><span class="s2">""</span>,
<span class="w">                </span><span class="s2">"Uptime:                 1 day, 3 hours and 23 minutes"</span>,
<span class="w">                </span><span class="s2">"Total memory:           2017324 kB"</span>,
<span class="w">                </span><span class="s2">"Free memory:            1111848 kB"</span>
<span class="w">            </span><span class="o">]</span>
<span class="w">        </span><span class="o">]</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>

PLAY<span class="w"> </span>RECAP<span class="w"> </span>*************************************************************************
eos<span class="w">                        </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w">    </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</pre></div>

<p>You can see in the output above that both tasks were executed
successfully. The first task with the default verbosity has no output,
it simply returns the host the task was executed on, <strong>eos</strong>, with
<strong>ok</strong> and the color green to indicate success. The second task, using
the debug module, returns output from the command that was executed. You
see the same information in two different formats:</p>
<ul>
<li>stdout</li>
<li>stdout_lines</li>
</ul>
<p>The stdout returns everything a human operator would have seen on the
command line in one large string. The stdout_lines returns a list of
strings, making the information easier to read. Each item is a separate
line that was returned from the command.</p>
<p>Here is the output to see what that looks like:</p>
<p><strong>Arista EOS command line output</strong></p>
<div class="code"><pre class="code literal-block">eos&gt;show<span class="w"> </span>vers
Arista<span class="w"> </span>vEOS
Hardware<span class="w"> </span>version:
Serial<span class="w"> </span>number:
System<span class="w"> </span>MAC<span class="w"> </span>address:<span class="w"> </span><span class="m">0800</span>.27ec.005e
Software<span class="w"> </span>image<span class="w"> </span>version:<span class="w"> </span><span class="m">4</span>.20.1F
Architecture:<span class="w"> </span>i386
Internal<span class="w"> </span>build<span class="w"> </span>version:<span class="w"> </span><span class="m">4</span>.20.1F-6820520.4201F
Internal<span class="w"> </span>build<span class="w"> </span>ID:<span class="w"> </span>790a11e8-5aaf-4be7-a11a-e61795d05b91
Uptime:<span class="w"> </span><span class="m">1</span><span class="w"> </span>day,<span class="w"> </span><span class="m">3</span><span class="w"> </span>hours<span class="w"> </span>and<span class="w"> </span><span class="m">56</span><span class="w"> </span>minutes
Total<span class="w"> </span>memory:<span class="w"> </span><span class="m">2017324</span><span class="w"> </span>kB
Free<span class="w"> </span>memory:<span class="w"> </span><span class="m">1116624</span><span class="w"> </span>kB
</pre></div>

<p><strong>Ansible stdout_lines</strong></p>
<div class="code"><pre class="code literal-block"><span class="s2">"stdout_lines"</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="o">[</span>
<span class="w">          </span><span class="s2">"Arista vEOS"</span>,
<span class="w">          </span><span class="s2">"Hardware version:"</span>,
<span class="w">          </span><span class="s2">"Serial number:"</span>,
<span class="w">          </span><span class="s2">"System MAC address: 0800.27ec.005e"</span>,
<span class="w">          </span><span class="s2">""</span>,
<span class="w">          </span><span class="s2">"Software image version: 4.20.1F"</span>,
<span class="w">          </span><span class="s2">"Architecture: i386"</span>,
<span class="w">          </span><span class="s2">""</span>,
<span class="w">          </span><span class="s2">"Internal build version: 4.20.1F-6820520.4201F"</span>,
<span class="w">          </span><span class="s2">"Internal build ID: 790a11e8-5aaf-4be7-a11a-e61795d05b91"</span>,
<span class="w">          </span><span class="s2">""</span>,
<span class="w">          </span><span class="s2">"Uptime: 1 day, 3 hours and 23 minutes"</span>,
<span class="w">          </span><span class="s2">"Total memory: 2017324 kB"</span>,
<span class="w">          </span><span class="s2">"Free memory: 1111848 kB"</span>
<span class="w">        </span><span class="o">]</span>
</pre></div>

<p>Engineers and folks familiar with JSON and YAML have already noticed
another interesting detail: stdout_lines begins with two opening
brackets</p>
<div class="code"><pre class="code literal-block"><span class="s2">"stdout_lines"</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="o">[</span>
</pre></div>

<p>The two opening brackets show that stdout_lines actually returned a list
of lists of strings. If we modify our debug task slightly we use this
feature to view selections from the output. Since the output only has
one list within the list, that entire sub-list is referenced as list
zero, or the first list. Let's look at a single line from the return
value. I want to grab the <strong>System MAC Address</strong> for our test. Looking
above at the output, the <strong>System MAC address</strong> is returned in the
fourth line, which corresponds to line 3 (since computers start counting
from 0). This means we want to grab line 3 of list 0, which corresponds
to <code>output.stdout_lines[0][3]</code>.</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">print out a single line of the output variable</span>
<span class="w">  </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">  </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output.stdout_lines[0][3]</span>
</pre></div>

<p>The debug task returns exactly what we need:</p>
<div class="code"><pre class="code literal-block">TASK<span class="w"> </span><span class="o">[</span>print<span class="w"> </span>out<span class="w"> </span>a<span class="w"> </span>single<span class="w"> </span>line<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>output<span class="w"> </span>variable<span class="o">]</span><span class="w"> </span>******************************
ok:<span class="w"> </span><span class="o">[</span>eos<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">"output.stdout_lines[0][3]"</span>:<span class="w"> </span><span class="s2">"System MAC address:  0800.27ec.005e"</span>
<span class="o">}</span>
</pre></div>

<p>Why would we want that first list to be zero and what is the use case
for having multiple lists? It is possible to run multiple commands with
one command task.Here is a playbook with three commands:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eos</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">network_cli</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">execute Arista eos command</span>
<span class="w">      </span><span class="nt">eos_command</span><span class="p">:</span>
<span class="w">        </span><span class="nt">commands</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show version</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show ip int br</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show int status</span>
<span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">print out command</span>
<span class="w">      </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">        </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output.stdout_lines</span>
</pre></div>

<p>The output from output now looks like this:</p>
<div class="code"><pre class="code literal-block"><span class="s2">"output.stdout_lines"</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="o">[</span>
<span class="w">        </span><span class="s2">"Arista vEOS"</span>,
<span class="w">        </span><span class="s2">"Hardware version:    "</span>,
<span class="w">        </span><span class="s2">"Serial number:       "</span>,
<span class="w">        </span><span class="s2">"System MAC address:  0800.27ec.005e"</span>,
<span class="w">        </span><span class="s2">""</span>,
<span class="w">        </span><span class="s2">"Software image version: 4.20.1F"</span>,
<span class="w">        </span><span class="s2">"Architecture:           i386"</span>,
<span class="w">        </span><span class="s2">"Internal build version: 4.20.1F-6820520.4201F"</span>,
<span class="w">        </span><span class="s2">"Internal build ID:      790a11e8-5aaf-4be7-a11a-e61795d05b91"</span>,
<span class="w">        </span><span class="s2">""</span>,
<span class="w">        </span><span class="s2">"Uptime:                 1 day, 4 hours and 20 minutes"</span>,
<span class="w">        </span><span class="s2">"Total memory:           2017324 kB"</span>,
<span class="w">        </span><span class="s2">"Free memory:            1111104 kB"</span>
<span class="w">    </span><span class="o">]</span>,
<span class="w">    </span><span class="o">[</span>
<span class="w">        </span><span class="s2">"Interface              IP Address        Status    Protocol      MTU"</span>,
<span class="w">        </span><span class="s2">"Ethernet1              172.16.1.1/24      up         up          1500"</span>,
<span class="w">        </span><span class="s2">"Management1            192.168.2.10/24    up         up          1500"</span>
<span class="w">    </span><span class="o">]</span>,
<span class="w">    </span><span class="o">[</span>
<span class="w">        </span><span class="s2">"Port  Name    Status       Vlan    Duplex  Speed  Type     Flags"</span>,
<span class="w">        </span><span class="s2">"Et1           connected  routed    full    unconf EbraTestPhyPort   "</span>,
<span class="w">        </span><span class="s2">"Et2           connected    1       full    unconf EbraTestPhyPort   "</span>,
<span class="w">        </span><span class="s2">"Et3           connected    1       full    unconf EbraTestPhyPort   "</span>,
<span class="w">        </span><span class="s2">"Ma1           connected  routed   a-full a-1G   10/100/1000"</span>
<span class="w">    </span><span class="o">]</span>
<span class="o">]</span>
</pre></div>

<p>List zero corresponds to the <code>show version</code> command, list one corresponds
to the <code>show ip int br</code> command and list two corresponds to the <code>show int status</code> command.
The list number directly corresponds to the order the command was run in.</p>
<table>
<thead><tr>
<th><strong>Arista EOS Command</strong></th>
<th><strong>Relevant List</strong></th>
</tr></thead>
<tbody>
<tr>
<td><code>show version</code></td>
<td><code>output.stdout_lines[0]</code></td>
</tr>
<tr>
<td><code>show ip int br</code></td>
<td><code>output.stdout_lines[1]</code></td>
</tr>
<tr>
<td><code>show int status</code></td>
<td><code>output.stdout_lines[2]</code></td>
</tr>
</tbody>
</table>
<h3>Scaling Command Module Use: Host Variables</h3>
<p>So what happens if we run on two or more network devices at the same time?</p>
<p><img alt="diagram of Ansible running multiple network devices" src="../images/posts/archive/ansible-multiple-network-devices-run.png"></p>
<p>The variable output is saved uniquely as a <a href="http://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#magic-variables-and-how-to-access-information-about-other-hosts">host
variable</a>
per inventory host.  If I had three switches and ran this playbook
against them, I would have an output variable for each unique host.  For
a demonstration we will grab the IP address from the <code>show ip int br</code>
command above for the Ethernet1 port for just one of the switches,
switch03.  The <code>show ip int br</code> corresponds to the second command we
run, and the ethernet1 interface shows up in the 2nd line so we know we
want <code>stdout_lines[1][1]</code>.  To reference vars about a specific host we
use the keyword <strong>hostvars</strong> and do a dictionary lookup on the host we
want.</p>
<p>This is what the debug task will look like:</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">debug hostvar</span>
<span class="w">  </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">    </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostvars["switch03"].output.stdout_lines[1][1]</span>
</pre></div>

<p>And the output matches what we would expect:</p>
<div class="code"><pre class="code literal-block">TASK<span class="w"> </span><span class="o">[</span>debug<span class="w"> </span>hostvar<span class="o">]</span><span class="w"> </span>***************************************************************
ok:<span class="w"> </span><span class="o">[</span>switch03<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">"hostvars["</span>switch03<span class="s2">"].output.stdout_lines[1][1]"</span>:<span class="w"> </span><span class="s2">"Ethernet1              172.16.1.3/24      up         up              1500"</span>
<span class="o">}</span>
</pre></div>

<p>By default a task will use variables specific to that host, but when
using hostvars you can directly reference other host variables.</p>
<h3>Conditions in Command Module Tasks: wait_for</h3>
<p>The <code>wait_for</code> parameter applies conditional logic directly after a
command is run. This means within the same task you can decide to
purposely fail if output does not match a desired state. By default,
with the above tasks, when there is no <code>wait_for</code> parameter specified
the task is only run one time. However, if the <code>wait_for</code> parameter is
specified the task is run until the condition is met or the maximum
retries (the default is 10 retries) is hit. If I turn on command logging
I can easily see this with a playbook specifically meant to fail for
demonstration purposes:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eos</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">network_cli</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">execute Arista eos command</span>
<span class="w">      </span><span class="nt">eos_command</span><span class="p">:</span>
<span class="w">        </span><span class="nt">commands</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show int status</span>
<span class="w">        </span><span class="nt">wait_for</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">result[0] contains DURHAM</span>
</pre></div>

<p>This playbook will run show int status 10 times, because it will never
find the word DURHAM in the output of show int status.</p>
<p>A <code>show logging</code> command shows me the command was indeed run 10 times:</p>
<div class="code"><pre class="code literal-block">Mar<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">20</span>:33:52<span class="w"> </span>eos<span class="w"> </span>Aaa:<span class="w"> </span>%ACCOUNTING-6-CMD:<span class="w"> </span>admin<span class="w"> </span>vty6<span class="w"> </span><span class="m">192</span>.168.2.1<span class="w"> </span>stop<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span><span class="m">17</span><span class="w"> </span><span class="nv">start_time</span><span class="o">=</span><span class="m">1521923632</span>.5<span class="w"> </span><span class="nv">timezone</span><span class="o">=</span>UTC<span class="w"> </span><span class="nv">service</span><span class="o">=</span>shell<span class="w"> </span>priv-lvl<span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=</span>show<span class="w"> </span>interfaces<span class="w"> </span>status
Mar<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">20</span>:33:53<span class="w"> </span>eos<span class="w"> </span>Aaa:<span class="w"> </span>%ACCOUNTING-6-CMD:<span class="w"> </span>admin<span class="w"> </span>vty6<span class="w"> </span><span class="m">192</span>.168.2.1<span class="w"> </span>stop<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span><span class="m">18</span><span class="w"> </span><span class="nv">start_time</span><span class="o">=</span><span class="m">1521923633</span>.71<span class="w"> </span><span class="nv">timezone</span><span class="o">=</span>UTC<span class="w"> </span><span class="nv">service</span><span class="o">=</span>shell<span class="w"> </span>priv-lvl<span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=</span>show<span class="w"> </span>interfaces<span class="w"> </span>status
Mar<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">20</span>:33:54<span class="w"> </span>eos<span class="w"> </span>Aaa:<span class="w"> </span>%ACCOUNTING-6-CMD:<span class="w"> </span>admin<span class="w"> </span>vty6<span class="w"> </span><span class="m">192</span>.168.2.1<span class="w"> </span>stop<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span><span class="m">19</span><span class="w"> </span><span class="nv">start_time</span><span class="o">=</span><span class="m">1521923634</span>.81<span class="w"> </span><span class="nv">timezone</span><span class="o">=</span>UTC<span class="w"> </span><span class="nv">service</span><span class="o">=</span>shell<span class="w"> </span>priv-lvl<span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=</span>show<span class="w"> </span>interfaces<span class="w"> </span>status
Mar<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">20</span>:33:55<span class="w"> </span>eos<span class="w"> </span>Aaa:<span class="w"> </span>%ACCOUNTING-6-CMD:<span class="w"> </span>admin<span class="w"> </span>vty6<span class="w"> </span><span class="m">192</span>.168.2.1<span class="w"> </span>stop<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span><span class="m">20</span><span class="w"> </span><span class="nv">start_time</span><span class="o">=</span><span class="m">1521923635</span>.92<span class="w"> </span><span class="nv">timezone</span><span class="o">=</span>UTC<span class="w"> </span><span class="nv">service</span><span class="o">=</span>shell<span class="w"> </span>priv-lvl<span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=</span>show<span class="w"> </span>interfaces<span class="w"> </span>status
Mar<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">20</span>:33:56<span class="w"> </span>eos<span class="w"> </span>Aaa:<span class="w"> </span>%ACCOUNTING-6-CMD:<span class="w"> </span>admin<span class="w"> </span>vty6<span class="w"> </span><span class="m">192</span>.168.2.1<span class="w"> </span>stop<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span><span class="m">21</span><span class="w"> </span><span class="nv">start_time</span><span class="o">=</span><span class="m">1521923636</span>.99<span class="w"> </span><span class="nv">timezone</span><span class="o">=</span>UTC<span class="w"> </span><span class="nv">service</span><span class="o">=</span>shell<span class="w"> </span>priv-lvl<span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=</span>show<span class="w"> </span>interfaces<span class="w"> </span>status
Mar<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">20</span>:33:58<span class="w"> </span>eos<span class="w"> </span>Aaa:<span class="w"> </span>%ACCOUNTING-6-CMD:<span class="w"> </span>admin<span class="w"> </span>vty6<span class="w"> </span><span class="m">192</span>.168.2.1<span class="w"> </span>stop<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span><span class="m">22</span><span class="w"> </span><span class="nv">start_time</span><span class="o">=</span><span class="m">1521923638</span>.07<span class="w"> </span><span class="nv">timezone</span><span class="o">=</span>UTC<span class="w"> </span><span class="nv">service</span><span class="o">=</span>shell<span class="w"> </span>priv-lvl<span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=</span>show<span class="w"> </span>interfaces<span class="w"> </span>status
Mar<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">20</span>:33:59<span class="w"> </span>eos<span class="w"> </span>Aaa:<span class="w"> </span>%ACCOUNTING-6-CMD:<span class="w"> </span>admin<span class="w"> </span>vty6<span class="w"> </span><span class="m">192</span>.168.2.1<span class="w"> </span>stop<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span><span class="m">23</span><span class="w"> </span><span class="nv">start_time</span><span class="o">=</span><span class="m">1521923639</span>.22<span class="w"> </span><span class="nv">timezone</span><span class="o">=</span>UTC<span class="w"> </span><span class="nv">service</span><span class="o">=</span>shell<span class="w"> </span>priv-lvl<span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=</span>show<span class="w"> </span>interfaces<span class="w"> </span>status
Mar<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">20</span>:34:00<span class="w"> </span>eos<span class="w"> </span>Aaa:<span class="w"> </span>%ACCOUNTING-6-CMD:<span class="w"> </span>admin<span class="w"> </span>vty6<span class="w"> </span><span class="m">192</span>.168.2.1<span class="w"> </span>stop<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span><span class="m">24</span><span class="w"> </span><span class="nv">start_time</span><span class="o">=</span><span class="m">1521923640</span>.32<span class="w"> </span><span class="nv">timezone</span><span class="o">=</span>UTC<span class="w"> </span><span class="nv">service</span><span class="o">=</span>shell<span class="w"> </span>priv-lvl<span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=</span>show<span class="w"> </span>interfaces<span class="w"> </span>status
Mar<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">20</span>:34:01<span class="w"> </span>eos<span class="w"> </span>Aaa:<span class="w"> </span>%ACCOUNTING-6-CMD:<span class="w"> </span>admin<span class="w"> </span>vty6<span class="w"> </span><span class="m">192</span>.168.2.1<span class="w"> </span>stop<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span><span class="m">25</span><span class="w"> </span><span class="nv">start_time</span><span class="o">=</span><span class="m">1521923641</span>.4<span class="w"> </span><span class="nv">timezone</span><span class="o">=</span>UTC<span class="w"> </span><span class="nv">service</span><span class="o">=</span>shell<span class="w"> </span>priv-lvl<span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=</span>show<span class="w"> </span>interfaces<span class="w"> </span>status
Mar<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">20</span>:34:02<span class="w"> </span>eos<span class="w"> </span>Aaa:<span class="w"> </span>%ACCOUNTING-6-CMD:<span class="w"> </span>admin<span class="w"> </span>vty6<span class="w"> </span><span class="m">192</span>.168.2.1<span class="w"> </span>stop<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span><span class="m">26</span><span class="w"> </span><span class="nv">start_time</span><span class="o">=</span><span class="m">1521923642</span>.47<span class="w"> </span><span class="nv">timezone</span><span class="o">=</span>UTC<span class="w"> </span><span class="nv">service</span><span class="o">=</span>shell<span class="w"> </span>priv-lvl<span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=</span>show<span class="w"> </span>interfaces<span class="w"> </span>status
</pre></div>

<p>Here we can look at a real world example. For this playbook everything
is configured to bring up an OSPF adjacency with another device, except
the <code>ip ospf area</code> command. We will apply the command and then use the
<code>wait_for</code> parameter to make sure the adjacency comes up (indicated by
FULL). If full is not found within 10 retries the task will fail.</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eos</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">network_cli</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn on OSPF for interface Ethernet1</span>
<span class="w">      </span><span class="nt">eos_config</span><span class="p">:</span>
<span class="w">        </span><span class="nt">lines</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip ospf area 0.0.0.0</span>
<span class="w">        </span><span class="nt">parents</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">interface Ethernet1</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">execute Arista eos command</span>
<span class="w">      </span><span class="nt">eos_command</span><span class="p">:</span>
<span class="w">        </span><span class="nt">commands</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show ip ospf neigh</span>
<span class="w">        </span><span class="nt">wait_for</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">result[0] contains FULL</span>
</pre></div>

<p>Execute the playbook with the <code>ansible-playbook</code> command:</p>
<div class="code"><pre class="code literal-block">➜<span class="w">  </span>ansible-playbook<span class="w"> </span>ospf.yml

PLAY<span class="w"> </span><span class="o">[</span>eos<span class="o">]</span><span class="w"> </span>*********************************************************************************************

TASK<span class="w"> </span><span class="o">[</span>turn<span class="w"> </span>on<span class="w"> </span>OSPF<span class="w"> </span><span class="k">for</span><span class="w"> </span>interface<span class="w"> </span>Ethernet1<span class="o">]</span><span class="w"> </span>*******************************************************
changed:<span class="w"> </span><span class="o">[</span>eos<span class="o">]</span>

TASK<span class="w"> </span><span class="o">[</span>execute<span class="w"> </span>Arista<span class="w"> </span>eos<span class="w"> </span>command<span class="o">]</span><span class="w"> </span>****************************************************************
ok:<span class="w"> </span><span class="o">[</span>eos<span class="o">]</span>

PLAY<span class="w"> </span>RECAP<span class="w"> </span>******************************************************************************************
eos<span class="w">                    </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w">    </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w">    </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</pre></div>

<p>Checking on the command line confirms the playbook ran successfully:</p>
<div class="code"><pre class="code literal-block">eos#show<span class="w"> </span>ip<span class="w"> </span>ospf<span class="w"> </span>neigh
Neighbor<span class="w"> </span>ID<span class="w">     </span>VRF<span class="w">      </span>Pri<span class="w"> </span>State<span class="w">             </span>Dead<span class="w"> </span>Time<span class="w">   </span>Address<span class="w">         </span>Interface
<span class="m">2</span>.2.2.2<span class="w">         </span>default<span class="w">  </span><span class="m">1</span><span class="w">   </span>FULL/DR<span class="w">           </span><span class="m">00</span>:00:33<span class="w">    </span><span class="m">172</span>.16.1.2<span class="w">      </span>Ethernet1
</pre></div>

<p>In addition to <code>contains</code> we can use:</p>
<ul>
<li>
<code>eq</code>: Equal</li>
<li>
<code>neq</code>: Not equal</li>
<li>
<code>gt</code>: Greater than</li>
<li>
<code>ge</code>: Greater than or equal</li>
<li>
<code>lt</code>: Less than</li>
<li>
<code>le</code> : Less than or equal</li>
</ul>
<p>There are also three parameters that can be used in conjunction with
wait_for. All of these are documented on the individual module pages:</p>
<table>
<thead><tr>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr></thead>
<tbody>
<tr>
<td>interval</td>
<td>Time between each command retry</td>
</tr>
<tr>
<td>retries</td>
<td>The number of times we retry the task until we fail (or the condition is met)</td>
</tr>
<tr>
<td>match</td>
<td>Match all of your conditionals or just any of them</td>
</tr>
</tbody>
</table>
<p>Let's quickly elaborate on the match parameter:</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">execute Arista eos command</span>
<span class="w">  </span><span class="nt">eos_command</span><span class="p">:</span>
<span class="w">    </span><span class="nt">commands</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show ip ospf neigh</span>
<span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">any</span>
<span class="w">    </span><span class="nt">wait_for</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">result[0] contains FULL</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">result[0] contains 172.16.1.2</span>
</pre></div>

<p>With <code>match: any</code> set, the task will succeed if the result contains
either FULL or 172.16.1.2. With <code>match: all</code> (which is the default),
both must be true before the task can successfully pass. It is far more
likely if you have multiple conditionals that you want them all met
versus just one of them to be true.</p>
<p>Looking for a use-case where you might want to use <code>match: any</code>? Imagine
that you want to confirm internet access to and from a datacenter. For
this particular data center you have five ISPs (Internet Service
Providers), and five discrete BGP connections between your data center
and those ISPs. An Ansible Playbook could check all five BGP connections
and continue on if <strong>any</strong> of them are up and working, rather than all
five. Just remember that <strong>any</strong> implies OR versus <strong>all</strong> which implies
<strong>and</strong>.</p>
<table>
<thead><tr>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr></thead>
<tbody>
<tr>
<td>match: any</td>
<td>Implicit OR, any conditional can be met</td>
</tr>
<tr>
<td>match: all</td>
<td>Implicit AND, all conditionals must be met</td>
</tr>
</tbody>
</table>
<h3>Negative Conditions: Handling Inverse Logic</h3>
<p>Sometimes you are looking for absences or other negative conditions in
command output. It's tempting to use the <code>neq</code> comparison for any
negative scenario, but it's not always the right choice. If you want the
inverse logic of <code>contains</code> (output from this command should not contain
this) consider using the <strong>register</strong> keyword to store the output
followed by a <a href="http://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html#the-when-statement">when
statement</a>
on a subsequent task. If you want to stop the playbook if conditions are
not met, consider simply using the <a href="https://docs.ansible.com/ansible/devel/modules/fail_module.html">fail
module</a>
or <a href="http://docs.ansible.com/ansible/latest/modules/assert_module.html">assert
module</a>
where you can fail on purpose. The <code>neq</code> shown above only makes sense if
you can grab an exact value (if you can get key-value pairs or JSON)
versus getting a string or list of strings. Otherwise you are going to
be doing exact string compares.</p>
<h3>Going Further</h3>
<p>Read the documentation on Working with Command Output in Network Modules
<a href="https://docs.ansible.com/ansible/latest/network/user_guide/network_working_with_command_output.html">here</a>.  </p>
<p>The more specific conditionals like ge, le, etc. can work really well on
JSON output from certain networking platforms as shown in the example in
the documentation.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="ansible-tower-jenkins-in-under-5-minutes/" class="u-url">Connect Ansible Tower and Jenkins in under 5 minutes</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/john-westcott/">John Westcott</a>
              </span>
            </p>
            <p class="dateline">
              <a href="ansible-tower-jenkins-in-under-5-minutes/" rel="bookmark">
                <time class="published dt-published" datetime="2018-05-31T00:00:00Z" itemprop="datePublished" title="2018-05-31 00:00">2018-05-31 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Connect Ansible Tower and Jenkins in under 5 minutes</h2>
<p>We often hear from customers that they are using Jenkins in some
capacity or another. And since I'm a consultant, I'm lucky to hear
first hand what our customers are using and how they need to integrate
Ansible Tower. There has always been a way to integrate the Ansible
Tower and Jenkins using <a href="https://github.com/ansible/tower-cli">tower-cli</a>, but
I thought there could be a neater, closer to native, way of doing it.</p>
<p>So here we go. I've recorded this short screencast to show you just how easy it is:</p>
<blockquote>
<p>The screencast is not currently available.
You can find helpful material in the links below or on the Ansible community forum: https://forum.ansible.com/tag/awx</p>
</blockquote>
<!--
This HTML fragment contains the embedded media from the original blog post.
The video source is unavailable so commenting the HTML.
<p><script src="https://fast.wistia.com/embed/medias/losl1x4e3a.jsonp" async></script>
<script charset="ISO-8859-1" src="//fast.wistia.com/assets/external/E-v1.js" async></script>
</p>
<div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
  <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
    <div class="wistia_embed wistia_async_losl1x4e3a videoFoam=true" style="height:100%;width:100%">
      &nbsp;
    </div>
  </div>
</div>
-->

<p>Below you will find a few links from the video and a link to how to try Ansible Tower.</p>
<p><a href="http://plugins.jenkins.io/ansible-tower">plugins.jenkins.io/ansible-tower</a></p>
<p><a href="http://wiki.jenkins.io/display/jenkins/ansible+tower+plugin">wiki.jenkins.io/display/JENKINS/Ansible+Tower+Plugin</a></p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="windows-package-management/" class="u-url">Windows Package Management</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/jake-jackson/">Jake Jackson</a>
              </span>
            </p>
            <p class="dateline">
              <a href="windows-package-management/" rel="bookmark">
                <time class="published dt-published" datetime="2018-05-14T00:00:00Z" itemprop="datePublished" title="2018-05-14 00:00">2018-05-14 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Windows Package Management</h2>
<p>Welcome to the third installment of our Windows-centric Getting Started Series!</p>
<p>In the previous post we covered
how you can use Ansible and Ansible Tower to help manage your Active
Directory environment. This post will go into how you can configure some
of those machines on your domain. Most of this post is going to be
dominated by specific modules. Ansible has a plethora of Windows modules
that can be <a href="https://docs.ansible.com/ansible/latest/collections/index_module.html#ansible-windows">found here</a>.
As time is not a flat circle, I can't discuss all of them today but only
a few that are widely used.</p>
<h3>MSIs and the win_package Module</h3>
<p>So you got your domain up, you have machines added to it, now let's
install some stuff on those machines. I do have a few notes before
moving forward in regards to the modules we'll be discussing. The module
win_msi is deprecated and will be removed in Ansible 2.8 (current
version as of this post is 2.5). In its place you can use
<a href="http://docs.ansible.com/ansible/latest/modules/win_package_module.html#win-package-module">win_package</a>
which I will be using throughout this post.</p>
<p>Alright, back to installing stuff. The win_package module is the place
to be. It is used specifically for <code>.msi</code> and <code>.exe</code> files that need to
be installed or uninstalled. These files can also be sourced locally,
from a URL or from a network resource.</p>
<p>The parameters within the module add a lot of flexibility. As of Ansible
2.5, you can now list your arguments and the module will escape the
arguments as necessary. However, it is recommended to use a string when
dealing with MSI packages due to the unique escaping issues with
MsiExec.</p>
<p>Below are a few examples of how you can use the win_package module. The
first one shows how to install Visual C++ and list arguments:</p>
<div class="code"><pre class="code literal-block"><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">Visual</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">thingy</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">arguments</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">string</span>
<span class="w">  </span><span class="n">win_package</span><span class="p">:</span>
<span class="w">    </span><span class="n">path</span><span class="p">:</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">microsoft</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="o">/</span><span class="n">B</span><span class="o">/</span><span class="mi">16</span><span class="n">B06F60</span><span class="o">-</span><span class="mi">3</span><span class="n">B20</span><span class="o">-</span><span class="mi">4</span><span class="n">FF2</span><span class="o">-</span><span class="n">B699</span><span class="o">-</span><span class="mf">5E9</span><span class="n">B7962F9AE</span><span class="o">/</span><span class="n">VSU_4</span><span class="o">/</span><span class="n">vcredist_x64</span><span class="o">.</span><span class="n">exe</span>
<span class="w">    </span><span class="n">product_id</span><span class="p">:</span><span class="w"> </span><span class="s1">'{CF2BEA3C-26EA-32F8-AA9B-331F7E34BA97}'</span>
<span class="w">    </span><span class="n">arguments</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">/</span><span class="n">install</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">/</span><span class="n">passive</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">/</span><span class="n">norestart</span>
</pre></div>

<p>Above, we see that the product ID is listed. While Ansible can and does
extract the ID from the MSI when it's local, we don't want to force
the host to download the MSI if it's not necessary. When you supply the
product ID, Ansible can quickly check to see if the package is already
installed without downloading a potentially huge MSI from the internet
first. You can install without the product ID. An example of this can be
found below: </p>
<div class="code"><pre class="code literal-block"><span class="o">-</span><span class="w"> </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="nx">Install</span><span class="w"> </span><span class="nx">Remote</span><span class="w"> </span><span class="nx">Desktop</span><span class="w"> </span><span class="nx">Connection</span><span class="w"> </span><span class="nx">Manager</span><span class="w"> </span><span class="nx">locally</span><span class="w"> </span><span class="nx">omitting</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">product_id</span>
<span class="w">  </span><span class="nx">win_package</span><span class="p">:</span>
<span class="w">    </span><span class="nx">path</span><span class="p">:</span><span class="w"> </span><span class="nx">C</span><span class="p">:</span><span class="err">\</span><span class="nx">temp</span><span class="err">\</span><span class="nx">rdcman</span><span class="p">.</span><span class="nx">msi</span>
<span class="w">    </span><span class="nx">state</span><span class="p">:</span><span class="w"> </span><span class="nx">present</span>
</pre></div>

<p>As I stated earlier, you can also download from a network share and
specify the credentials needed to access that share. The example below
shows it in action, installing 7-zip from a network resource: </p>
<div class="code"><pre class="code literal-block"><span class="o">-</span><span class="w"> </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="nx">Install</span><span class="w"> </span><span class="mi">7</span><span class="nx">zip</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">network</span><span class="w"> </span><span class="nx">share</span><span class="w"> </span><span class="nx">specifying</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">credentials</span>
<span class="w">  </span><span class="nx">win_package</span><span class="p">:</span>
<span class="w">    </span><span class="nx">path</span><span class="p">:</span><span class="w"> </span><span class="err">\\</span><span class="nx">domain</span><span class="err">\</span><span class="nx">programs</span><span class="err">\</span><span class="mi">7</span><span class="nx">z</span><span class="p">.</span><span class="nx">exe</span>
<span class="w">    </span><span class="nx">product_id</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="o">-</span><span class="nx">Zip</span>
<span class="w">    </span><span class="nx">arguments</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="nx">S</span>
<span class="w">    </span><span class="nx">state</span><span class="p">:</span><span class="w"> </span><span class="nx">present</span>
<span class="w">    </span><span class="nx">user_name</span><span class="p">:</span><span class="w"> </span><span class="nx">DOMAIN</span><span class="err">\</span><span class="nx">User</span>
<span class="w">    </span><span class="nx">user_password</span><span class="p">:</span><span class="w"> </span><span class="nx">Password</span>
</pre></div>

<h3>Windows Package Management and Chocolatey</h3>
<p>Unlike most Linux distros, Windows does not have a built-in package
manager. Windows does have the Windows App Store but I don't think that
a whole lot of those products are making their way into data centers.</p>
<p>There is, however, a community project called Chocolatey that provides a
full package management experience for Windows users. It helps take away
some of the pain that comes with managing raw <code>setup.exe</code> and <code>.msi</code>
files. And wouldn't you know, we have a module for it!</p>
<p>But before we get into talking about the module, let's talk a little bit
more about Chocolatey. A good comparison for people who might be Mac
users, Chocolatey is similar to that of Homebrew. Chocolatey is designed
to easily work with all aspects of managing Windows software
(installers, zip archives, runtime binaries, internal and 3rd party
software) using a packaging framework that understands both versioning
and dependency requirements.</p>
<p>The Chocolatey module is similar in use as its *nix counterparts,
simple and powerful. It does have a soft requirement in regards to the
version. And what I mean by soft requirement is that it needs v. 0.10.5
to run but if Chocolatey doesn't see that version, it will update it for
you. And to add some more sugar to that dessert, if Chocolatey is not
present on the machine, the module will install it for you as well
before going through with its assigned tasks.</p>
<p>To get started with the module, one of the easiest examples could be
installing a lightweight CLI tool. Let's use git because people's
workflows are all the same, right?</p>
<div class="code"><pre class="code literal-block"><span class="k">-</span> name: Install git
  win_chocolatey:
    name: git
    state: present
</pre></div>

<p>All joking aside, it is that easy to install git. It is just as easy to
install a different version of something as well if you need to have a
specific version of something. Let's say you need Notepad++, version
6.6. It would look something like this: </p>
<div class="code"><pre class="code literal-block"><span class="k">-</span> name: Install notepadplusplus version 6.6
  win_chocolatey:
    name: notepadplusplus
    version: '6.6'
</pre></div>

<p>One key thing to note when you're stating a version: make sure to enter
it as a string (see the two tick marks around 6.6). Reason being is that
if it is not entered as a string, it's considered a YAML <code>float</code>. Many
valid version numbers don't translate properly into a <code>float</code> and
yield the same result (eg, '6.10' != '6.1' for most versioning
schemes, but 6.10 as a <code>float</code> will become 6.1), so it's a good habit
to always quote version numbers to ensure that they're not
re-formatted.</p>
<p>Some packages might require an interactive user logon to make an
installation. To pass the correct credentials, you can use <code>become</code> to
achieve this. The example below shows an installation of a package that
requires the use of <code>become</code>. Note that you can become: System and it
will not require you to supply a password.</p>
<div class="code"><pre class="code literal-block"><span class="o">-</span><span class="w"> </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="nx">Install</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="kn">package</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">requires</span><span class="w"> </span><span class="err">'</span><span class="nx">become</span><span class="err">'</span>
<span class="w">  </span><span class="nx">win_chocolatey</span><span class="p">:</span>
<span class="w">    </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="nx">officepro2013</span>
<span class="w">  </span><span class="nx">become</span><span class="p">:</span><span class="w"> </span><span class="nx">yes</span>
<span class="w">  </span><span class="nx">become_user</span><span class="p">:</span><span class="w"> </span><span class="nx">Administrator</span>
<span class="w">  </span><span class="nx">become_method</span><span class="p">:</span><span class="w"> </span><span class="nx">runas</span>
</pre></div>

<p>The
<a href="http://docs.ansible.com/ansible/latest/modules/win_chocolatey_module.html#win-chocolatey-module">win_chocolatey</a>
module is strong and powerful but in some scenarios will not work
without become. There is no easy way to find out if a package requires
become so the best course is to try it without and use <code>become</code> if that
fails. </p>
<h3>Packages and Chocolate Bars in Windows Automation</h3>
<p>To wrap up this blog post, we covered a couple of ways you can automate
the installation of packages for your Windows environment. Whether you
are all in on using Chocolatey or need to install some packages, Ansible
has the power to do all of that and more for you, in a simple and
easy-to-read format.</p>
<p>In our next and final post of the Getting Started with Windows
Automation series, we will talk about Security and Updates in Windows
using Ansible!</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="connecting-to-a-windows-host/" class="u-url">Connecting to a Windows Host</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/bianca-henderson/">Bianca Henderson</a>
              </span>
            </p>
            <p class="dateline">
              <a href="connecting-to-a-windows-host/" rel="bookmark">
                <time class="published dt-published" datetime="2018-04-24T00:00:00Z" itemprop="datePublished" title="2018-04-24 00:00">2018-04-24 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Connecting to a Windows Host</h2>
<p>Welcome to the first installment of our Windows-specific Getting Started series!</p>
<p>Would you like to automate some of your Windows hosts with Red Hat
Ansible Tower, but don't know how to set everything up? Are you worried
that Red Hat Ansible Engine won't be able to communicate with your
Windows servers without installing a bunch of extra software? Do you
want to easily automate everyone's best friend, Clippy?</p>
<p><img alt="Ansible-Windows-Clippy" src="../images/posts/archive/Ansible-Windows/Ansible-Windows-Clippy.png"></p>
<p>We can't help with the last thing, but if you said yes to the other two
questions, you've come to the right place. In this post, we'll walk you
through all the steps you need to take in order to set up and connect to
your Windows hosts with Ansible Engine.</p>
<h3>Why Automate Windows Hosts?</h3>
<p>A few of the many things you can do for your Windows hosts with Ansible
Engine include:</p>
<ul>
<li>Starting, stopping and managing services</li>
<li>Pushing and executing custom PowerShell scripts</li>
<li>Managing packages with the Chocolatey package manager</li>
</ul>
<p>In addition to connecting to and automating Windows hosts using local or
domain users, you'll also be able to use <code>runas</code> to execute actions as
the Administrator (the Windows alternative to Linux's <code>sudo</code> or <code>su</code>),
so no privilege escalation ability is lost.</p>
<h3>What's Required?</h3>
<p>Before we start, let's go over the <a href="http://docs.ansible.com/ansible/latest/user_guide/windows_setup.html#host-requirements.">basic
requirements</a>.
First, your control machine (where Ansible Engine will be executing your
chosen Windows modules from) needs to run Linux. Second, Windows support
has been evolving rapidly, so make sure to use the newest possible
version of Ansible Engine to get the latest features!</p>
<p>For the target hosts, you should be running at least Windows 7 SP1 or
later or Windows Server 2008 SP1 or later. You don't want to be running
something from the 90's like Windows NT, because this might happen:</p>
<p><img alt="Ansible-Windows-90s" src="../images/posts/archive/Ansible-Windows-90s.jpg"></p>
<p>Lastly, since Ansible connects to Windows machines and runs PowerShell
scripts by using <a href="https://msdn.microsoft.com/en-us/library/aa384291(v=vs.85).aspx">Windows Remote
Management</a>
(WinRM) (as an alternative to SSH for Linux/Unix machines), a WinRM
listener should be created and activated. The good news is, connecting
to your Windows hosts can be done very easily and quickly using a
script, which we'll discuss in the section below.</p>
<h3>Step 1: Setting up WinRM</h3>
<p>What's WinRM? It's a feature of Windows Vista and higher that lets
administrators run management scripts remotely; it handles those
connections by implementing the WS-Management Protocol, based on <a href="https://msdn.microsoft.com/en-us/library/ms995800.aspx">Simple
Object Access
Protocol</a>
(commonly referred to as <a href="https://en.wikipedia.org/wiki/SOAP">SOAP</a>).
With WinRM, you can do cool stuff like access, edit and update data from
local and remote computers as a network administrator.</p>
<p>The reason WinRM is perfect for using with Ansible Engine is because you
can obtain hardware data from WS-Management protocol implementations
running on non-Windows operating systems (in this specific case, Linux).
It's basically like a translator that allows different types of
operating systems to work together.</p>
<p>So, how do we connect?</p>
<p>With most versions of Windows, WinRM ships in the box but isn't turned
on by default. There's a <a href="https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1">Configure Remoting for
Ansible</a>
script you can run on the remote Windows machine (in a PowerShell
console as an Admin) to turn on WinRM. To set up an https listener,
build a self-signed cert and execute PowerShell commands, just run the
script like in the example below (if you've got the <code>.ps1</code> file stored
locally on your machine):</p>
<p><img alt="Ansible-Windows-Powershell" src="../images/posts/archive/Ansible-Windows-Powershell.png"></p>
<p>Note: The
<a href="http://docs.ansible.com/ansible/latest/modules/win_psexec_module.html">win_psexec</a>
module will help you enable WinRM on multiple machines if you have lots
of Windows hosts to set up in your environment.</p>
<p>For more information on WinRM and Ansible, check out the <a href="http://docs.ansible.com/ansible/latest/user_guide/windows_winrm.html">Windows Remote
Management</a>
documentation page.</p>
<h3>Step 2: Install Pywinrm</h3>
<p>Since pywinrm dependencies aren't shipped with Ansible Engine (and these
are necessary for using WinRM), make sure you install the
pywinrm-related library on the machine that Ansible is installed on. The
simplest method is to run <code>pip install pywinrm</code> in your Terminal.</p>
<h3>Step 3: Set Up Your Inventory File Correctly</h3>
<p>In order to connect to your Windows hosts properly, you need to make
sure that you put in <code>ansible_connection=winrm</code> in the <a href="http://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#host-variables">host
vars</a>
section of your inventory file so that Ansible Engine doesn't just keep
trying to connect to your Windows host via SSH.</p>
<p>Also, the WinRM connection plugin defaults to communicating via https,
but it supports different modes like message-encrypted http. Since the
"Configure Remoting for Ansible" script we ran earlier set things up
with the self-signed cert, we need to tell Python, "Don't try to
validate this certificate because it's not going to be from a valid CA."
So in order to prevent an error, one more thing you need to put into the
<code>host vars</code> section is: <code>ansible_winrm_server_cert_validation=ignore</code></p>
<p>Just so you can see it in one place, here is an example host file
(please note, some details for your particular environment will be
different):</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">[</span><span class="nv">win</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">172.16.2.5</span>
<span class="l l-Scalar l-Scalar-Plain">172.16.2.6</span>

<span class="l l-Scalar l-Scalar-Plain">[win:vars]</span>
<span class="l l-Scalar l-Scalar-Plain">ansible_user=vagrant</span>
<span class="l l-Scalar l-Scalar-Plain">ansible_password=password</span>
<span class="l l-Scalar l-Scalar-Plain">ansible_connection=winrm</span>
<span class="l l-Scalar l-Scalar-Plain">ansible_winrm_server_cert_validation=ignore</span>
</pre></div>

<h3>Step 4: Test Connection</h3>
<p>Let's check to see if everything is working. To do this, go to your
control node's terminal and type
<code>ansible [host_group_name_in_inventory_file] -i hosts -m win_ping</code>. Your
output should look like this:</p>
<p><img alt="Ansible-Windows-Screen-Grab" src="../images/posts/archive/Ansible-Windows-Screen-Grab.jpg"></p>
<p>Note: The <code>win_</code> prefix on all of the Windows modules indicates that
they are implemented in PowerShell and not Python.</p>
<h3>Troubleshooting WinRM</h3>
<p>Because WinRM can be configured in so many different ways, errors that
seem Ansible Engine-related can actually be due to problems with host
setup instead. Some examples of WinRM errors that you might see include
an HTTP 401 or HTTP 500 error, timeout issues or a connection refusal.
To get tips on how to solve these problems, visit the <a href="http://docs.ansible.com/ansible/devel/user_guide/windows_setup.html#common-winrm-issues">Common WinRM
Issues</a>
section of our Windows Setup documentation page.</p>
<h3>Conclusion</h3>
<p>You should now be ready to automate your Windows hosts using Ansible,
without the need to install a ton of additional software! Keep in mind,
however, that even if you've followed the instructions above, some
Windows modules have additional specifications (e.g., a newer OS or more
recent PowerShell version). The best way to figure out if you're meeting
the right requirements is to check the
<a href="https://docs.ansible.com/ansible/latest/collections/index_module.html#ansible-windows">module-specific</a>
documentation pages.</p>
<p>For more in-depth information on how to use Ansible Engine to automate
your Windows hosts, check out our <a href="http://docs.ansible.com/ansible/latest/user_guide/windows_faq.html">Windows
FAQ</a>
and <a href="http://docs.ansible.com/ansible/latest/user_guide/windows.html">Windows
Support</a>
documentation page and stay tuned for more Windows-related blog posts!</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="using-ansible-to-mitigate-network-vulnerabilities/" class="u-url">Using Ansible to Mitigate Network Vulnerabilities</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/sean-cavanaugh/">Sean Cavanaugh</a>
              </span>
            </p>
            <p class="dateline">
              <a href="using-ansible-to-mitigate-network-vulnerabilities/" rel="bookmark">
                <time class="published dt-published" datetime="2018-04-16T00:00:00Z" itemprop="datePublished" title="2018-04-16 00:00">2018-04-16 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Using Ansible to Mitigate Network Vulnerabilities</h2>
<h3>Even Networks Aren't Immune</h3>
<p>Just like with Windows and Linux servers, networking devices can be
exploited by vulnerabilities found in their operating systems. Many IT
organizations do not have a comprehensive strategy for mitigating
security vulnerabilities that span multiple teams (networking, servers,
storage, etc.). Since the majority of network operations is still
manual, the need to mitigate quickly and reliably across multiple
platforms consisting of hundreds of network devices becomes extremely
important.</p>
<p>In Cisco's <em>March 2018 Semiannual Cisco IOS and IOS XE Software Security
Advisory Bundled Publication</em>, 22 vulnerabilities were detailed. While
Red Hat does not report or keep track of individual networking vendors
CVEs, <a href="../products/engine">Red Hat Ansible Engine</a> can be used to quickly
automate mitigation of CVEs based on instructions from networking
vendors.</p>
<p>In this blog post we are going to walk through
<a href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-20180328-smi2">CVE-2018-0171</a>
which is titled "Cisco IOS and IOS XE Software Smart Install Remote Code
Execution Vulnerability." This CVE is labeled as critical by Cisco, with
the following headline summary:</p>
<blockquote>
<p><em>"...a vulnerability in the Smart Install feature of Cisco IOS
Software and Cisco IOS XE Software could allow an unauthenticated,
remote attacker to trigger a reload of an affected device, resulting
in a denial of service (DoS) condition, or to execute arbitrary code
on an affected device."</em></p>
</blockquote>
<h3>Gathering Information from Networks</h3>
<p>Users leverage Ansible modules to access devices, retrieve information,
execute commands and handle systems using specific keywords. One of the
first things a CVE requires is collection of inventory. To mitigate a
CVE, the networking platform and specific version of code is required.
CVE-2018-0171 affects the IOS and IOS-XE network operating systems and
Ansible can obtain this information easily. Let's use the <a href="http://docs.ansible.com/ansible/latest/modules/ios_facts_module.html">ios_facts
module</a>
which returns key-value pairs for use in subsequent tasks. For example:
<code>ansible_net_model</code> returns the model, and <code>ansible_net_image</code> returns
the image file the device is running. For a full list see the ios_facts
module
<a href="http://docs.ansible.com/ansible/latest/modules/ios_facts_module.html">documentation</a>
page.</p>
<div class="code"><pre class="code literal-block"><span class="x">- name: gather facts for ios platforms</span>
<span class="x">  ios_facts:</span>
<span class="x">    gather_subset: all</span>

<span class="x">- name: output facts to terminal window</span>
<span class="x">  debug:</span>
<span class="x">    msg: &gt;</span>
<span class="x">      Device </span><span class="cp">{{</span><span class="nv">ansible_net_hostname</span><span class="cp">}}</span><span class="x">, model</span>
<span class="cp">{{</span><span class="nv">ansible_net_model</span><span class="cp">}}</span><span class="x">, running </span><span class="cp">{{</span><span class="nv">ansible_net_version</span><span class="cp">}}</span>
</pre></div>

<p>When executing the playbook we get nice output like this:</p>
<div class="code"><pre class="code literal-block"><span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">rtr1</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="ss">"msg"</span><span class="err">:</span><span class="w"> </span><span class="ss">"Device rtr1, model CSR1000V, running 16.05.02\n"</span>
<span class="err">}</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">rtr2</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="ss">"msg"</span><span class="err">:</span><span class="w"> </span><span class="ss">"Device rtr2, model CSR1000V, running 16.05.02\n"</span>
<span class="err">}</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">switch</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="ss">"msg"</span><span class="err">:</span><span class="w"> </span><span class="ss">"Device c3850-1, model WS-C3850-24T, running 16.06.01\n"</span>
<span class="err">}</span>
</pre></div>

<p>This allows us to quickly grab useful information about our network, and
check it against Cisco Security Advisory. In a demo on the <a href="https://github.com/network-automation/ansible_inventory_report">GitHub
network-automation
project</a>
we show how to use network facts to quickly build a nice HTML report.</p>
<p>The vulnerability CVE-2018-0171 specifies that to see if a device is
vulnerable we must run the <code>show vstack config</code> command. In my network,
I have three devices running IOS-XE, two are CSR1000V devices, and one
device is a 3850. The two CSR devices don't have the command, while the
3850 switch does. To make my playbook robust enough to handle errors
when a command doesn't exist, I can use the <code>ignore_errors</code> parameter.
Otherwise, the playbook would fail and exit when a target network node
doesn't have the ability to use that command. Alternatively, I could run
the playbook only on switches by <a href="http://docs.ansible.com/ansible/devel/user_guide/playbooks_best_practices.html#top-level-playbooks-are-separated-by-role">using a
limit</a>.
For this example, let's assume we are running the Cisco 3850 which has
the <code>show vstack config</code> command.</p>
<div class="code"><pre class="code literal-block"><span class="o">-</span><span class="w"> </span><span class="nl">name:</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">vstack</span><span class="w"> </span><span class="n">config</span>
<span class="w">    </span><span class="nl">ios_command:</span>
<span class="w">      </span><span class="nl">commands:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">vstack</span><span class="w"> </span><span class="n">config</span>
<span class="w">    </span><span class="nl">register:</span><span class="w"> </span><span class="n">showvstack</span>
</pre></div>

<p>In the playbook above I used the <code>register: showvstack</code>. The
<code>showvstack</code> is a user defined term (I chose it, it is not reserved). By
registering this I can use the output from the <code>show vstack config</code>
later in the playbook. We can use the debug module to look at the
<code>showvstack</code> variable to see how it's formatted:</p>
<div class="code"><pre class="code literal-block"><span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">switch</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="ss">"showvstack"</span><span class="err">:</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="ss">"changed"</span><span class="err">:</span><span class="w"> </span><span class="k">false</span><span class="p">,</span>
<span class="w">        </span><span class="ss">"failed"</span><span class="err">:</span><span class="w"> </span><span class="k">false</span><span class="p">,</span>
<span class="w">        </span><span class="ss">"stdout"</span><span class="err">:</span><span class="w"> </span><span class="o">[</span>
<span class="n">            "Capability: Director | Client\n Oper Mode: Disabled\n Role: NA\n Vstack Director IP address: 0.0.0.0\n\n *** Following configurations will be effective only on director ***\n Vstack default management vlan: 1\n Vstack start-up management vlan: 1\n Vstack management Vlans: none\n Join Window Details:\n\t Window: Open (default)\n\t Operation Mode: auto (default)\n Vstack Backup Details:\n\t Mode: On (default)\n\t Repository:"</span>
<span class="n">        </span><span class="o">]</span><span class="p">,</span>

<span class="o">&lt;&lt;</span><span class="n">rest</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="n">removed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">brevity</span><span class="o">&gt;&gt;</span>
</pre></div>

<p>There is a stdout and a stdout_lines. To read more on the common return
values refer to the
<a href="http://docs.ansible.com/ansible/latest/reference_appendices/common_return_values.html#stdout">documentation</a>.
Next, we will use my new favorite module, the <a href="http://docs.ansible.com/ansible/latest/modules/assert_module.html">assert
module</a>.
This enables us to check if given expressions are true, failing the task
if they are not. Cisco provides two outputs that we need to check for in
the result of the <code>show vstack config</code> command:</p>
<div class="code"><pre class="code literal-block">switch1#<span class="w"> </span>show<span class="w"> </span>vstack<span class="w"> </span>config
Role:<span class="w"> </span>Client<span class="w"> </span><span class="o">(</span>SmartInstall<span class="w"> </span>enabled<span class="o">)</span>
</pre></div>

<p>or</p>
<div class="code"><pre class="code literal-block">switch2#<span class="w"> </span>show<span class="w"> </span>vstack<span class="w"> </span>config
Capability:<span class="w"> </span>Client
Oper<span class="w"> </span>Mode:<span class="w"> </span>Enabled
Role:<span class="w"> </span>Client
</pre></div>

<p>We can use the assert module to check the text we saved in the <code>showvstack</code> variable:</p>
<div class="code"><pre class="code literal-block">- name: Check to make sure Cisco's Smart Install Client Feature is not enabled (1/2)
  assert:
    that:
      - "'SmartInstall enabled' not in showvstack.stdout"
      - "'Role' not in showvstack.stdout"
      - "'Client' not in showvstack.stdout"
</pre></div>

<p>Each line in the assert module that is added means there is an implicit
AND, meaning all three need to be true for the task to pass.</p>
<p>Similarly we can check the second statement:</p>
<div class="code"><pre class="code literal-block">- name: Check to make sure Cisco's Smart Install Client Feature is not enabled (1/1)
  assert:
    that:
      - "'Oper Mode' not in showvstack.stdout"
      - "'Enabled' not in showvstack.stdout"
      - "'Role' not in showvstack.stdout"
      - "'Client' not in showvstack.stdout"
</pre></div>

<p>For this particular CVE it lists that there are no workarounds
available. On some CVEs we could use the ios_command or ios_config
modules to mitigate the CVE based on the instructions the vendor
provided. For this particular CVE it links to the documentation on how
to disable vstack using the command no vstack which could be sent using
the ios_command module. It also recommends for older releases to block
traffic on TCP port 4786, which could be pushed using the ios_config
module. Since no workaround is provided on the CVE, a network operator
needs to make an educated decision based on their environment.
Alternatively, for <a href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-20180328-xesc#workarounds">CVE-2018-0150</a>
there is a workaround provided, and the ios_config could simply send
<code>no username cisco</code> to mitigate the CVE.</p>
<p>Red Hat Ansible Engine and Red Hat Ansible Tower can be used to help
network operators and administrators scale repetitive tasks like
checking these dozens of CVEs and make sure their network is safe from
vulnerabilities. On the server side, when system administrators are
using <a href="https://www.redhat.com/en/technologies/management/insights">Red Hat Insights</a>,
they can automatically <a href="https://access.redhat.com/documentation/en-us/red_hat_insights/1.0/html/creating_insights_maintenance_plans_with_ansible_playbook_integration/running_a_playbook#running_ansible_playbook">generate playbooks</a>
for Red Hat Enterprise Linux to help with vulnerabilities and
proactively identify threats to security, performance, and stability.
Ansible can be the common way to execute tasks across your entire IT
infrastructure.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="enable-self-healing-applications-with-ansible-and-dynatrace/" class="u-url">Enable self-healing applications with Ansible and Dynatrace</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/jurgen-etzlstorfer/">Jürgen Etzlstorfer</a>
              </span>
            </p>
            <p class="dateline">
              <a href="enable-self-healing-applications-with-ansible-and-dynatrace/" rel="bookmark">
                <time class="published dt-published" datetime="2018-04-13T00:00:00Z" itemprop="datePublished" title="2018-04-13 00:00">2018-04-13 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Enable self-healing applications with Ansible and Dynatrace</h2>
<p>The size, complexity and high rate of change in today's IT environments
can be overwhelming. Enabling the performance and availability of these
modern microservice environments is a constant challenge for IT
organizations.</p>
<p>One trend contributing to this rate of change is the adoption of IT
automation for provisioning, configuration management and ongoing
operations. For this blog, we want to highlight the repeatable and
consistent outcomes allowed by IT automation, and explore what is
possible when Ansible automation is extended to the application
monitoring platform Dynatrace.</p>
<h3>Monitoring Today</h3>
<p>Considering the size, complexity and high rate of change in today\'s IT
environments, traditional methods of monitoring application performance
and availability are often necessary and commonplace in most operations
teams. Application performance monitoring (APM) platforms are used to
detect bottlenecks and problems that can impact the experience of your
customers.</p>
<p>Monitoring alone, however, isn't always enough to help keep your
applications running at peak performance. When issues are detected, APM
platforms are designed to alert the operator of the problem and its
root-cause. The Ops team can then agree on a corrective action, and
implement this action against the impacted systems.</p>
<p>What if common or time-consuming corrective actions could be automated?</p>
<h3>Dynatrace Automates Remediation</h3>
<p>The Dynatrace APM platform provides AI-powered, full stack performance
monitoring of your microservice environments and its underlying
infrastructure. Dynatrace enables insights into your IT operation and
detects if areas of your environment do not meet performance or error
rate thresholds by an automated baselining.</p>
<p>Once Dynatrace detects abnormal system behavior that affects real users,
a problem alert is created that groups all incidents that share the same
root-cause.</p>
<p>Demo application triggers a Problem alert. Dynatrace detected a
degradation in response time, impacting 54 real users and more than 300
service calls:</p>
<p><img alt="Dynatrace Problem Alert" src="../images/posts/archive/Ansible-Dynatrace-2.png"></p>
<p>As soon as Dynatrace detects a problem within an environment, a problem
notification can be sent out to third party systems to notify them about
the incidents. Dynatrace allows users to integrate with Ansible Tower as
a Notification System, allowing operators to launch Ansible Tower job
templates from Dynatrace Problem Notifications.</p>
<p>Ansible Tower is now available as a featured third-party integration
within the Dynatrace Notification System:</p>
<p><img alt="Ansible Tower integration with Dynatrace" src="../images/posts/archive/Ansible-Dynatrace-4.png"></p>
<p>The integration also allows transferring contextual information for the
detected problem. This means Ansible job templates can leverage these
extra variables for a context-aware, finer grained remediation in terms
of executing a predefined playbook. </p>
<p>Specify the Ansible Tower job template URL, credentials and an optional
custom message. The Notification can be saved and will be triggered as
soon as Dynatrace detects a problem in your
environment:</p>
<p><img alt="Ansible Tower job template" src="../images/posts/archive/Ansible-Dynatrace-3.png"></p>
<p>Execution of a job template triggered by the Dynatrace problem
notification sent to\
Ansible Tower:</p>
<p><img alt="Dynatrace executes Ansible Tower job" src="../images/posts/archive/Ansible-Dynatrace-1.png"></p>
<p>Note that extra variables are passed with the job template, designed to eliminate the need for the operator to provide this contextual information.</p>
<h3>Self-Healing Applications in Action</h3>
<p>Once your Ansible job templates are in place and customized for
facilitating remediation tasks and the integration within Dynatrace is
set up, the workflow for your self-healing applications looks as
follows:</p>
<ul>
<li>Dynatrace monitors your environment and detects problems once they
    affect real users</li>
<li>Dynatrace sends a problem notification to Ansible Tower</li>
<li>Ansible Tower launches the specified job template to start the
    remediation</li>
<li>Once the problem is resolved, Dynatrace closes the problem</li>
</ul>
<p>As you can see, the Dynatrace - Ansible Tower integration is designed to
simplify the setup of IT management automation tasks. Furthermore, the
integration of Ansible Tower into the Dynatrace Problem Notifications
workflow enables self-healing applications by triggering pre-defined,
automatable Ansible job templates that are executed by Ansible Tower
each time a problem is detected.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="getting-started-ansible-towers-api/" class="u-url">Getting Started with Ansible Tower's API</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/jake-jackson/">Jake Jackson</a>
              </span>
            </p>
            <p class="dateline">
              <a href="getting-started-ansible-towers-api/" rel="bookmark">
                <time class="published dt-published" datetime="2018-04-03T00:00:00Z" itemprop="datePublished" title="2018-04-03 00:00">2018-04-03 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Getting Started with Ansible Tower's API</h2>
<p>Welcome to another entry in the Getting Started series.
The API (Application Programming
Interface) or, as I like to refer to it, the Magical Land of Automation
Information, can be used in quite a few ways. In this Getting Started
post, we will be discussing Red Hat Ansible Tower's API and how you can
use it to extract information to utilize in your playbooks and other
tools.</p>
<p>The idea for this blog post came about when David
Federlein was developing a new Ansible
Tower demo and presentation. I will be making references to <a href="https://github.com/dfederlein/ansible-tower-demo">that
codebase</a>, which you
can follow along with throughout this post. Please note that this demo
utilizes Vagrant and VirtualBox so you'll need to have those
applications installed if you would like to stand up the demo yourself.</p>
<h3>Ansible Tower's API</h3>
<p>Ansible Tower's API is fully browsable. You can navigate to your
instance's REST API by typing this into your
browser: <code>http://&lt;Tower server name&gt;/api/v2</code>. Once there, you can click
any of the listed links and view the current objects loaded for that
particular attribute in Ansible Tower. Everything you can do in Ansible
Tower's UI can be done from the API; you can also use it to view
everything from credentials to users. As we'll review in the next
section, you can manually post to the API or make calls through a
playbook.</p>
<h3>Posting to the API</h3>
<p>There are many different ways that you can make calls to the API, but
today we are going to focus on two of the most basic:</p>
<ol>
<li>Manually from the REST API interface of Ansible Tower</li>
<li>From a playbook</li>
</ol>
<p>What I mean by "basic" here is that these methods are done only through
Ansible Tower. As most of you might know, you can do some pretty amazing
stuff with the information from Ansible Tower with other applications.</p>
<p>We'll not only be able to configure and modify Ansible Tower via these
methods, but we'll also demonstrate that you can kick off jobs via API
call as well. This will allow tighter integration with other aspects of
your enterprise infrastructure and give the ability to run Red Hat
Ansible Engine workloads while still restrained by
the role-based access controls configured around those resources and Job
Templates.</p>
<h4>Posting Manually</h4>
<p>For starters, the easiest (albeit not the quickest or most automated)
way to post to the API is from the API interface. Here you can select an
object to post to. Each object has a template at the bottom of the page
that displays the fields that can be contained in a post.</p>
<p>For example, let's say you want to add a project to your Ansible Tower
instance via the API. All you would have to do is navigate to your
Ansible Tower's API screen <code>(https://&lt;towerip&gt;/api/v2)</code>
select the project URL <code>(/api/v2/projects/)</code> and then scroll down to the
bottom. Displayed there will be the content, which will look like this:</p>
<div class="code"><pre class="code literal-block"><span class="p">{</span>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"local_path"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"scm_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"scm_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"scm_branch"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"scm_clean"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"scm_delete_on_update"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"credential"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"timeout"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"organization"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"scm_update_on_launch"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"scm_update_cache_timeout"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</pre></div>

<p>Once you have that content, fill in the quotes with the relative
information from your environment. After you paste it into your field,
hit POST. If that posted successfully, you can view the project in the
Ansible Tower UI and also through the API.</p>
<p>If it failed, you will receive a notification of a bad request. The
method for fixing the error will show up in quotes below it. For
example, if you are creating a user and fail to enter a password for
that user, it will fail and return the following error:</p>
<div class="code"><pre class="code literal-block"><span class="p">{</span>
<span class="w">    </span><span class="nt">"password"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">"This field may not be blank."</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>

<p>If you run into any issues with making a post to the API (like the above
error), the OPTIONS button found at the top right of the UI next to GET
can be of great help. The OPTIONS button describes the acceptable values
for POST, PUT and PATCH for the specific object or endpoint you are
wishing to post to.</p>
<p>Once the error you have found is fixed in the content field, hit
"Post" one more time and note that the object has now been added to
Ansible Tower successfully.</p>
<h4>Posting Via a Playbook</h4>
<p>Another way to post to Ansible Tower's API is through a playbook. The
GitHub repo that I linked earlier in the post does this throughout the
post installation plays. Almost everything done after the installation
is done through the API.</p>
<p>To see it in action, let's sync that project that you just added into
your instance. This will require some prior knowledge on the
construction of Ansible Playbooks. If you need help or want to brush up
on your playbook knowledge, you can visit our
<a href="http://docs.ansible.com/ansible/latest/playbooks.html">documentation</a>.</p>
<p>The play that kicks off the job sync utilizes the
<a href="http://docs.ansible.com/ansible/latest/modules/uri_module.html">URI module</a>
within Ansible. This module is used to interact with web services, such
as the Ansible Tower API. This exact play can be found in the codebase
that I linked above at <code>/roles/tower/main.yml</code>.</p>
<div class="code"><pre class="code literal-block"><span class="x">- name: kick off project sync</span>
<span class="x">  uri:</span>
<span class="x">    url:  https://localhost/api/v1/projects/7/update/</span>
<span class="x">    method: POST</span>
<span class="x">    user: admin</span>
<span class="x">    password: "</span><span class="cp">{{</span> <span class="nv">towerpass</span> <span class="cp">}}</span><span class="x">"</span>
<span class="x">    validate_certs: False</span>
<span class="x">    status_code:</span>
<span class="x">      - 200</span>
<span class="x">      - 201</span>
<span class="x">      - 202</span>
<span class="x">  when: response.status == 201</span>
</pre></div>

<p>In this playbook task, we are telling Ansible to navigate to the API URL
for your project. In this instance, it's
<code>https://localhost/api/v2/projects/7/update/</code>. Notice that the project
has a number before update. Projects are assigned a number in Ansible
Tower based on the timing of their entry into Ansible Tower. This number
can only be found by navigating to the API interface for projects
<code>https://&lt;your_ip_here&gt;/api/v2/projects/</code>. Once there, you will need to
find the project you wish to sync and then make a post to the update
endpoint of that project number. The example does the update on project
number 7.</p>
<p>Once you have found the correct project you want to update, you will
need to make a post to the update endpoint. In this example, since we
are updating project 7, the endpoint is
<code>https://localhost/api/v1/projects/7/update/</code>.</p>
<p>For this post to work successfully with the URI module, you will need to
also pass the API your user credentials that you log into Tower with. In
this example, we are using the default admin user. You can use whichever
user that has sufficient access to make such a post.</p>
<h4>Kicking Off a Job</h4>
<p>Now, the header might seem a little ambiguous. "Jake, kicking off a job
isn't that hard in Ansible Tower." This is correct, but for this
example, we are going to kick off a job in Ansible Tower from a playbook
task, which is yet another thing you can do by making a call to the API.
The specific example I am going to reference can be found in the
vagrant-common role (<code>/roles/vagrant-common/main.yml</code>).</p>
<p>Now once you get your spectacles out, the task that I am narrowing is
found in the example below:</p>
<div class="code"><pre class="code literal-block"><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">kick</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">provisioning</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="n">template</span>
<span class="w">  </span><span class="n">shell</span><span class="o">:</span><span class="w">  </span><span class="s2">"curl -f -H 'Content-Type: application/json' -XPOST --user</span>
<span class="s2">admin:{{ towerpass }}</span>
<span class="s2">https://172.16.2.42/api/v2/job_templates/8/launch/ --insecure"</span>
<span class="w">  </span><span class="n">when</span><span class="o">:</span><span class="w"> </span><span class="n">inventory_hostname</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'demovm4'</span>
</pre></div>

<p>At first glance, you are seeing the shell module in use, running a curl
command to a specific https endpoint. It just so happens that this https
endpoint is the API endpoint for launching a specific job template.</p>
<p>That specific job template is assigned a number in Ansible Tower. In
order to not have to go digging through the API to find your specific
job template endpoint, a quick and easy way to find it is to navigate to
the job template that you want to launch via the API. Once there, look
at the URL and the number it's assigned to will be there.</p>
<p>Once you find the correct job template, the https endpoint will look
something like <code>api/v2/job_templates/8/launch/</code>. Hit that endpoint with
a <code>-XPOST</code> in a curl command and you should be cooking with gas.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="infoblox-integration-in-ansible-2.5/" class="u-url">Infoblox Integration in Ansible 2.5</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/sean-cavanaugh/">Sean Cavanaugh</a>
              </span>
            </p>
            <p class="dateline">
              <a href="infoblox-integration-in-ansible-2.5/" rel="bookmark">
                <time class="published dt-published" datetime="2018-03-26T00:00:00Z" itemprop="datePublished" title="2018-03-26 00:00">2018-03-26 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Infoblox Integration in Ansible 2.5</h2>
<p>The Ansible 2.5 open source project release includes the following
Infoblox Network Identity Operating System (NIOS) enablement:</p>
<ul>
<li>Five modules</li>
<li>A lookup plugin (for querying Infoblox NIOS objects)</li>
<li>A dynamic inventory script</li>
</ul>
<p>For network professionals, this means that existing networking Ansible
Playbooks can utilize existing Infoblox infrastructure for IP Address
Management (IPAM), using Infoblox for tracking inventory and more. For
more information on Infoblox terminology, documentation and examples,
refer to the <a href="https://www.infoblox.com/">Infoblox website</a></p>
<p>Let's elaborate on each of these Ansible 2.5 additions. All of the
following examples (and many more) are provided in the network
automation community project, under the <code>infoblox_ansible</code>
<a href="https://github.com/network-automation/infoblox_ansible">GitHub repository</a>. The
integrations for Ansible require that the control node (where Ansible is
being executed from) have the infoblox-client installed. It can be
<a href="https://pypi.python.org/pypi/infoblox-client">found here</a> and installed
with pip issuing the <code>pip install infoblox-client</code> command.</p>
<h3>Ansible Infoblox Modules</h3>
<p>There are <a href="http://docs.ansible.com/ansible/latest/modules/list_of_net_tools_modules.html#nios">five new
modules</a>
included with Ansible 2.5. They can be currently found in the
development branch of the documentation:</p>
<ul>
<li>
<a href="http://docs.ansible.com/ansible/latest/modules/nios_host_record_module.html">nios_host_record</a> -
    configure host records</li>
<li>
<a href="http://docs.ansible.com/ansible/latest/modules/nios_network_module.html">nios_network</a> -
    configure networking objects</li>
<li>
<a href="http://docs.ansible.com/ansible/latest/modules/nios_network_view_module.html">nios_network_view</a> -
    configure networking views</li>
<li>
<a href="http://docs.ansible.com/ansible/latest/modules/nios_dns_view_module.html">nios_dns_view</a> -
    configure DNS views</li>
<li>
<a href="http://docs.ansible.com/ansible/latest/modules/nios_zone_module.html">nios_zone</a> -
    configure DNS zones</li>
</ul>
<p>Here is an example playbook on configuring a IPv4 network using the
nios_network module:</p>
<div class="code"><pre class="code literal-block"><span class="x">---</span>
<span class="x">- hosts: localhost</span>
<span class="x">  connection: local</span>
<span class="x">  tasks:</span>
<span class="x">    - name: set dhcp options for a network</span>
<span class="x">      nios_network:</span>
<span class="x">        network: 192.168.100.0/24</span>
<span class="x">        comment: sean put a comment here</span>
<span class="x">        options:</span>
<span class="x">          - name: domain-name</span>
<span class="x">            value: ansible.com</span>
<span class="x">        state: present</span>
<span class="x">        provider: "</span><span class="cp">{{</span><span class="nv">nios_provider</span><span class="cp">}}</span><span class="x">"</span>
</pre></div>

<p>Since this playbook did not specify the
<code>network_view</code> parameter it will default to the default view. To run the playbook use the
<code>ansible-playbook</code> command:</p>
<div class="code"><pre class="code literal-block"><span class="n">SEANs</span><span class="o">-</span><span class="n">MacBook</span><span class="o">-</span><span class="nl">Pro</span><span class="p">:</span><span class="n">infoblox_ansible</span><span class="w"> </span><span class="n">sean</span><span class="err">$</span><span class="w"> </span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="w">  </span><span class="n">configure_network</span><span class="p">.</span><span class="n">yml</span>

<span class="n">PLAY</span><span class="w"> </span><span class="o">[</span><span class="n">localhost</span><span class="o">]</span><span class="w"> </span><span class="o">***************************************************************************************</span>

<span class="n">TASK</span><span class="w"> </span><span class="o">[</span><span class="n">set dhcp options for a network</span><span class="o">]</span><span class="w"> </span><span class="o">***************************************************************</span>
<span class="nl">changed</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">localhost</span><span class="o">]</span>

<span class="n">PLAY</span><span class="w"> </span><span class="n">RECAP</span><span class="w"> </span><span class="o">******************************************************************************************</span>
<span class="n">localhost</span><span class="w">                  </span><span class="err">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">1</span><span class="w">    </span><span class="n">changed</span><span class="o">=</span><span class="mi">1</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span>
</pre></div>

<p>We can login to the web https GUI website and look under <strong>Data Management -&gt; IPAM</strong> where we will see the new network listed:</p>
<p><img alt="Ansible-Infoblox-Image-1" src="../images/posts/archive/Ansible-Infoblox-Image-1.png"></p>
<p>The modules can keep state (where applicable) so when we re-run the
playbook instead of saying <strong>changed</strong> it will just say <strong>OK</strong> and not
perform any changes to Infoblox. This is also referred to as
<em>idempotency</em> (referred to in the <a href="http://docs.ansible.com/ansible/latest/glossary.html">Ansible Docs
glossar</a>y).</p>
<div class="code"><pre class="code literal-block"><span class="n">SEANs</span><span class="o">-</span><span class="n">MacBook</span><span class="o">-</span><span class="nl">Pro</span><span class="p">:</span><span class="n">infoblox_ansible</span><span class="w"> </span><span class="n">sean</span><span class="err">$</span><span class="w"> </span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="w">  </span><span class="n">configure_network</span><span class="p">.</span><span class="n">yml</span>

<span class="n">PLAY</span><span class="w"> </span><span class="o">[</span><span class="n">localhost</span><span class="o">]</span><span class="w"> </span><span class="o">***************************************************************************************</span>

<span class="n">TASK</span><span class="w"> </span><span class="o">[</span><span class="n">set dhcp options for a network</span><span class="o">]</span><span class="w"> </span><span class="o">***************************************************************</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">localhost</span><span class="o">]</span>

<span class="n">PLAY</span><span class="w"> </span><span class="n">RECAP</span><span class="w"> </span><span class="o">******************************************************************************************</span>
<span class="n">localhost</span><span class="w">                  </span><span class="err">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">1</span><span class="w">    </span><span class="n">changed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span>
</pre></div>

<h4>Ansible Infoblox Lookup Plugin</h4>
<p>Next let's look at the <a href="http://docs.ansible.com/ansible/latest/plugins/lookup.html">new lookup
plugin</a> for
Infoblox. The Ansible documentation for the lookup plugin can be <a href="http://docs.ansible.com/ansible/latest/plugins/lookup/nios.html">found
here</a>.
The lookup plugin allows us to query different InfoBlox NIOS objects,
such as network views, dns views, host records, and more. In my Infoblox
IPAM tab (<strong>Data Management-&gt;IPAM</strong>) I have four top of rack leaf
switches, and two spine switches defined. I can see them under the list
view for managed nodes:</p>
<p><img alt="Ansible-Infoblox-Image-2" src="../images/posts/archive/Ansible-Infoblox-Image-2.png"></p>
<p>Let's look at an Ansible Playbook snippet focused on grabbing
information about a host record:</p>
<div class="code"><pre class="code literal-block"><span class="x"> - name: fetch host leaf01</span>
<span class="x">      set_fact:</span>
<span class="x">        host: "</span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">'nios'</span><span class="o">,</span> <span class="s1">'record:host'</span><span class="o">,</span> <span class="nv">filter</span><span class="o">={</span><span class="s1">'name'</span><span class="o">:</span> <span class="s1">'leaf01'</span><span class="o">},</span> <span class="nv">provider</span><span class="o">=</span><span class="nv">nios_provider</span><span class="o">)</span> <span class="cp">}}</span><span class="x">"</span>
</pre></div>

<p>We will set the result of the lookup plugin (specified by the keyword
nios above) to the variable host. We only want the information for
leaf01, so we will filter based on the name. For the full playbook
checkout the get_host_record.yml stored on the <a href="https://github.com/network-automation/infoblox_ansible">network automation
community</a>.</p>
<p>Run the playbook with the ansible-playbook command:</p>
<div class="code"><pre class="code literal-block"><span class="n">SEANs</span><span class="o">-</span><span class="n">MacBook</span><span class="o">-</span><span class="nl">Pro</span><span class="p">:</span><span class="n">infoblox_ansible</span><span class="w"> </span><span class="n">sean</span><span class="err">$</span><span class="w"> </span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="w"> </span><span class="n">get_host_record</span><span class="p">.</span><span class="n">yml</span>

<span class="n">PLAY</span><span class="w"> </span><span class="o">[</span><span class="n">localhost</span><span class="o">]</span><span class="w"> </span><span class="o">***************************************************************************************</span>

<span class="n">TASK</span><span class="w"> </span><span class="o">[</span><span class="n">fetch host leaf01</span><span class="o">]</span><span class="w"> </span><span class="o">******************************************************************************</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">localhost</span><span class="o">]</span>

<span class="n">TASK</span><span class="w"> </span><span class="o">[</span><span class="n">check the leaf01 return variable</span><span class="o">]</span><span class="w"> </span><span class="o">*************************************************************</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">localhost</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="o">&lt;</span><span class="n">SNIPPET</span><span class="p">,</span><span class="w"> </span><span class="n">REST</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="k">OUTPUT</span><span class="w"> </span><span class="n">REMOVED</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="n">BREVITY</span><span class="o">&gt;</span>
<span class="w">    </span><span class="ss">"host"</span><span class="err">:</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="ss">"ipv4addrs"</span><span class="err">:</span><span class="w"> </span><span class="o">[</span>
<span class="n">            {</span>
<span class="n">                "configure_for_dhcp": false,</span>
<span class="n">                "host": "leaf01",</span>
<span class="n">                "ipv4addr": "192.168.1.11"</span>
<span class="n">            }</span>
<span class="n">        </span><span class="o">]</span><span class="p">,</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>

<span class="n">TASK</span><span class="w"> </span><span class="o">[</span><span class="n">debug specific variable (ipv4 address)</span><span class="o">]</span><span class="w"> </span><span class="o">******************************************************</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">localhost</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="ss">"host.ipv4addrs[0].ipv4addr"</span><span class="err">:</span><span class="w"> </span><span class="ss">"192.168.1.11"</span>
<span class="err">}</span>

<span class="n">TASK</span><span class="w"> </span><span class="o">[</span><span class="n">fetch host leaf02</span><span class="o">]</span><span class="w"> </span><span class="o">******************************************************************************</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">localhost</span><span class="o">]</span>

<span class="n">TASK</span><span class="w"> </span><span class="o">[</span><span class="n">check the leaf02 return variable</span><span class="o">]</span><span class="w"> </span><span class="o">*************************************************************</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">localhost</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="o">&lt;</span><span class="n">SNIPPET</span><span class="p">,</span><span class="w"> </span><span class="n">REST</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="k">OUTPUT</span><span class="w"> </span><span class="n">REMOVED</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="n">BREVITY</span><span class="o">&gt;</span>

<span class="w">    </span><span class="ss">"host"</span><span class="err">:</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="ss">"ipv4addrs"</span><span class="err">:</span><span class="w"> </span><span class="o">[</span>
<span class="n">            {</span>
<span class="n">                "configure_for_dhcp": false,</span>
<span class="n">                "host": "leaf02",</span>
<span class="n">                "ipv4addr": "192.168.1.12"</span>
<span class="n">            }</span>
<span class="n">        </span><span class="o">]</span><span class="p">,</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>

<span class="n">PLAY</span><span class="w"> </span><span class="n">RECAP</span><span class="w"> </span><span class="o">******************************************************************************************</span>
<span class="n">localhost</span><span class="w">                  </span><span class="err">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">5</span><span class="w">    </span><span class="n">changed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span>
</pre></div>

<p>The above playbook shows us how we can query Infoblox to grab specific
information about Infoblox objects (in this case, specific hosts). These
facts can be used through an Ansible play and allow Infoblox to act as a
single source of truth for information that may be changing. While the
Ansible modules allow you to configure Infoblox, the lookup plugin
allows you to grab information from Infoblox to use in subsequent tasks.
To read more about Ansible variables, facts and the set_fact module,
refer to the <a href="http://docs.ansible.com/ansible/latest/playbooks_variables.html">Ansible variables
documentation</a>.</p>
<h4>Ansible Infoblox Dynamic Inventory</h4>
<p>Ansible dynamic inventory scripts allow import of inventory from another
source like Cobbler, AWS or in this case Infoblox NIOS. You can read
more about dynamic inventory on the Ansible dynamic inventory
<a href="http://docs.ansible.com/ansible/latest/intro_dynamic_inventory.html">documentation
page</a>.</p>
<p>There are two files that need to be located under the
<code>contrib/inventory/</code> in the Ansible project:</p>
<ul>
<li>
<a href="https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/infoblox.yaml">infoblox.yaml</a> -
    specifies the provider arguments and optional filters</li>
<li>
<a href="https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/infoblox.py">infoblox.py</a> -
    python script that retrieves inventory</li>
</ul>
<p>Update the infoblox.yaml with your login information to the NIOS
instance. This includes the username, password and an IP address or
hostname. Make sure the infoblox.yaml file is located in <code>/etc/ansible/infoblox.yaml</code>.</p>
<p>To test your setup the python script infoblox.py can be run by executing
<code>python infoblox.py</code> on the command line:</p>
<div class="code"><pre class="code literal-block"><span class="p">[</span><span class="n">ec2</span><span class="o">-</span><span class="n">user</span><span class="nd">@ip</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">103</span><span class="o">-</span><span class="mi">218</span> <span class="n">infoblox</span><span class="p">]</span><span class="err">$</span> <span class="n">python</span> <span class="n">infoblox</span><span class="o">.</span><span class="n">py</span>
<span class="p">{</span>
    <span class="s2">" "</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"hosts"</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">"leaf01"</span><span class="p">,</span>
            <span class="s2">"leaf02"</span><span class="p">,</span>
            <span class="s2">"leaf03"</span><span class="p">,</span>
            <span class="s2">"leaf04"</span><span class="p">,</span>
            <span class="s2">"spine01"</span><span class="p">,</span>
            <span class="s2">"spine02"</span>
        <span class="p">]</span>
    <span class="p">},</span>
<span class="o">&lt;</span><span class="n">SNIPPET</span><span class="p">,</span> <span class="n">REST</span> <span class="n">OF</span> <span class="n">OUTPUT</span> <span class="n">REMOVED</span> <span class="n">FOR</span> <span class="n">BREVITY</span><span class="o">&gt;</span>
</pre></div>

<p>For this playbook we will create a small debug playbook to print out the
inventory_hostname for each host we grab using the infoblox python
dynamic inventory script.</p>
<div class="code"><pre class="code literal-block"><span class="o">---</span>
<span class="o">-</span><span class="w"> </span><span class="n">hosts</span><span class="p">:</span><span class="w"> </span><span class="n">all</span>
<span class="w">  </span><span class="n">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="bp">false</span>
<span class="w">  </span><span class="n">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">hosts</span>
<span class="w">      </span><span class="n">debug</span><span class="p">:</span>
<span class="w">      </span><span class="k">var</span><span class="p">:</span><span class="w"> </span><span class="n">inventory_hostname</span>
<span class="w">      </span><span class="n">delegate_to</span><span class="p">:</span><span class="w"> </span><span class="n">localhost</span>
</pre></div>

<p>To grab the inventory for a playbook use the
<code>-i</code> parameter and specify
the infoblox.py python script. Run the playbook with the
ansible-playbook command:</p>
<div class="code"><pre class="code literal-block"><span class="p">[</span><span class="n">sean</span><span class="nd">@rhel</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span><span class="err">$</span>  <span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">infoblox</span><span class="o">.</span><span class="n">py</span> <span class="n">debug</span><span class="o">.</span><span class="n">yml</span>

<span class="n">PLAY</span> <span class="p">[</span><span class="nb">all</span><span class="p">]</span> <span class="o">***********************************************************************************************</span>

<span class="n">TASK</span> <span class="p">[</span><span class="nb">list</span> <span class="nb">all</span> <span class="n">hosts</span><span class="p">]</span> <span class="o">************************************************************************************</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">leaf01</span> <span class="o">-&gt;</span> <span class="n">localhost</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">"inventory_hostname"</span><span class="p">:</span> <span class="s2">"leaf01"</span>
<span class="p">}</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">leaf03</span> <span class="o">-&gt;</span> <span class="n">localhost</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">"inventory_hostname"</span><span class="p">:</span> <span class="s2">"leaf03"</span>
<span class="p">}</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">leaf02</span> <span class="o">-&gt;</span> <span class="n">localhost</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">"inventory_hostname"</span><span class="p">:</span> <span class="s2">"leaf02"</span>
<span class="p">}</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">leaf04</span> <span class="o">-&gt;</span> <span class="n">localhost</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">"inventory_hostname"</span><span class="p">:</span> <span class="s2">"leaf04"</span>
<span class="p">}</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">spine01</span> <span class="o">-&gt;</span> <span class="n">localhost</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">"inventory_hostname"</span><span class="p">:</span> <span class="s2">"spine01"</span>
<span class="p">}</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">spine02</span> <span class="o">-&gt;</span> <span class="n">localhost</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">"inventory_hostname"</span><span class="p">:</span> <span class="s2">"spine02"</span>
<span class="p">}</span>

<span class="n">PLAY</span> <span class="n">RECAP</span> <span class="o">******************************************************************************************</span>
<span class="n">leaf01</span>                       <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">1</span>    <span class="n">changed</span><span class="o">=</span><span class="mi">0</span>    <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>
<span class="n">leaf02</span>                       <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">1</span>    <span class="n">changed</span><span class="o">=</span><span class="mi">0</span>    <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>
<span class="n">leaf03</span>                       <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">1</span>    <span class="n">changed</span><span class="o">=</span><span class="mi">0</span>    <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>
<span class="n">leaf04</span>                       <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">1</span>    <span class="n">changed</span><span class="o">=</span><span class="mi">0</span>    <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>
<span class="n">spine01</span>                    <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">1</span>    <span class="n">changed</span><span class="o">=</span><span class="mi">0</span>    <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>
<span class="n">spine02</span>                    <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">1</span>    <span class="n">changed</span><span class="o">=</span><span class="mi">0</span>    <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>
</pre></div>

<h4>More Information</h4>
<p>For more information on Ansible networking check out the <a href="../overview/networking">Ansible
Networking microsite</a>. Infoblox NIOS can now
utilize Ansible Playbook that are already configuring Cisco IOS, NX-OS,
IOS-XR, Juniper JunOS, Arista EOS and <a href="http://docs.ansible.com/ansible/latest/list_of_network_modules.html">much
more</a>.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="getting-started-ldap-authentication-in-ansible-tower/" class="u-url">Getting Started with LDAP Authentication in Ansible Tower</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/john-lieske/">John Lieske</a>
              </span>
            </p>
            <p class="dateline">
              <a href="getting-started-ldap-authentication-in-ansible-tower/" rel="bookmark">
                <time class="published dt-published" datetime="2018-01-31T00:00:00Z" itemprop="datePublished" title="2018-01-31 00:00">2018-01-31 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Getting Started with LDAP Authentication in Ansible Tower</h2>
<p>Next in the Getting Started series is
covering the basics of configuring Red Hat Ansible Tower to allow users
to log in with LDAP credentials. In this post, we'll explain a few
troubleshooting tips to help narrow down problems and correct them. As
long as you have a map of your LDAP tree/forest, this post should help
get users logging in with their LDAP credentials.</p>
<h3>CONFIGURATION SETTINGS</h3>
<p>To configure your Ansible Tower for LDAP authentication, navigate to
Settings (the gear icon) and to the "Configure Tower" section. The
area within these configuration settings we're focusing on is
"Authentication", and the sub category should be set to "LDAP".</p>
<p><img alt="Ansible-Getting-Started-Tower-LDAP-7" src="../images/posts/archive/Ansible-Getting-Started-Tower-LDAP-7.png"></p>
<p>The fields that will be the primary focus are:</p>
<ul>
<li>LDAP server URI</li>
<li>Bind DN and password</li>
<li>User/group searches</li>
</ul>
<p>The other fields will allow you to refine your LDAP searches to reduce
the resources used in production or map your organization.</p>
<p><strong>The LDAP URI</strong> is simply the IP or hostname of your LDAP server
prepended with the protocol (<code>ldap://</code>).</p>
<p><img alt="Ansible-Getting-Started-Tower-LDAP-8" src="../images/posts/archive/Ansible-Getting-Started-Tower-LDAP-8.png">\</p>
<p><strong>The bind DN</strong> will be a user credential and password (followed by the
group and domain) with access to read the LDAP structure.</p>
<p><img alt="Ansible-Getting-Started-Tower-LDAP-1" src="../images/posts/archive/Ansible-Getting-Started-Tower-LDAP-1.png"></p>
<h3>REFINING USER SEARCH</h3>
<p>With Ansible Tower able to connect to the LDAP server, refining the user
search completes the configuration. The User Search entry will match the
pattern specified by location and scope. In this case the user ID is the
sAMAccountName value (instead of uid) since the search is against an
Active Directory tree.</p>
<p><img alt="Ansible-Getting-Started-Tower-LDAP-4" src="../images/posts/archive/Ansible-Getting-Started-Tower-LDAP-4.png"><img alt="Ansible-Getting-Started-Tower-LDAP-2" src="../images/posts/archive/Ansible-Getting-Started-Tower-LDAP-2.png"></p>
<h3>USER AND GROUP SEARCH</h3>
<p>The User and Group searches are where the most troubleshooting might
have to be done, depending on how complex your directory structure is.
Use the ldapsearch tool from the openldap package to construct searches
against the LDAP server. Begin with a basic search and dive
incrementally to refine your searches.</p>
<div class="code"><pre class="code literal-block">ldapsearch -x  -H ldap://10.10.10.254 -D "CN=jarvis,CN=Users,DC=shield,DC=team" -w 01Password! -b "cn=Users,dc=shield,dc=team"
</pre></div>

<p>This search is general and will list results in the location specified
<code>(-b "cn=Users,dc=shield,dc=team")</code> with the location
matching what you would use for your LDAP search scope against your
server.</p>
<p>The LDAP Require Group and LDAP Deny Group fields are for adding single
entries to narrow your search scope by a single group. The LDAP User DN
Template field will narrow down the scope to just the format you enter
in the field. In the LDAP User Search field within the configuration
page use:</p>
<ul>
<li>SCOPE_SUBTREE: to search recursively down the directory tree</li>
<li>SCOPE_ONELEVEL: to specify a search one level down the tree only</li>
<li>SCOPE_BASE: to only search the level specified in the base DN</li>
</ul>
<p>Use the results returned from the LDAP search tool to choose the values
to search by, for example: uid or sAMAccountName &amp; group or
groupOfNames. It's worth keeping in mind that LDAP User DN Template will
supercede your LDAP User Search, so only use one or the other when
setting it up.</p>
<p><img alt="Ansible-Getting-Started-Tower-LDAP-6" src="../images/posts/archive/Ansible-Getting-Started-Tower-LDAP-6.png"></p>
<p><strong>For Windows/AD Admins</strong></p>
<p>These steps set up a single-sign-on to Ansible Tower for logging in LDAP
users. Configuration of Ansible Tower to authenticate against
LDAP-connected hosts would be done in the Credentials section, and the
same considerations will apply to authentication against Windows hosts
that apply to Ansible.Considerations include prepping WinRM on the hosts
to <a href="http://docs.ansible.com/ansible/latest/intro_windows.html#windows-system-prep">accept
connections</a>.
Before preparing and running jobs against Windows hosts in an Active
Directory, make sure to have the Credentials set up appropriately!</p>
<h3>USER ATTRIBUTE MAP</h3>
<p>Finally, it's important to dedicate some time when testing LDAP
authentication to attribute user and organization mapping. The LDAP User
Attribute Map is where the LDAP attributes are mapped to Ansible Tower
attributes. Examples include first name, last name, email, etc. In this
case the email attribute is mapping to the
[userPrincipalName] in the Active Directory Server being
used. The default is "mail" for most LDAP layouts, but you will need to
know your structure in order to map accordingly.</p>
<p><img alt="Ansible-Getting-Started-Tower-LDAP-5" src="../images/posts/archive/Ansible-Getting-Started-Tower-LDAP-5.png"></p>
<p>The LDAP User Flags By Group field can be used to quickly narrow down
mapping. For example, users belonging to the OU named "secret" are
mapped to the superusers group in Ansible Tower in the example below:</p>
<p><img alt="Ansible-Getting-Started-Tower-LDAP-3" src="../images/posts/archive/Ansible-Getting-Started-Tower-LDAP-3.png"></p>
<p>More complex mapping will get equally more complex when mapping to teams
and organizations in Ansible Tower. The example being used has a single
organization with org admins defined as the OU named "secret" that was
matched in User Flags By Group.</p>
<div class="code"><pre class="code literal-block">{
 "Shield": {
  "admins": [
   "ou=secret,dc=shield,dc=team"
  ],
  "remove_admins": false,
  "remove_users": false,
  "users": true
 }
}
</pre></div>

<p>Users are assigned teams using the LDAP Team Map field. The simple LDAP
database in the example below is mapping two groups to two respective
teams within the same organization.</p>
<div class="code"><pre class="code literal-block">{
 "secret": {
  "organization": "Shield",
  "users": "OU=secret,DC=shield,DC=team",
  "remove": false
 },
 "avengers": {
  "organization": "Shield",
  "users": "OU=avengers,DC=shield,DC=team",
  "remove": false
 }
}
</pre></div>

<p>Mapping users and groups to Ansible Tower will vary in difficulty based
on the LDAP database layout. Use the LDAP search command to refine your
group queries and match them accordingly in Ansible Tower.</p>
<h3>Recap</h3>
<ul>
<li>To authenticate LDAP users logging into Ansible Tower, use:
    LDAP server URI, bind DN &amp; password and user and group search</li>
<li>Using LDAP User DN Template overrides the User Search</li>
<li>Use LDAP Require Group and/or LDAP Deny Group to reduce the number
    of groups searched by Ansible Tower</li>
<li>LDAP User attributes in Ansible Tower are defined in LDAP User
    Attribute Map</li>
<li>Use LDAP User Flags By Group to set LDAP user flags in Ansible
    Tower</li>
<li>Groups in LDAP are mapped to organizations or teams in LDAP
    Organization Map and LDAP Team Map, respectively</li>
</ul>
</div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="getting-started-adding-proxy-support/" class="u-url">Adding Proxy Support within Red Hat Ansible Tower</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/jake-jackson/">Jake Jackson</a>
              </span>
            </p>
            <p class="dateline">
              <a href="getting-started-adding-proxy-support/" rel="bookmark">
                <time class="published dt-published" datetime="2018-01-22T00:00:00Z" itemprop="datePublished" title="2018-01-22 00:00">2018-01-22 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Adding Proxy Support within Red Hat Ansible Tower</h2>
<h3>Getting Started with Adding Proxy Support</h3>
<p>There are many reasons why proxies are implemented into an environment.
Some can be put in place for security, others as load balancers for your
systems. No matter the use, if you have a proxy in place, Red Hat
Ansible Tower may need to utilize it. For a more in-depth look at what
we will be doing in this post, you can visit our docs specifically on
Proxy Support within Ansible Tower
<a href="http://docs.ansible.com/ansible-tower/3.2.1/html/administration/proxy-support.html">here</a>.</p>
<h3>Adding a Load Balancer (Reverse Proxy)</h3>
<p>In some instances, you might have Ansible Tower behind a load balancer
and need that information added to your instance. Sessions in Ansible
Tower associate an IP address upon creation, and Ansible Tower's policy
requires that any use of the session match the original IP address.</p>
<p>To allow for support of a proxy, you will have to make a few changes to
your Ansible Tower configuration. Previously, this would have been done
in a settings.py file found on your Ansible Tower host, but as of 3.2
you can now make these changes in the UI. To make these edits, you must
be an admin on the instance and navigate to Settings, and then to
Ansible Tower configuration.</p>
<p>Once you are in the Ansible Tower Configuration, select the System tab
up at the top next to Jobs. Once there, we are going to be making an
edit to the Remote Host Headers box. There will already be some text in
there that is set after the installation. By default REMOTE_HOST_HEADERS
is set to <code>['REMOTE_ADDR', 'REMOTE_HOST']</code>.</p>
<p>The edit you are going to make should reflect the following line with
the relevant information from your organization\'s environment.</p>
<div class="code"><pre class="code literal-block">REMOTE_HOST_HEADERS = ['HTTP_X_FORWARDED_FOR', 'REMOTE_ADDR', 'REMOTE_HOST']
</pre></div>

<p>Once you have entered the relevant information, click the green Save
button in the bottom right corner and you'll be all set.</p>
<h3>Outbound Proxy</h3>
<p>Setting up Ansible Tower to utilize an outbound proxy is quick and easy.
One of the things that we see quite often when an outbound proxy needs
to be in place is a project sync failing (if you aren't using locally
stored playbooks). This error appears when Ansible Tower cannot resolve
the source control management (SCM) domain that you are using to manage
your versioned playbooks, such as github.com. To fix this issue, you
will need to make some configuration changes to Ansible Tower. To do
this, navigate to the admin settings (the gear in the top right hand
corner) and from there, select Configure Ansible Tower.</p>
<p>Navigate to the Jobs tab that can be found across the top of the page.
Once you are inside the Jobs tab, scroll down until you find the extra
environment variables.</p>
<p>You will need to enter three line entries to add your proxy to your
instance. Please note, you will need to know the server URL to make
these changes worth your while.</p>
<div class="code"><pre class="code literal-block">AWX_TASK_ENV['http_proxy'] = 'http://url:port/'

AWX_TASK_ENV['https_proxy'] = 'http://url:port/'

AWX_TASK_ENV['no_proxy'] = '127.0.0.1,localhost'
</pre></div>

<p>Once the information has been entered, select the green Save button in
the bottom right hand corner.</p>
<p>Please note, if you are upgrading from a prior release, you may need to
remove prior settings from configuration files before using the Ansible
Tower interface to configure these settings.</p>
<p>Now you can use Ansible Tower's power to automate while allowing it to
utilize your proxy server, ELB or whichever form of filtering you have
in place for your environment. It is not a hard process to implement,
but does require some prior knowledge about your particular infrastructure.</p>
          </div>
      </article><br><hr>
<br>
</div>
          <ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-2.html" rel="prev">Newer posts</a></li>
        </ul>
<!--End of body content-->
</div>
        <div class="content-slim redhat-footer">
      <div class="footer-left">
        <ul class="footer-left-links">
<li>
            <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a>
          </li>
          <li>
            <a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy policy</a>
          </li>
          <li>
            <a href="https://docs.ansible.com/ansible/latest/community/code_of_conduct.html" target="_blank">Code of conduct</a>
          </li>
        </ul>
</div>
      <div class="footer-right">
        <span class="redhat">Powered by</span>
        <span class="redhat-logo">
          <a href="https://www.redhat.com/en/technologies/management/ansible" target="_blank">
            <img src="../assets/images/redhat_reversed.svg" alt="Red Hat logo." width="96" height="28"></a>
        </span>
      </div>
    </div>

</div>

            <script src="../assets/js/jquery.min.js"></script><script src="../assets/js/popper.min.js"></script><script src="../assets/js/bootstrap.min.js"></script><script src="../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script><script src="../assets/js/clipboard.min.js" type="text/javascript"></script><script src="../assets/js/clipboard.js" type="text/javascript"></script>
</body>
</html>
