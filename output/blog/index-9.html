<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Ansible Collaborative Website">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ansible Collaborative (old posts, page 9) | Ansible Collaborative</title>
<link href="../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<!-- Red Hat fonts --><link rel="stylesheet" href="https://static.redhat.com/libs/redhat/redhat-font/2.0.0/webfonts/red-hat-font.css">
<!-- Font Awesome --><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
<!-- Fork Awesome --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css" integrity="sha256-XoaMnoYC5TH6/+ihMEnospgm0J1PM/nioxbOUdnM8HY=" crossorigin="anonymous">
<!-- Sass compiled css  --><link rel="stylesheet" href="../assets/css/main.css">
<link rel="stylesheet" href="../assets/css/redhat-footer.css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://ansible.com/blog/index-9.html">
<link rel="prev" href="index-10.html" type="text/html">
<link rel="next" href="index-8.html" type="text/html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]-->
</head>
<body id="top">

<div class="global-container" id="content" role="main">
<!-- Start menubar -->
<nav class="navbar navbar-expand-lg static-top mb-4 navbar-padding full-width-bg   navbar-dark   bg-pool   "><div class="masthead">
    <!-- This keeps the margins nice -->
    <a class="navbar-brand" href="../">
        <img src="../images/ansible_logo-small-15.png" alt="Ansible community logo" id="logo" class="d-inline-block align-top" width="50" height="50"></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon nav-toggle-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="bs-navbar">
      <ul class="navbar-nav mr-auto"></ul>
<ul class="navbar-nav navbar-right">
<li class="nav-item dropdown">
	        <a href="#" class="nav-link nav-link-color dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		    <i class=""></i> Documentation
                </a>
		<div class="dropdown-menu dropdown-menu-border">
	    
                    <a href="https://docs.ansible.com/" class="dropdown-item">
		        <i class=""></i> Project documentation
                    </a>
                    <a href="https://access.redhat.com/documentation/en-us/red_hat_ansible_automation_platform/" class="dropdown-item">
		        <i class=""></i> Ansible Automation Platform documentation
                    </a>
            </div>
                 </li>
<li class="nav-item">
		     <a href="https://galaxy.ansible.com/" target="_blank" class="nav-link nav-link-color">
		         <i class=""></i> Galaxy
		     </a>
		 </li>
                 <li class="nav-item">
		     <a href="https://forum.ansible.com/" target="_blank" class="nav-link nav-link-color">
		         <i class=""></i> Forum
		     </a>
		 </li>
            <li class="nav-item dropdown">
	        <a href="#" class="nav-link nav-link-color dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		    <i class=""></i> Resources
                </a>
		<div class="dropdown-menu dropdown-menu-border">
	    
                    <a href="../how-ansible-works/" class="dropdown-item">
		        <i class=""></i> How Ansible works
                    </a>
                    <a href="../ecosystem/" class="dropdown-item">
		        <i class=""></i> Ansible ecosystem
                    </a>
                    <a href="archive.html" class="dropdown-item">
		        <i class=""></i> Blog
                    </a>
                    <a href="../faq/" class="dropdown-item">
		        <i class=""></i> Frequently asked questions
                    </a>
                    <a href="../ansible-community-training/" class="dropdown-item">
		        <i class=""></i> Ansible community training
                    </a>
                    <a href="../contact-us/" class="dropdown-item">
		        <i class=""></i> Contact us
                    </a>
            </div>
                 </li>
<li class="nav-item">
		     <a href="https://www.redhat.com/en/technologies/management/ansible?sc_cid=7015Y000003szaKQAQ" target="_blank" class="nav-link nav-link-color">
		         <i class=""></i> Ansible Automation Platform
		     </a>
		 </li>

        
      </ul>
</div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav><!-- End default Menubar --><div class="body-content center-band">
        <!--Body content-->
        
    
  <div class="postindex ansible-content">
      <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="announcing-the-community-ansible-3.0.0-package/" class="u-url">Announcing the Community Ansible 3.0.0 Package</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/the-ansible-community-team/">The Ansible Community Team</a>
              </span>
            </p>
            <p class="dateline">
              <a href="announcing-the-community-ansible-3.0.0-package/" rel="bookmark">
                <time class="published dt-published" datetime="2021-02-18T00:00:00Z" itemprop="datePublished" title="2021-02-18 00:00">2021-02-18 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Announcing the Community Ansible 3.0.0 Package</h2>
<p>Version 3.0.0 of the Ansible community package marks the end of the
restructuring of the Ansible ecosystem. This work culminates what began
in 2019 to restructure the Ansible
project
and shape how Ansible content was
delivered.
Starting with Ansible 3.0.0, the versioning and naming reflects the new
structure of the project in the following ways: </p>
<ol>
<li>The versioning methodology for the Ansible community package now
    adopts semantic versioning, and begins to diverge from the versions
    of the Ansible Core package (which contains the Ansible language and
    runtime)</li>
<li>The forthcoming Ansible Core package will be renamed from
    ansible-base in version 2.10 to ansible-core in version 2.11 for
    consistency</li>
</ol>
<p>First, a little history. In Ansible 2.9 and prior, every plugin and
module was in the Ansible project
(<a href="https://github.com/ansible/ansible">https://github.com/ansible/ansible</a>)
itself. When you installed the "ansible" package, you got the
language, runtime, and all content (modules and other plugins). Over
time, the overwhelming popularity of Ansible created scalability
concerns. Users had to wait many months for updated content. Developers
had to rely on Ansible maintainers to review and merge their content.
These obvious bottlenecks needed to be addressed. </p>
<p>During the Ansible 2.10 development cycle, the Ansible community
successfully migrated most modules and plugins into
<a href="https://youtu.be/WOcqhk7TdYc">Collections</a>. Collections, and the
modules and plugins within them, could now be developed, updated and
released independently of Ansible itself. When the migration was done,
what remained in the core project started shipping as ansible-base, and
the Ansible Community Team created a new Ansible community package. The
Ansible 2.10 community package included ansible-base 2.10 plus all the
Collections that contain modules and plugins that were migrated out of
the original repository. As of Ansible 2.10, community users had two
options:  continue installing everything with the Ansible community
package, or install ansible-base and then add selected Collections
individually.</p>
<p>Today, there are 3 distinct artefacts in the Ansible open source world:</p>
<ul>
<li>Ansible Core - A minimal Ansible language and runtime (soon to be
    renamed from ansible-base)</li>
<li>Ansible Collections on Galaxy (community supported)</li>
<li>Ansible community package - Ansible installation including
    ansible-base/core plus community curated Collections</li>
</ul>
<p>Now that these artefacts are managed separately, their versions are
diverging as well. Moving forward, Ansible Core will maintain its
existing numbering scheme (similar to the Linux Kernel). The next
version of Ansible Core after ansible-base 2.10 will be ansible-core
2.11. The Ansible community package (Ansible Core + community
Collections) is adopting semantic versioning. The next version of the
Ansible community package after 2.10 is 3.0.0.</p>
<p>How the package is maintained and created has changed, but when you
install the Ansible community package, you still get the functionality
that existed in Ansible 2.9, with newer versions of modules and plugins.
Ansible 3.0.0 includes more than 85 Collections containing thousands of
modules and other plugins.</p>
<p>With so many changes happening at once for the Ansible community, we
thought it was a good idea to put together a Q&amp;A that can be found on
our blog.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="ansible-3.0.0-qa/" class="u-url">Ansible 3.0.0 Q&amp;A</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/the-ansible-community-team/">The Ansible Community Team</a>
              </span>
            </p>
            <p class="dateline">
              <a href="ansible-3.0.0-qa/" rel="bookmark">
                <time class="published dt-published" datetime="2021-02-18T00:00:00Z" itemprop="datePublished" title="2021-02-18 00:00">2021-02-18 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Ansible 3.0.0 Q&amp;A</h2>
<p>The Ansible community team has
<a href="https://www.ansible.com/blog/announcing-the-community-ansible-3.0.0-package">announced the release of Ansible 3.0.0</a>
and here are the questions about the release that we've heard from
community members so far. If you have a question that is not answered
below, let us know on the <a href="https://www.ansible.com/community">mailing lists or IRC</a>.</p>
<p><strong>How can I stay up to date with changes in the Ansible community?</strong></p>
<p>Subscribe to the <a href="https://groups.google.com/forum/#!forum/ansible-announce">ansible-announce mailing list</a>
for release announcements and to the <a href="https://us19.campaign-archive.com/home/?u=56d874e027110e35dea0e03c1&amp;id=d6635f5420">Bullhorn newsletter</a>
for community news. The Bullhorn is distributed every two weeks with key dates and updates. You may also consider
<a href="https://www.eventbrite.com/e/ansible-contributor-summit-202103-registration-141735886853">registering for the Ansible contributor summit</a>
on March 9, 2021.</p>
<h3>About the Ansible community package and ansible-base/ansible-core</h3>
<p><strong>Are there any changes to the Ansible language in 3.0.0?</strong></p>
<p>There are no significant changes since the Ansible 3.0.0 package depends on the same version of ansible-base as Ansible 2.10.x.</p>
<p><strong>Why are the versions of ansible-base/ansible-core packages diverging from the Ansible package?</strong></p>
<p>When the Ansible Community Team set out to restructure the Ansible project, Ansible was split into the following components: </p>
<ul>
<li>The core engine, modules and plugins</li>
<li>Community and partner supported Ansible Collections of modules and plugins</li>
</ul>
<p>The former became known as ansible-base, soon to be
<a href="https://github.com/ansible/ansible/blob/devel/docs/docsite/rst/roadmap/ROADMAP_2_11.rst">ansible-core</a>.
The latter became additions on top of the core, available either ad-hoc
or as part of the Ansible community package, which includes a set of
curated and maintained Collections.</p>
<p>Semantic versioning of the Ansible package will let us signal
backwards-compatibility as well as breaking changes in the included
Collections independently of the core engine.</p>
<p>Because these are different components and different things, it is
appropriate for them to be versioned independently from each other.</p>
<p><strong>Will ansible-base/ansible-core also adopt semantic versioning?</strong></p>
<p>No, the team managing ansible-core does not currently plan to adopt semantic versioning.</p>
<p><strong>What is the correlation between Ansible 3.0.0 and ansible-base 2.10.x?</strong></p>
<p>Ansible 3.0.0 is a package that includes over <a href="https://github.com/ansible-community/ansible-build-data/blob/main/3/ansible-3.build">85 Ansible Collections</a>.
It doesn't include ansible-base: it <em>depends</em> on it and specifies a required version range such as <em>ansible-base&gt;=2.10.6,&lt;2.11</em> so that the appropriate core package gets installed automatically.
For Ansible 4.0.0, this dependency will shift to <em>ansible-core&gt;=2.11,&lt;2.12</em> instead.</p>
<p>ansible-base 2.10.x (as well as ansible-core in the near future) will continue to be available as a standalone package for users that prefer installing only the Collections they need.</p>
<p><strong>How is the range of included Collection versions established?</strong></p>
<p>The release build tooling queries the latest version of included Collections and determines the upper-limit based on that version.</p>
<p>For example, if a collection's version is 1.5, the range would be <em>&gt;=1.5,&lt;2.0</em>.
If the collection's version is 2.3, the range would be <em>&gt;=2.3,&lt;3.0</em>.</p>
<p>The general idea is to keep Collections within a single major version throughout the lifecycle of a single Ansible package major version.</p>
<p><strong>What version will ansible --version return?</strong></p>
<p><code>ansible --version</code> will return the version of ansible-base, not the version of the Ansible package, because ansible-base is the one providing the ansible command.</p>
<h4>Installing and upgrading</h4>
<p><strong>How can I install Ansible 3.0.0?</strong></p>
<p>The Ansible 3.0.0 Community package is <a href="https://pypi.org/project/ansible/">released to PyPI</a> and can be installed
with <code>pip install ansible==3.0.0</code>.</p>
<p><strong>Can I upgrade to Ansible 3.0.0 from previous versions of Ansible? If so which ones?</strong></p>
<ul>
<li>To upgrade to Ansible-3.0 from Ansible-2.10: <code>pip install --upgrade ansible</code>.</li>
<li>To upgrade to Ansible-3.0 from Ansible-2.9 or earlier: <code>pip uninstall ansible</code>; <code>pip install ansible</code>.
  This is due to a limitation in pip.</li>
</ul>
<p>Yes, but the command to upgrade is different depending on the version you have now.</p>
<p>Ansible 3.0.0 is based on ansible-base 2.10, so playbook syntax remains
the same between Ansible-2.10 and Ansible-3.0. However, there may be
incompatibilities in some modules and plugins as Ansible-3.0.0 allows
backwards-incompatible changes in Collections.</p>
<p><strong>Will I be able to upgrade to Ansible 4.0.0 from Ansible 3.0.0?</strong></p>
<p>Yes, but you will have to uninstall and reinstall again, due to
the renaming of ansible-base to ansible-core: <code>pip uninstall ansible</code>; <code>pip install ansible</code>.</p>
<p>Ansible 4.0.0 will be based on
ansible-core 2.11, so playbook syntax in Ansible 4.0.0 may
include backwards incompatible changes (ansible-core does not
use semantic versioning, so updates to the minor version can
contain backwards incompatible changes).  When Ansible 4.0.0 is
ready to start its pre-release cycle, porting guides will be
available to help guide you through those
changes.</p>
<h4>Release cadence and scope</h4>
<p><strong>What is the release cadence moving forward?</strong></p>
<p>Minor version releases of the Ansible package (such as 3.1.0,
3.2.0) are planned for every three weeks.  These releases will
include new backwards-compatible features, modules and plugins
as well as bug fixes.</p>
<p>Major version releases of the Ansible package (such as 4.0.0,
5.0.0) will happen after new releases of ansible-core. The
Ansible 4.0.0 release is planned for May 2021, soon after the
release of ansible-core 2.11 in April. After 4.0.0, a six month
release cycle for major versions will become the normal cadence,
with 5.0.0 releasing in November, trailing the planned 2.12
release of ansible-core.</p>
<p><strong>How much change will each minor and major version of Ansible contain?</strong></p>
<p>Each minor release of the Ansible community package will accept
only backwards-compatible changes in included Collections.
Collections must also use semantic versioning, so the Collection
version numbers will reflect this rule. For example, if Ansible
3.0.0 releases with community.general 2.0.0, then all minor
releases of Ansible 3.x (such as Ansible 3.1.0 or Ansible 3.5.0)
would include a 2.x release of community.general (such as 2.8.0
or 2.9.5).</p>
<p>Each major release of the Ansible community package will accept
the latest released version of each included Collection and may
include the latest released version of ansible-core. Major
releases of the Ansible community package can contain breaking
changes in the modules and other plugins within the included
Collections and/or in core features.</p>
<p><strong>What changes will each patch release contain, given the use of semantic versioning here?</strong></p>
<p>Patch releases will be used only when bugs are discovered that
warrant a targeted fix for with a quick turnaround.  For
instance, if a packaging bug is discovered in our release of
3.1.0 that prevents Debian packages from being built, a 3.1.1
release may occur the next day that fixes that issue. No new
features are allowed in patch releases.</p>
<h4>Packaging</h4>
<p><strong>Will Ansible 3.0.0 be made available as an upstream RPM?</strong></p>
<p>No. RPM-based Linux distros, such as <a href="https://src.fedoraproject.org/rpms/ansible">Fedora</a>,
have been creating superior RPM packages of Ansible for a while
now. So we decided for Ansible-2.10 and ansible-base-2.10, the
Ansible project would no longer provide pre-built RPMs.</p>
<p><strong>Will Ansible 3.0.0 be available on Ubuntu Launchpad?</strong></p>
<p>Yes. The Ansible Community Team is catching up to the changes
in how the Ansible content is packaged but plan to have releases
in the PPA soon.  The team is currently testing a new GitHub
action to build the debs for the PPA.</p>
<h4>Terminology</h4>
<ul>
<li><em>The ansible package</em></li>
</ul>
<p>An all-in-one software package (Python, deb, rpm, etc) that
provides backwards compatibility with Ansible 2.9 by including
modules and plugins that have since been migrated to Ansible
Collections.</p>
<p>The Ansible package depends on ansible-base (soon ansible-core).
So when you do pip install ansible, pip installs ansible-base
automatically.</p>
<p>Ansible 3.0.0 contains more Collections thanks to the wider
Ansible community reviewing Collections against the community
checklist. This list of what's included can be found at
<a href="https://github.com/ansible-community/ansible-build-data/tree/master/2.10">ansible-build-data</a>.</p>
<ul>
<li><em>Collection</em></li>
</ul>
<p>A packaging format for bundling and distributing Ansible
content: plugins, roles, modules, playbooks, documentation and
more. Can be released independent of other Collections or
ansible-base so features and bug
fixes can be made available sooner to users.
    Installed from source repositories, from
<a href="https://galaxy.ansible.com/">galaxy.ansible.com</a> via
<code>ansible-galaxy collection install &lt;namespace.collection&gt;</code> or using a <a href="https://galaxy.ansible.com/docs/using/installing.html#installing-multiple-roles-from-a-file">requirements.yml file</a>.</p>
<ul>
<li><em>ansible-base</em></li>
</ul>
<p>New for 2.10. The codebase that is now contained in
<code>github.com/ansible/ansible</code> for the Ansible 2.10 release. It
contains a minimal amount of modules and plugins and allows
other Collections to be installed. Similar to Ansible 2.9 though
without any content that has since moved into a Collection.</p>
<p>Renamed to ansible-core in the devel branch of Ansible and will
be released under that name from version 2.11 onwards.</p>
<ul>
<li><em>Red Hat Ansible Automation Platform</em></li>
</ul>
<p>The commercially available enterprise offering from Red Hat,
combining multiple Ansible focused projects, including
ansible-core, awx, galaxy_ng, Collections and various Red Hat
tools focused on an integrated Ansible user experience.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="bullhorn-19/" class="u-url">Bullhorn #19</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/ansible-collaborative-et-al/">Ansible Collaborative, et al</a>
              </span>
            </p>
            <p class="dateline">
              <a href="bullhorn-19/" rel="bookmark">
                <time class="published dt-published" datetime="2021-02-04T21:00:00Z" itemprop="datePublished" title="2021-02-04 21:00">2021-02-04 21:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <div>
<p><img alt="Ansible Bullhorn banner" src="../images/bullhorn-banner-mango.png"></p>
<h3>The Bullhorn</h3>
<p><em>A Newsletter for the Ansible Developer Community</em>
<em>Issue #19, 2021-02-04 (<a href="https://us19.campaign-archive.com/home/?u=56d874e027110e35dea0e03c1&amp;id=d6635f5420">Past Issues</a>)</em></p>
<p>Welcome to the Bullhorn, our newsletter for the Ansible developer community. If you have any questions or content you’d like to share, please reach out to us at the-bullhorn@redhat.com, or comment on this <a href="https://github.com/ansible/community/issues/546">GitHub issue</a>.</p>
</div>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="using-new-ansible-utilities-for-operational-state-management-and-remediation/" class="u-url">Using New Ansible Utilities for Operational State Management and Remediation</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/ganesh-nalawade/">Ganesh Nalawade</a>
              </span>
            </p>
            <p class="dateline">
              <a href="using-new-ansible-utilities-for-operational-state-management-and-remediation/" rel="bookmark">
                <time class="published dt-published" datetime="2021-01-21T00:00:00Z" itemprop="datePublished" title="2021-01-21 00:00">2021-01-21 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Using New Ansible Utilities for Operational State Management and Remediation</h2>
<p>Comparing the current operational state of your IT infrastructure to
your desired state is a common use case for IT automation.  This allows
automation users to identify drift or problem scenarios to take
corrective actions and even proactively identify and solve problems. 
This blog post will walk through the automation workflow for validation
of operational state and even automatic remediation of issues.</p>
<p>We will demonstrate how the Red Hat supported and certified Ansible
content can be used to:</p>
<ul>
<li>Collect the current operational state from the remote host and
    convert it into normalised structure data.</li>
<li>Define the desired state criteria in a standard based format that
    can be used across enterprise infrastructure teams.</li>
<li>Validate the current state data against the pre-defined criteria to
    identify if there is any deviation.</li>
<li>Take corrective remediation action as required.</li>
<li>Validate input data as per the data model schema</li>
</ul>
<h3>Gathering state data from a remote host</h3>
<p>The recently released
<a href="https://galaxy.ansible.com/ansible/utils">ansible.utils</a>
version 1.0.0 Collection has added support for
<a href="https://github.com/ansible-collections/ansible.utils/blob/main/docs/ansible.utils.cli_parse_module.rst">ansible.utils.cli_parse</a>
module, which converts text data into structured JSON format.  The
module has the capability to either execute the command on the remote
endpoint and fetch the text response, or read the text from a file on
the control node to convert it into structured data.  This module can
work with both traditional Linux servers as well as vendor appliances,
such as network devices that don't have the ability to execute Python,
and the module relies on well-known text parser libraries for this
conversion. The current supported CLI parser sub plugin engines are as
below:</p>
<ol>
<li>
<a href="https://github.com/ansible-collections/ansible.utils/blob/main/plugins/sub_plugins/cli_parser/textfsm_parser.py">ansible.utils.textfsm</a>
    Uses<a href="https://pypi.org/project/textfsm/"> textfsm python library</a>
</li>
<li>
<a href="https://github.com/ansible-collections/ansible.utils/blob/main/plugins/sub_plugins/cli_parser/ttp_parser.py">ansible.utils.ttp</a>
    Uses<a href="https://pypi.org/project/ttp/"> ttp python library</a>
</li>
<li>
<a href="https://github.com/ansible-collections/ansible.netcommon/blob/main/plugins/sub_plugins/cli_parser/native_parser.py">ansible.netcommon.native</a>
    Uses netcommon inbuilt parser engine</li>
<li>
<a href="https://github.com/ansible-collections/ansible.netcommon/blob/main/plugins/sub_plugins/cli_parser/ntc_templates_parser.py">ansible.netcommon.ntc_templates</a>
    Uses <a href="https://pypi.org/project/ntc-templates/">ntc_templates python library</a>
</li>
<li>
<a href="https://github.com/ansible-collections/ansible.netcommon/blob/main/plugins/sub_plugins/cli_parser/pyats_parser.py">ansible.netcommon.pyats</a>
    Uses <a href="https://pypi.org/project/pyats/">pyats python library</a>
</li>
<li>
<a href="https://github.com/ansible-collections/ansible.utils/blob/main/plugins/sub_plugins/cli_parser/xml_parser.py">ansible.utils.xml</a>Uses
    <a href="https://pypi.org/project/xmltodict/">xmltodict python library</a> </li>
<li><a href="https://github.com/ansible-collections/ansible.utils/blob/main/plugins/sub_plugins/cli_parser/json_parser.py">ansible.utils.json</a></li>
</ol>
<p><img alt="state assessment blog" src="../images/posts/archive/state-assessment-blog.png"></p>
<p>The examples described in this blog uses Cisco network switch, NXOS
version 7.3(0)D1(1), as the remote endpoint and Ansible version 2.9.15
running on the control node and requires
<a href="https://galaxy.ansible.com/ansible/utils">ansible.utils</a>,
<a href="https://galaxy.ansible.com/ansible/netcommon">ansible.netcommon</a> and
<a href="https://galaxy.ansible.com/cisco/nxos">cisco.nxos </a>Collections to be
installed on the control node.</p>
<p>The below <a href="https://gist.github.com/ganeshrn/f763e299cb4896b548c586b57041ee73">Ansible snippet</a>
fetches the operational state of the interfaces and translates it to
structured data using <strong>ansible.netcommon.pyats</strong> parser. This parse
requires <a href="https://pypi.org/project/pyats/">pyats</a> library to be
installed on the control node.</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nxos</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.netcommon.network_cli</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ansible_network_os</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cisco.nxos.nxos</span>
<span class="w">    </span><span class="nt">ansible_user</span><span class="p">:</span><span class="w"> </span><span class="s">"changeme"</span>
<span class="w">    </span><span class="nt">ansible_password</span><span class="p">:</span><span class="w"> </span><span class="s">"changeme"</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"Fetch</span><span class="nv"> </span><span class="s">interface</span><span class="nv"> </span><span class="s">state</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">parse</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">pyats"</span>
<span class="w">    </span><span class="nt">ansible.utils.cli_parse</span><span class="p">:</span>
<span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show interface</span>
<span class="w">      </span><span class="nt">parser</span><span class="p">:</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.netcommon.pyats</span>
<span class="w">    </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nxos_pyats_show_interface</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">print structured interface state data</span>
<span class="w">    </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span>
<span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">nxos_pyats_show_interface['parsed']</span><span class="nv"> </span><span class="s">}}"</span>
</pre></div>

<p>The value of the <strong>command</strong> option in <strong>ansible.utils.cli_parse</strong> task
is the command that should the executed on the remote host,
alternatively, the task can accept a <strong>text</strong> option that accepts the
value directly in string format and can be used in case the response of
the command is already prefetched. The <strong>name</strong> option under the
<strong>parser</strong> parent option can be any one of the above-discussed parser
sub plugins.</p>
<p>After running the playbook, the output of <strong>ansible.utils.cli_parse</strong>
task for the given host is as shown for reference:</p>
<div class="code"><pre class="code literal-block"><span class="err">ok</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="kc">n</span><span class="err">xos</span><span class="p">]</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nt">"changed"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">   </span><span class="nt">"parsed"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="nt">"Ethernet2/1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="nt">"admin_state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"down"</span><span class="p">,</span>
<span class="w">           </span><span class="nt">"auto_mdix"</span><span class="p">:</span><span class="w"> </span><span class="s2">"off"</span><span class="p">,</span>
<span class="w">           </span><span class="nt">"auto_negotiate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">           </span><span class="nt">"bandwidth"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">           </span><span class="nt">"beacon"</span><span class="p">:</span><span class="w"> </span><span class="s2">"off"</span>
<span class="w">           </span><span class="err">&lt;</span><span class="mi">--</span><span class="err">s</span><span class="kc">n</span><span class="err">ip</span><span class="mi">--</span><span class="err">&gt;</span>
<span class="w">       </span><span class="p">},</span>
<span class="w">       </span><span class="nt">"Ethernet2/10"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="nt">"admin_state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"down"</span><span class="p">,</span>
<span class="w">           </span><span class="nt">"auto_mdix"</span><span class="p">:</span><span class="w"> </span><span class="s2">"off"</span><span class="p">,</span>
<span class="w">           </span><span class="nt">"auto_negotiate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">           </span><span class="nt">"bandwidth"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">           </span><span class="nt">"beacon"</span><span class="p">:</span><span class="w"> </span><span class="s2">"off"</span><span class="p">,</span>
<span class="w">           </span><span class="err">&lt;</span><span class="mi">--</span><span class="err">s</span><span class="kc">n</span><span class="err">ip</span><span class="mi">--</span><span class="err">&gt;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
</pre></div>

<p>Notice the value of <strong>admin_state</strong> key for some of the interfaces is
<strong>down</strong>, for the complete output refer
<a href="https://gist.github.com/ganeshrn/79a7a2670ce03fe381678f9796482089">here</a>.</p>
<h3>Defining state criteria and validation</h3>
<p>The <a href="https://galaxy.ansible.com/ansible/utils">ansible.utils</a> Collection
has added support for the
<a href="https://github.com/ansible-collections/ansible.utils/blob/main/docs/ansible.utils.validate_module.rst">ansible.utils.validate</a>
module, which validates the input JSON data with the provided criteria
based on the validation engine. The currently supported validation
engine is <a href="https://pypi.org/project/jsonschema/">jsonschema</a>, and in
future support for additional validation, engines will be added on a
need basis. </p>
<p>In the above section, we fetched the interface state and converted to
structured JSON data. Suppose if we want the desired admin state for all
the interfaces to always be in <strong>up</strong> state the <a href="https://gist.github.com/ganeshrn/0a479d580caa96326a7c8186c4b12d7d">criteria for
jsonschema</a>
will look like:</p>
<div class="code"><pre class="code literal-block"><span class="err">$ca</span><span class="kc">t</span><span class="w"> </span><span class="err">cri</span><span class="kc">ter</span><span class="err">ias/</span><span class="kc">n</span><span class="err">xos_show_i</span><span class="kc">nterfa</span><span class="err">ce_admi</span><span class="kc">n</span><span class="err">_cri</span><span class="kc">ter</span><span class="err">ia.jso</span><span class="kc">n</span>
<span class="p">{</span>
<span class="w">        </span><span class="nt">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"patternProperties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">"^.*"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span>
<span class="w">                        </span><span class="nt">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="nt">"admin_state"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span>
<span class="w">                                        </span><span class="nt">"pattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"up"</span>
<span class="w">                                </span><span class="p">}</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
</pre></div>

<p>After the criteria for the desired state of the resource is defined, it
can be used with the <strong>ansible.utils.validate</strong> module to check if the
current state of the resource matches with the desired state as shown in
the below
<a href="https://gist.github.com/ganeshrn/d9a3049673bd8bec1cbd4b717cf56c99">task</a>.</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">validate interface for admin state</span>
<span class="w">  </span><span class="nt">ansible.utils.validate</span><span class="p">:</span>
<span class="w">    </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">nxos_pyats_show_interface['parsed']</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">    </span><span class="nt">criteria</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('file',</span><span class="nv">  </span><span class="s">'./criterias/nxos_show_interface_admin_criteria.json')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">from_json</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">    </span><span class="nt">engine</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.utils.jsonschema</span>
<span class="w">  </span><span class="nt">ignore_errors</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">result</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">print the interface names that does not satisfy the desired state</span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">item['data_path'].split('.')[0]</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">result['errors']</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="s">"'errors'</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">result"</span>
</pre></div>

<p>The <strong>data</strong> option of <strong>ansible.utils.validate</strong> task accepts a JSON
value and in this case, it is the output parsed from
<strong>ansible.utils.cli_parse</strong> module as discussed above. The value of
<strong>engine</strong> option is the sub plugin name of the validate module that is
<a href="https://github.com/ansible-collections/ansible.utils/blob/main/docs/ansible.utils.jsonschema_validate.rst">ansible.utils.jsonschema</a>,
and it identifies the underlying validation library to be used; in this
case, we are using <strong>jsonschema</strong> library. The value of the <strong>criteria</strong>
option can be a list and should be in a format that is defined by the
validation engine used. For the above to run
<a href="https://pypi.org/project/jsonschema/">jsonschema</a>, installing a library
is required on the control node. The output of the above task run will
be a list of errors indicating interfaces that do not have admin value
in <strong>up</strong> state. The reference output can be seen
<a href="https://gist.github.com/ganeshrn/912d88b7ff5b6a959e82c4935d9b4d0c">here</a>
(note: the output will vary based on the state of the interfaces on the
remote host).</p>
<div class="code"><pre class="code literal-block">TASK<span class="w"> </span><span class="o">[</span>validate<span class="w"> </span>interface<span class="w"> </span><span class="k">for</span><span class="w"> </span>admin<span class="w"> </span>state<span class="o">]</span><span class="w"> </span>***********************************************************************************************************
fatal:<span class="w"> </span><span class="o">[</span>nxos02<span class="o">]</span>:<span class="w"> </span>FAILED!<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span><span class="s2">"changed"</span>:<span class="w"> </span>false,<span class="w"> </span><span class="s2">"errors"</span>:<span class="w"> </span><span class="o">[{</span><span class="s2">"data_path"</span>:<span class="w"> </span><span class="s2">"Ethernet2/1.admin_state"</span>,<span class="w"> </span><span class="s2">"expected"</span>:<span class="w"> </span><span class="s2">"up"</span>,<span class="w"> </span><span class="s2">"found"</span>:<span class="w"> </span><span class="s2">"down"</span>,<span class="w"> </span><span class="s2">"json_path"</span>:<span class="w"> </span><span class="s2">"</span>$<span class="s2">.Ethernet2/1.admin_state"</span>,<span class="w"> </span><span class="s2">"message"</span>:<span class="w"> </span><span class="s2">"'down' does not match 'up'"</span>,<span class="w"> </span><span class="s2">"relative_schema"</span>:<span class="w"> </span><span class="o">{</span><span class="s2">"pattern"</span>:<span class="w"> </span><span class="s2">"up"</span>,<span class="w"> </span><span class="s2">"type"</span>:<span class="w"> </span><span class="s2">"string"</span><span class="o">}</span>,<span class="w"> </span><span class="s2">"schema_path"</span>:<span class="w"> </span><span class="s2">"patternProperties.^.*.properties.admin_state.pattern"</span>,<span class="w"> </span><span class="s2">"validator"</span>:<span class="w"> </span><span class="s2">"pattern"</span><span class="o">}</span>,<span class="w"> </span><span class="o">{</span><span class="s2">"data_path"</span>:<span class="w"> </span><span class="s2">"Ethernet2/10.admin_state"</span>,<span class="w"> </span><span class="s2">"expected"</span>:<span class="w"> </span><span class="s2">"up"</span>,<span class="w"> </span><span class="s2">"found"</span>:<span class="w"> </span><span class="s2">"down"</span>,<span class="w"> </span><span class="s2">"json_path"</span>:<span class="w"> </span><span class="s2">"</span>$<span class="s2">.Ethernet2/10.admin_state"</span>,<span class="w"> </span><span class="s2">"message"</span>:<span class="w"> </span><span class="s2">"'down' does not match 'up'"</span>,<span class="w"> </span><span class="s2">"relative_schema"</span>:<span class="w"> </span><span class="o">{</span><span class="s2">"pattern"</span>:<span class="w"> </span><span class="s2">"up"</span>,<span class="w"> </span><span class="s2">"type"</span>:<span class="w"> </span><span class="s2">"string"</span><span class="o">}</span>,<span class="w"> </span><span class="s2">"schema_path"</span>:<span class="w"> </span><span class="s2">"patternProperties.^.*.properties.admin_state.pattern"</span>,<span class="w"> </span><span class="s2">"validator"</span>:<span class="w"> </span><span class="s2">"pattern"</span><span class="o">}]</span>,<span class="w"> </span><span class="s2">"msg"</span>:<span class="w"> </span><span class="s2">"Validation errors were found.\nAt 'patternProperties.^.*.properties.admin_state.pattern' 'down' does not match 'up'. \nAt 'patternProperties.^.*.properties.admin_state.pattern' 'down' does not match 'up'. \nAt 'patternProperties.^.*.properties.admin_state.pattern' 'down' does not match 'up'. "</span><span class="o">}</span>
...ignoring
</pre></div>

<div class="code"><pre class="code literal-block">TASK<span class="w"> </span><span class="o">[</span>print<span class="w"> </span>the<span class="w"> </span>interface<span class="w"> </span>names<span class="w"> </span>that<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>satisfy<span class="w"> </span>the<span class="w"> </span>desired<span class="w"> </span>state<span class="o">]</span><span class="w"> </span>****************************************************************************
Monday<span class="w"> </span><span class="m">14</span><span class="w"> </span>December<span class="w"> </span><span class="m">2020</span><span class="w">  </span><span class="m">11</span>:05:38<span class="w"> </span>+0530<span class="w"> </span><span class="o">(</span><span class="m">0</span>:00:01.661<span class="o">)</span><span class="w">       </span><span class="m">0</span>:00:28.676<span class="w"> </span>*******
ok:<span class="w"> </span><span class="o">[</span>nxos<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">   </span><span class="s2">"msg"</span>:<span class="w"> </span><span class="s2">"Ethernet2/1"</span>
<span class="o">}</span>
ok:<span class="w"> </span><span class="o">[</span>nxos<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">   </span><span class="s2">"msg"</span>:<span class="w"> </span><span class="s2">"Ethernet2/10"</span>
<span class="o">}</span>

PLAY<span class="w"> </span>RECAP<span class="w"> </span>******************************************************************************************************************************************
nxos<span class="w">                       </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">4</span><span class="w">    </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">rescued</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">ignored</span><span class="o">=</span><span class="m">1</span>
</pre></div>

<p>As seen from the above output, the interface <strong>Ethernet2/1</strong> and
<strong>Ethernet2/10</strong> are not in the desired state as per the defined
criteria.</p>
<h3>Remediation</h3>
<p>Based on the output of the <strong>ansible.utils.validate</strong> task, a number of
remediation actions can be taken using Ansible modules for configuration
management and/or reporting. In our case, we will be using the
<a href="https://github.com/ansible-collections/cisco.nxos/blob/main/docs/cisco.nxos.nxos_interfaces_module.rst">cisco.nxos.nxos_interfaces</a>
resource module to configure the given interfaces in admin <strong>up</strong> state
as shown in the below
<a href="https://gist.github.com/ganeshrn/58f1346aa3dad4ce771fe4cb9420349f">snippet</a>.</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure interface with drift in admin up state</span>
<span class="w">  </span><span class="nt">cisco.nxos.nxos_interfaces</span><span class="p">:</span>
<span class="w">    </span><span class="nt">config</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">item['data_path'].split('.')[0]</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">result['errors']</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="s">"'errors'</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">result"</span>
</pre></div>

<p>This remediation task will be executed only when the validation from the
earlier task fails and will run only for those interfaces whose admin
state is not up.</p>
<h3>Data validation</h3>
<p>It is often required to validate the data before giving it as an input
to the task to ensure the input data structure is  per the expected data
model.  This allows us to validate data model adherence prior to pushing
configuration to the network device. This use case is explained in the
<a href="https://www.ipspace.net/kb/DataModels/70-Validation.html">data validation</a>
blog from <a href="https://www.ipspace.net/Main_Page">Ivan Pepelnjak</a>.</p>
<p><img alt="state assessment blog two" src="../images/posts/archive/state-assessment-blog-two.png"></p>
<p>The blog uses command-line tools to validate the input data, however
with the support of the <strong>ansible.utils.validate</strong> module, this
functionality can now be added in the Ansible Playbook itself as shown
in the below
<a href="https://gist.github.com/ganeshrn/11ef6cf725ee8fbc4f7a1bbffe5eb92b">snippet</a>.</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">validate bgp data data with jsonschema bgp model criteria</span>
<span class="w">  </span><span class="nt">ansible.utils.validate</span><span class="p">:</span>
<span class="w">    </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">hostvars</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">    </span><span class="nt">criteria</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('file',</span><span class="nv"> </span><span class="s">'./bgp_data_model_criteria.json')</span><span class="nv"> </span><span class="s">|</span><span class="nv">  </span><span class="s">from_json</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">    </span><span class="nt">engine</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.utils.jsonschema</span>
<span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">result</span>
</pre></div>

<p>The criteria structure stored in <strong>bgp_data_model_criteria.json</strong> file
locally can be referred
<a href="https://gist.github.com/ganeshrn/aef7f74d132199b5ddb379d49fe314f7">here</a> 
(modified example from the <a href="https://www.ipspace.net/kb/DataModels/70-Validation.html">original blog
post</a>) and the
sample <code>host_vars</code> file as below:</p>
<div class="code"><pre class="code literal-block"><span class="nv">$cat</span><span class="w"> </span>host_vars/nxos.yaml
---
bgp_as:<span class="w"> </span><span class="m">0</span>
description:<span class="w"> </span>Unexpected
</pre></div>

<p>The output of the above task run can be seen as below:</p>
<div class="code"><pre class="code literal-block">TASK<span class="w"> </span><span class="o">[</span>validate<span class="w"> </span>bgp<span class="w"> </span>data<span class="w"> </span>data<span class="w"> </span>with<span class="w"> </span>jsonschema<span class="w"> </span>bgp<span class="w"> </span>model<span class="w"> </span>criteria<span class="o">]</span><span class="w"> </span>*******************************************************************************************
fatal:<span class="w"> </span><span class="o">[</span>nxos<span class="o">]</span>:<span class="w"> </span>FAILED!<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span><span class="s2">"changed"</span>:<span class="w"> </span>false,<span class="w"> </span><span class="s2">"errors"</span>:<span class="w"> </span><span class="o">[{</span><span class="s2">"data_path"</span>:<span class="w"> </span><span class="s2">"nxos.bgp_as"</span>,<span class="w"> </span><span class="s2">"expected"</span>:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="s2">"found"</span>:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="s2">"json_path"</span>:<span class="w"> </span><span class="s2">"</span>$<span class="s2">.nxos.bgp_as"</span>,<span class="w"> </span><span class="s2">"message"</span>:<span class="w"> </span><span class="s2">"0 is less than the minimum of 1"</span>,<span class="w"> </span><span class="s2">"relative_schema"</span>:<span class="w"> </span><span class="o">{</span><span class="s2">"maximum"</span>:<span class="w"> </span><span class="m">65535</span>,<span class="w"> </span><span class="s2">"minimum"</span>:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="s2">"type"</span>:<span class="w"> </span><span class="s2">"number"</span><span class="o">}</span>,<span class="w"> </span><span class="s2">"schema_path"</span>:<span class="w"> </span><span class="s2">"patternProperties..*.properties.bgp_as.minimum"</span>,<span class="w"> </span><span class="s2">"validator"</span>:<span class="w"> </span><span class="s2">"minimum"</span><span class="o">}]</span>,<span class="w"> </span><span class="s2">"msg"</span>:<span class="w"> </span><span class="s2">"Validation errors were found.\nAt 'patternProperties..*.properties.bgp_as.minimum' 0 is less than the minimum of 1. "</span><span class="o">}</span>
</pre></div>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="bullhorn-18/" class="u-url">Bullhorn #18</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/ansible-collaborative-et-al/">Ansible Collaborative, et al</a>
              </span>
            </p>
            <p class="dateline">
              <a href="bullhorn-18/" rel="bookmark">
                <time class="published dt-published" datetime="2021-01-20T18:30:00Z" itemprop="datePublished" title="2021-01-20 18:30">2021-01-20 18:30</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <div>
<p><img alt="Ansible Bullhorn banner" src="../images/bullhorn-banner-mango.png"></p>
<h3>The Bullhorn</h3>
<p><em>A Newsletter for the Ansible Developer Community</em>
<em>Issue #18, 2021-01-20 (<a href="https://us19.campaign-archive.com/home/?u=56d874e027110e35dea0e03c1&amp;id=d6635f5420">Past Issues</a>)</em></p>
<p>Welcome to the Bullhorn, our newsletter for the Ansible developer community. If you have any questions or content you’d like to share, please reach out to us at the-bullhorn@redhat.com, or comment on this <a href="https://github.com/ansible/community/issues/546">GitHub issue</a>.</p>
</div>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="bullhorn-17/" class="u-url">Bullhorn #17</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/ansible-collaborative-et-al/">Ansible Collaborative, et al</a>
              </span>
            </p>
            <p class="dateline">
              <a href="bullhorn-17/" rel="bookmark">
                <time class="published dt-published" datetime="2021-01-06T17:00:00Z" itemprop="datePublished" title="2021-01-06 17:00">2021-01-06 17:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <div>
<p><img alt="Ansible Bullhorn banner" src="../images/bullhorn-banner-mango.png"></p>
<h3>The Bullhorn</h3>
<p><em>A Newsletter for the Ansible Developer Community</em>
<em>Issue #17, 2021-01-06 (<a href="https://us19.campaign-archive.com/home/?u=56d874e027110e35dea0e03c1&amp;id=d6635f5420">Past Issues</a>)</em></p>
<p>Welcome to the Bullhorn, our newsletter for the Ansible developer community. If you have any questions or content you’d like to share, please reach out to us at the-bullhorn@redhat.com, or comment on this <a href="https://github.com/ansible/community/issues/546">GitHub issue</a>.</p>
</div>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="migrating-to-ansible-collections-webinar-qa/" class="u-url">Migrating to Ansible Collections Webinar</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/andrius-benokraitis/">Andrius Benokraitis</a>
              </span>
            </p>
            <p class="dateline">
              <a href="migrating-to-ansible-collections-webinar-qa/" rel="bookmark">
                <time class="published dt-published" datetime="2020-12-17T00:00:00Z" itemprop="datePublished" title="2020-12-17 00:00">2020-12-17 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Migrating to Ansible Collections (Webinar Q&amp;A)</h2>
<p>Sean Cavanaugh, Anshul Behl and I recently hosted a webinar entitled "Migrating to Ansible Collections".
Here is a link to the <a href="https://www.youtube.com/watch?v=Al1ETaamWmc">on-demand webinar replay</a>.
This webinar was focused on enabling the Ansible Playbook
writers, looking to move to the wonderful world of Ansible Collections
in existing Ansible 2.9 environments and
beyond.</p>
<p>The webinar was much more popular than we expected, so much so we
didn't have enough time to answer all the questions, so we took all the
questions and put them in this blog to make them available to
everyone.</p>
<p><strong>I would like to use Ansible to automate an application using a REST API (for example creating a new bitbucket project). Should I be writing a role or a custom module? And should I then publish that as a Collection?</strong></p>
<p>It depends on how much investment you'd like to make into the module or
role that you develop. For example, creating a role that references the
built-in Ansible URI module can be evaluated versus creating an Ansible
module written in Python. If you were to create a module, it can be
utilized via a role developed by you or the playbook author. Sometimes a
standalone role may be preferred, depending on the exact functionality
or requirements for interfacing with the REST API endpoint. Overall it
is important to keep a clean resource/module mapping, and avoid as much
as an operation/module. There is no right or wrong answer here
unfortunately ("it is in the eyes of the Ansible beholder"), regardless
an Ansible module and/or an Ansible role can be developed and then
included into a Collection for use in Ansible playbooks.  Collections
are the standard way for distributing Ansible Content, which includes
both roles and modules.</p>
<p><strong>When will we be able to install Collections using a requirements.yml file in an offline environment? Roles seem to work with Git repositories as upstream, but for Collections, it does not seem to work yet and I always want to look online to galaxy.ansible.com. That is, can I use a GitHub URL (like in roles)?</strong></p>
<p>You can point the ansible-galaxy CLI client to pull Collections from
different sources, please check out the
<a href="https://docs.ansible.com/ansible/latest/user_guide/collections_using.html#installing-a-collection-from-a-git-repository">following documentation page</a>.
Please note that pulling Collections from GitHub (or other sources)
would not be officially supported as part of the Ansible Automation
Platform. It would be best, even with using Community Collections, to
install from Ansible Galaxy.</p>
<p><strong>Certain modules require additional Python packages, for example pyvmomi for VMware modules. Will Collections at some point be able to include this Python code to make it work?</strong></p>
<p>In the future we will have a containered technology called Ansible
Execution Environments, which is an abstraction layer above Collections,
allowing for operating system-level components to be installed. There
were <a href="https://www.ansible.com/ansiblefest">some talks about this at AnsibleFest</a>, and a
blog talking about Ansible Builder,
but the current answer is venv's but Soon(tm) will be Execution
Environments.</p>
<p><strong>When will ansible-doc be able to show docs for a Collection? Using ansible-doc with a FQCN does not work yet.</strong></p>
<p>ansible-doc works FQCN currently; check the verbose logs to see if
there are some issues discovering the Collection by
ansible-doc.
For example, the following command does
function properly:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>ansible-doc<span class="w"> </span>infoblox.nios_modules.nios_a_record
</pre></div>

<p><strong>How will Ansible Execution Environments work together?</strong></p>
<p>This topic is in a very active development stage at the moment and will
be covered in upcoming blogs, webinars, and docs. Coming soon, but watch
this space for more information.</p>
<p><strong>Any particular resources for network automation? I have been struggling to create playbooks on non-standard network devices. I just feel that the online documentation is lacking from the network side.</strong></p>
<p>Check out our <a href="https://docs.ansible.com/ansible/latest/network/getting_started/index.html">Network Getting Started guide</a>.
The current Ansible connection plug-ins (like <code>network_cli</code>, <code>netconf</code> and <code>httpapi</code>)
have enabled over 75 networking platforms to date. Also, using the
cli_command and cli_config, generic modules could be of help. Take a
look at
<a href="http://github.com/ansible/workshops">github.com/ansible/workshops</a>
and see if that helps your searching. Also, reaching out to the network
device vendor directly may help, as they may have private Ansible
content available.</p>
<p><strong>When will Ansible 2.10 be available for Red Hat Linux via yum?</strong>    </p>
<p>Ansible 2.10 will not be made available in RPM format downstream,
please refer to the following link for more details:
<a href="https://access.redhat.com/articles/5392421">https://access.redhat.com/articles/5392421</a>.</p>
<p><strong>When would Collections be a hard requirement and deprecating the old way (2.9 or earlier)?</strong></p>
<p>2.10 and newer require Collections, but if there was existing content
in 2.9 migrated out, the current playbooks should just work as they are
utilizing the global runtime.yml file as part of the 2.10 distribution.
Hence why we are focusing on 2.9 + Collections to elongate the
transition process.</p>
<p><strong>To future proof can I implement this to 2.9 and use FQCN?</strong></p>
<p>Yes, that should be fine, assuming the Collections were either migrated
from Ansible 2.9 or tested against it if
net-new.</p>
<p><strong>You can also just put collections: cyberark at the top of the playbook, right? Can you show what that looks like?</strong></p>
<p>You would need to specify the specific Cyberark namespace.collection
and not just the Cyberark namespace as you have stated. We also
recommend against using the collections keyword and instead use the
fully qualified collections name (FQCN) instead per task (see notes in
the slides).</p>
<p>Using the <code>collections</code> keyword:</p>
<p><img alt="webinar Q&amp;A blog 1" src="../images/posts/archive/webinar-blog-one.png"></p>
<p>Using the recommended way FQCN (fully qualified Collection name):</p>
<p><img alt="Webinar Q&amp;A blog 2" src="../images/posts/archive/webinar-blog-two.png"></p>
<p><strong>In our environment, we have customers that rely on cli's as the cli's get developed faster, example aws-cli. Do we anticipate vendors like AWS to contribute faster to the Collections side?</strong></p>
<p>The Ansible Engineering team actually maintains all AWS Ansible
content, and typically have a "CLI First" or "API First" mentality, but
in general, participating vendors have been great about updating their
Collections for new features!  One of the goals of Ansible Collections
was for partners and certified content to move faster and asynchronously
from Ansible Automation Platform releases, which means both the
community and customers will get new content
faster.</p>
<p><strong>What site licenses are needed for access to Automation Hub?</strong>  </p>
<p>Any Red Hat Ansible Automation Platform subscription will provide
access to the Automation Hub, and the ability to run a private
Automation Hub in your environment.</p>
<p><strong>When is the Ansible Execution Environment scheduled to be released?</strong>   </p>
<p>Tentatively the middle of next year (2021) as part of the product, but
the pieces will start becoming available in an ongoing fashion
upstream.</p>
<p><strong>If all the modules are being moved out into Collections [ansible.builtin] etc., what is still part of the Base/Core?</strong>   </p>
<p>Well a few modules will still be in there, hence "builtin," but those
still might move async. But there is a lot of code running the actual
Ansible executable including how we do parallelism, constructs like
conditionals, loops, blocks, etc, and much moren. Many of which are
things that a lot of Ansible users don't really interact with (think of
it like an engine in your car).</p>
<p><strong>Is it possible to use multiple versions of a Collection within the same codebase? (ie list the version on the playbook level)</strong></p>
<p>That is not an option currently, you cannot pin the Collection version
in the playbook, this will most likely be ideal when using a venv or
future execution environments.</p>
<p><strong>Can the private Automation Hub be a repo in a binary repo like artifactory or nexus?</strong></p>
<p>No, private Automation Hub leverages the same content types in
cloud.redhat.com. Ansible Collection tarballs built and published to
Automation Hub are decompressed and contents are
shown.</p>
<p><strong>Could I use Ansible Collections on CentOS8?</strong></p>
<p>If Ansible 2.9 is installable on CentOS8 (or any other Linux
distribution), then Collections can be utilized
there.</p>
<p><strong>Would Galaxy be deprecated or still working in the future?</strong> </p>
<p>Galaxy is still the current place to publish and download Community
Ansible Collections!</p>
<p><strong>Ansible 2.9 doesn't support using private repos as placeholders for Collections, correct?</strong></p>
<p>You can use private Automation Hub to point to a self hosted instance
for your Collections and curate and control what your group has access
to.</p>
<p><strong>Is the private Automation Hub standalone or can it be clustered?</strong></p>
<p>It's currently only available as standalone, but may be cluster-enabled
in the future.</p>
<p><strong>How does the FQCN use the Collection and not the regular mapped module (in 2.9)?</strong></p>
<p>FQCN stands for fully qualified collection name and it will always
point to a Collection and not a module inside the standard Ansible 2.9
installation, as they reside in different locations on the Ansible
control node.</p>
<p><strong>What's the difference between Execution Environments and the Container Isolated Groups which are in tech preview in Red Hat Ansible Tower?</strong></p>
<p>Container Isolated Groups use the same execution principles. The
easiest way to think about this is that you can consider container
groups as being built on "Execution Environments v0.1." When Execution
Environments are released, this will become far superior than container
groups.</p>
<p><strong>Is there a means to download the :latest Collection version? Or is that what you get automatically?</strong></p>
<p>Latest version is pulled automatically, but you can specify the exact
version as well. You don't need to use :latest - that's what you get
automatically, assuming it doesn't have something like "-beta" or
prerelease versions (using hyphens) as part of it, which are not
considered GA releases (and skipped).</p>
<p>[<img alt="webinar Q&amp;A blog 3" src="../images/posts/archive/webinar-blog-three.png"></p>
<p><strong>For roles we write ourselves, is there or will there be a way to organize related roles as a Collection?</strong></p>
<p>Multiple roles can be organized inside a Collection today as part of the /roles directory.</p>
<p><strong>Everything I've seen about Collections has been how to use ones (from Galaxy or other sources). Is there any documentation/reference about how to write our own Collection?</strong></p>
<p>Yes! Check out the <a href="https://docs.ansible.com/ansible/latest/dev_guide/index.html">Developer Guide</a></p>
<p><strong>Will Automation Hub contain the official/prominent vendor modules. An example is a NetApp or Dell module.</strong></p>
<p>Yes, it already contains that today, we have a certification program
and we have certified content from a lot of vendors like Dell and
Netapp. Automation Hub contains all supported and Certified Collections,
there is a public KBASE that lists them, please check
<a href="https://access.redhat.com/articles/3642632">https://access.redhat.com/articles/3642632</a>[.</p>
<p><strong>If I choose to take a trial of Ansible Automation Platform, will it allow access to the Automation Hub?</strong></p>
<p>Yes it will as part of the subscription; an Ansible Automation Platform
subscription includes everything to trial, including all components and
connectivity to services on cloud.redhat.com, and the Red Hat Customer
Portal.</p>
<p><strong>Is deleting a Collection from ansible-galaxy CLI coming soon, or do we still have to go into the Collections directory to manually delete it?</strong></p>
<p>Right now, that is the only way to delete a collection.  You can
overwrite a collection using the
<a href="https://docs.ansible.com/ansible/latest/cli/ansible-galaxy.html#cmdoption-ansible-galaxy-collection-init-f">force flag</a>.</p>
<p><strong>Can we install the Collection somewhere besides the default ~/.ansible/collections?</strong></p>
<p>Yes, you can put them anywhere, but make sure the control node knows
where they are in the path. For example: <code>ansible-galaxy install -p /path/to/collections namespace.collection</code> and
<a href="https://docs.ansible.com/ansible/latest/cli/ansible-galaxy.html#cmdoption-ansible-galaxy-collection-install-p">associated documentation</a>.</p>
<p><strong>Can I check the version of an existing Collection on my server?</strong></p>
<p>The <a href="https://docs.ansible.com/ansible/latest/cli/ansible-galaxy.html#collection-list">ansible-galaxy collection list</a>
command provides a list of Collections and versions for Ansible 2.10 and
newer.</p>
<p><strong>For adding a new host in RHV, I had to downgrade the last ansible version to 2.9.13 otherwise it did not work (a known bug by Red Hat). In which 2.9 version will the bug be solved?</strong></p>
<p>Do you have a GitHub issue we can see? We can make sure to follow up.
Bugs are usually tracked on GitHub Ansible project and the conversations
there should help you understand a timeline.</p>
<p><strong>What's the future path for users that have absolutely zero interest in things changing? I have been working toward changing department culture toward an automation friendly way of thinking for a year or two, and this will effectively put me back to square one, if not further back. Change resistant businesses don't like big changes just as they get ready to implement.</strong></p>
<p>We think we have created a win/win scenario
where customers and community members can now use Collections and get
new content faster, while maintaining backwards compatibility with
existing Ansible Automation.  While we encourage folks to start using
Collections and writing Ansible playbooks with FQCNs, there will be a
long period of time before customers are required to use them.  Red Hat
does offer long term support options/offerings, so you are not forced to
change for considerable time. Ansible 2.9 will be supported much longer
than originally planned, for subscribing
customers.</p>
<p><strong>Is there a set of paths that Ansible will check for runtime.yml defined in base ansible?</strong></p>
<p>Redirection rules currently follow a precedence, waterfall between the
following two files:</p>
<ol>
<li>The built-in <code>runtime.yml</code> file as part of the Ansible distribution. In this example, the <a href="https://github.com/ansible/ansible/blob/devel/lib/ansible/config/ansible_builtin_runtime.yml">Ansible 2.10 built-in runtime.yml</a>. This file is consulted first.</li>
<li>The runtime.yml file as part of the actual Collection as the <code>/meta/runtime.yml</code>. This file is consulted next.</li>
</ol>
</div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="bullhorn-16/" class="u-url">Bullhorn #16</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/ansible-collaborative-et-al/">Ansible Collaborative, et al</a>
              </span>
            </p>
            <p class="dateline">
              <a href="bullhorn-16/" rel="bookmark">
                <time class="published dt-published" datetime="2020-12-16T17:00:00Z" itemprop="datePublished" title="2020-12-16 17:00">2020-12-16 17:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <div>
<p><img alt="Ansible Bullhorn banner" src="../images/bullhorn-banner-mango.png"></p>
<h3>The Bullhorn</h3>
<p><em>A Newsletter for the Ansible Developer Community</em>
<em>Issue #16, 2020-12-16 (<a href="https://us19.campaign-archive.com/home/?u=56d874e027110e35dea0e03c1&amp;id=d6635f5420">Past Issues</a>)</em></p>
<p>Welcome to the Bullhorn, our newsletter for the Ansible developer community. If you have any questions or content you’d like to share, please reach out to us at the-bullhorn@redhat.com, or comment on this <a href="https://github.com/ansible/community/issues/546">GitHub issue</a>.</p>
</div>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="introduction-to-ansible-builder/" class="u-url">Introduction to Ansible Builder</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/bianca-henderson/">Bianca Henderson</a>
              </span>
            </p>
            <p class="dateline">
              <a href="introduction-to-ansible-builder/" rel="bookmark">
                <time class="published dt-published" datetime="2020-12-10T00:00:00Z" itemprop="datePublished" title="2020-12-10 00:00">2020-12-10 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Introduction to Ansible Builder</h2>
<p>Hello and welcome to another introductory Ansible blog post, where
we'll be covering a new command-line interface (CLI) tool, Ansible
Builder. Please note that this article will cover some
intermediate-level topics such as containers (Ansible Builder uses
<a href="https://developers.redhat.com/articles/podman-next-generation-linux-container-tools">Podman</a>
by default), virtual environments, and Ansible Content Collections.
If you have some familiarity with those topics, then read on to find out
what Ansible Builder is, why it was developed, and how to use it. </p>
<p>This project is currently in development upstream on
<a href="https://github.com/ansible/ansible-builder">GitHub</a> and is not yet part
of the Red Hat Ansible Automation Platform product.  As with all Red Hat
software, our <a href="https://www.redhat.com/en/our-code-is-open">code is open</a>
and we have an open source development model for our enterprise
software.  The goal of this blog post is to show the current status of
this initiative, and start getting the community and customers
comfortable with our methodologies, thought process, and concept of
Execution Environments.  Feedback on this upstream project can be
provided on GitHub via comments and issues, or provided via the various
methods listed on our website.</p>
<h2>What is Ansible Builder?</h2>
<p>In a nutshell, Ansible Builder is a tool that aids in the creation of
Ansible Execution Environments. To fully understand this, let's step
back and discuss what exactly execution environments are.  </p>
<h3>A Primer on Execution Environments</h3>
<p>Before the concept of Execution Environments came about, the Ansible
Automation Platform execution system was limited to executing jobs under
<a href="https://github.com/containers/bubblewrap">bubblewrap</a> in order to
isolate processes. There were several problems related to this,
including the fact that in the cases of Red Hat OpenShift and
Kubernetes-based deployments, any container running jobs had to run in
privileged mode. In addition to this issue, consuming Ansible Content
Collections was very labor-intensive and users faced a lot of challenges
managing custom Python virtual environments and Ansible module
dependencies. The concept of Execution Environments is the solution to
these problems; simply put, they are container images that can be
utilized as Ansible control nodes. These container images enable the
simplification and automation of outdated processes.</p>
<p>As an example of how useful Execution Environments can be, let's say a
developer writes content for Ansible locally by using container
technology so that they can create portable automation runtimes; these
container images will allow that developer to share pre-packaged
Execution Environment, which can be tested and promoted to production.
This eliminates a lot of manual steps (e.g. creating a Dockerfile from
scratch) and accelerates operations by streamlining development and
deployment.  </p>
<h3>Ansible Builder is a Tool for Building Execution Environments</h3>
<p>To enable developers, contributors, and users to take advantage of this
new concept, Ansible Builder was developed to automate the process of
building Execution Environments.  It does this by using the dependency
information defined in various Ansible Content Collections, as well as
by the user. Ansible Builder will produce a directory that acts as the
build context for the container image build, which will contain the
<code>Containerfile</code>, along with any other files that need to be added to the image.</p>
<h3>Getting Started</h3>
<h4>Installing</h4>
<p>You can install Ansible Builder from the <a href="https://pypi.org/project/ansible-builder/">Python Package Index
(PyPI)</a> or from the main
ansible-builder development branch of the codebase hosted on
<a href="https://github.com/ansible/ansible-builder">GitHub</a>. In your terminal,
simply run:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>ansible-builder
</pre></div>

<p><strong>Note:</strong> Podman is used by default to build images. To use Docker, use
<code>ansible-builder build --container-runtime docker</code>.</p>
<h4>Writing a Definition</h4>
<p>In the world of Ansible Builder, the "definition" is a YAML file that
outlines the Execution Environment's Collection-level dependencies, base
image source, and overrides for specific items within the Execution
Environment. The <code>ansible-builder build</code> command, which we
will discuss in further detail later, takes the definition file as an
input and then outputs the build context necessary for creating an
Execution Environment image, which it then uses to actually build that
image. That same build context can consistently rebuild the Execution
Environment image elsewhere, which enables users to create distributable
working environments for any Collections. </p>
<p>Below is an example of the content that would be in a definition file:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="nt">galaxy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">requirements.yml</span>
<span class="w">  </span><span class="nt">python</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">requirements.txt</span>
<span class="w">  </span><span class="nt">system</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bindep.txt</span>

<span class="nt">additional_build_steps</span><span class="p">:</span>
<span class="w">  </span><span class="nt">prepend</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">RUN pip3 install --upgrade pip setuptools</span>
<span class="w">  </span><span class="nt">append</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN ls -la /etc</span>
</pre></div>

<p><strong>Note:</strong> The build command will default to using a definition file
named <code>execution-environment.yml</code>.
If you want to use a different file, you will need to specify the file
name with the <code>-f</code> (or <code>--file</code>) flag. This file <em>must</em> be a <code>.yml</code>
formatted file.</p>
<p>In the <code>dependencies</code> section of
the definition file above, the entries that would be listed there may be
a relative path from the directory of the Execution Environment
definition's folder, or an absolute path. Below is an example of what
might be contained in a <code>requirements.yml</code> file,
which points to a valid requirements file for the
<code>ansible-galaxy collection install -r</code>... command:</p>
<p><strong>NOTE</strong>: The following collection example is sourced from Automation
Hub on <a href="http://cloud.redhat.com/">cloud.redhat.com</a> and requires a valid
<a href="http://red.ht/try_ansible">Ansible Automation Platform subscription</a>
and an upcoming feature to ansible-builder to access.</p>
<ul>
<li>For more information on using Automation Hub, refer to the <a href="https://docs.ansible.com/ansible/latest/galaxy/user_guide.html#downloading-a-collection-from-automation-hub">user
    guide</a>
</li>
<li>For instructions on how to use an ansible.cfg file with Ansible
    Builder, see the <a href="https://ansible-builder.readthedocs.io/en/latest/definition.html#ansible-config-file-path">documentation
    here</a>
</li>
</ul>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="nt">collections</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redhat.openshift</span>
</pre></div>

<p>The <code>python</code> entry points to a Python requirements file for <code>pip install -r</code>.
For example, the <code>requirements.txt</code> file might contain the following:</p>
<div class="code"><pre class="code literal-block">awxkit&gt;=13.0.0
boto&gt;=2.49.0
botocore&gt;=1.12.249
boto3&gt;=1.9.249
openshift&gt;=0.6.2
requests-oauthlib
</pre></div>

<p>The <a href="https://docs.openstack.org/infra/bindep/readme.html">bindep</a>
requirements file specifies cross-platform requirements, if there are
any.  These get processed by bindep and then passed to dnf (other
platforms are not yet supported as of the publication of this blog
post). An example of the content of a
<code>bindep.txt</code> file is below:</p>
<div class="code"><pre class="code literal-block">subversion [platform:rpm]
subversion [platform:dpkg]
</pre></div>

<p>Additional commands may be specified in the <code>additional_build_steps</code> section, to be executed before the main build steps (<code>prepend</code>) or after (<code>append</code>).
The syntax needs to be either a multi-line string (as shown in the <code>prepend</code> section of the example definition file) or a list (as shown via the example's <code>append</code> section).</p>
<h4>Customizable Options</h4>
<p>Before we run the <code>build</code> command, let's discuss the customizable options you can use alongside
it.  </p>
<p><code>'-f', '--file'</code></p>
<p>This flag points to the specific definition file of the Execution Environment; it will default to <code>execution-environment.yml</code> if a different file name is not specified.</p>
<p><code>'-b', '--base-image'</code></p>
<p>The parent image for the Execution Environment; when not mentioned, it defaults to <code>quay.io/ansible/ansible-runner:devel</code>.</p>
<p><code>'-c', '--context'</code></p>
<p>The directory to use for the build context, if it should be generated in a specific place. The default location is <code>$PWD/context.</code></p>
<p><code>'--container-runtime'</code></p>
<p>Specifies which container runtime to use; the choices are <code>podman</code> (default option) or <code>docker</code>.</p>
<p><code>'--tag'</code></p>
<p>The name for the container image being built; when nothing is specified with this flag, the image will be named <code>ansible-execution-env</code>.</p>
<p>As with most CLIs, adding <code>--help</code> at the end of
any Ansible Builder command will provide output in the form of help text
that will display and explain the options available under any particular
command. Below is an example of a command for looking up help text,
along with its corresponding output:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>ansible-builder<span class="w"> </span>--help
usage:<span class="w"> </span>ansible-builder<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>--version<span class="o">]</span><span class="w"> </span><span class="o">{</span>build,introspect<span class="o">}</span><span class="w"> </span>...

Tooling<span class="w"> </span>to<span class="w"> </span><span class="nb">help</span><span class="w"> </span>build<span class="w"> </span>container<span class="w"> </span>images<span class="w"> </span><span class="k">for</span><span class="w"> </span>running<span class="w"> </span>Ansible<span class="w"> </span>content.<span class="w"> </span>Get
started<span class="w"> </span>by<span class="w"> </span>looking<span class="w"> </span>at<span class="w"> </span>the<span class="w"> </span><span class="nb">help</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>one<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>subcommands.

positional<span class="w"> </span>arguments:
<span class="w">  </span><span class="o">{</span>build,introspect<span class="o">}</span><span class="w">  </span>The<span class="w"> </span><span class="nb">command</span><span class="w"> </span>to<span class="w"> </span>invoke.
<span class="w">    </span>build<span class="w">             </span>Builds<span class="w"> </span>a<span class="w"> </span>container<span class="w"> </span>image.
<span class="w">    </span>introspect<span class="w">        </span>Introspects<span class="w"> </span>collections<span class="w"> </span><span class="k">in</span><span class="w"> </span>folder.

optional<span class="w"> </span>arguments:
<span class="w">  </span>-h,<span class="w"> </span>--help<span class="w">          </span>show<span class="w"> </span>this<span class="w"> </span><span class="nb">help</span><span class="w"> </span>message<span class="w"> </span>and<span class="w"> </span><span class="nb">exit</span>
<span class="w">  </span>--version<span class="w">           </span>Print<span class="w"> </span>ansible-builder<span class="w"> </span>version<span class="w"> </span>and<span class="w"> </span>exit.
</pre></div>

<h4>Start the Build</h4>
<p>Let's see what happens when we run the build command!
The build definition will be gathered from the default <code>execution-environment.yml</code> file as shown below:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="nt">galaxy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">requirements.yml</span>

<span class="nt">additional_build_steps</span><span class="p">:</span>
<span class="w">  </span><span class="nt">prepend</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">RUN pip3 install --upgrade pip setuptools</span>
<span class="w">  </span><span class="nt">append</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN ls -la /etc</span>
</pre></div>

<p>We will be building an image named <code>my_first_ee_image</code> using Docker by running the command below:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>ansible-builder<span class="w"> </span>build<span class="w"> </span>--tag<span class="w"> </span>my_first_ee_image<span class="w"> </span>--container-runtime<span class="w"> </span>docker
Using<span class="w"> </span>python3<span class="w"> </span><span class="o">(</span><span class="m">3</span>.7.7<span class="o">)</span>
File<span class="w"> </span>context/introspect.py<span class="w"> </span>is<span class="w"> </span>already<span class="w"> </span>up-to-date.
Writing<span class="w"> </span>partial<span class="w"> </span>Containerfile<span class="w"> </span>without<span class="w"> </span>collection<span class="w"> </span>requirements
Running<span class="w"> </span>command:
<span class="w">  </span>docker<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>context/Dockerfile<span class="w"> </span>-t<span class="w"> </span>my_first_ee_image<span class="w"> </span>context
Sending<span class="w"> </span>build<span class="w"> </span>context<span class="w"> </span>to<span class="w"> </span>Docker<span class="w"> </span>daemon<span class="w">  </span><span class="m">14</span>.34kB
Step<span class="w"> </span><span class="m">1</span>/3<span class="w"> </span>:<span class="w"> </span>FROM<span class="w"> </span>quay.io/ansible/ansible-runner:devel
devel:<span class="w"> </span>Pulling<span class="w"> </span>from<span class="w"> </span>ansible/ansible-runner
85a0beca2b15:<span class="w"> </span>Pulling<span class="w"> </span>fs<span class="w"> </span>layer
...
e21f0ff5ad71:<span class="w"> </span>Pull<span class="w"> </span><span class="nb">complete</span>
Digest:<span class="w"> </span>sha256:e2b84...
Status:<span class="w"> </span>Downloaded<span class="w"> </span>newer<span class="w"> </span>image<span class="w"> </span><span class="k">for</span><span class="w"> </span>quay.io/ansible/ansible-runner:devel
<span class="w"> </span>---&gt;<span class="w"> </span>6b886a75333f
Step<span class="w"> </span><span class="m">2</span>/3<span class="w"> </span>:<span class="w"> </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>this<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span>
<span class="w"> </span>---&gt;<span class="w"> </span>Running<span class="w"> </span><span class="k">in</span><span class="w"> </span>e9cea402bd67
this<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span>
Removing<span class="w"> </span>intermediate<span class="w"> </span>container<span class="w"> </span>e9cea402bd67
<span class="w"> </span>---&gt;<span class="w"> </span>5d253a1fbd54
Step<span class="w"> </span><span class="m">3</span>/3<span class="w"> </span>:<span class="w"> </span>RUN<span class="w"> </span>cat<span class="w"> </span>/etc/os-release
<span class="w"> </span>---&gt;<span class="w"> </span>Running<span class="w"> </span><span class="k">in</span><span class="w"> </span>788173de3929
<span class="nv">NAME</span><span class="o">=</span>Fedora
<span class="nv">VERSION</span><span class="o">=</span><span class="s2">"32 (Container Image)"</span>
...
<span class="nv">VARIANT</span><span class="o">=</span><span class="s2">"Container Image"</span>
<span class="nv">VARIANT_ID</span><span class="o">=</span>container
Removing<span class="w"> </span>intermediate<span class="w"> </span>container<span class="w"> </span>788173de3929
<span class="w"> </span>---&gt;<span class="w"> </span>df802929c259
Successfully<span class="w"> </span>built<span class="w"> </span>df802929c259
Successfully<span class="w"> </span>tagged<span class="w"> </span>my_first_ee_image:latest
Running<span class="w"> </span>command:
<span class="w">  </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-v<span class="w"> </span>/Users/bhenderson/Documents/GitHub/ansible-builder/context:/context:Z<span class="w"> </span>my_first_ee_image<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span>python3<span class="w"> </span>/context/introspect.py
python:<span class="w"> </span><span class="o">{}</span>
system:<span class="w"> </span><span class="o">{}</span>

Rewriting<span class="w"> </span>Containerfile<span class="w"> </span>to<span class="w"> </span>capture<span class="w"> </span>collection<span class="w"> </span>requirements
Running<span class="w"> </span>command:
<span class="w">  </span>docker<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>context/Dockerfile<span class="w"> </span>-t<span class="w"> </span>my_first_ee_image<span class="w"> </span>context
Sending<span class="w"> </span>build<span class="w"> </span>context<span class="w"> </span>to<span class="w"> </span>Docker<span class="w"> </span>daemon<span class="w">  </span><span class="m">14</span>.34kB
Step<span class="w"> </span><span class="m">1</span>/4<span class="w"> </span>:<span class="w"> </span>FROM<span class="w"> </span>quay.io/ansible/ansible-runner:devel
<span class="w"> </span>---&gt;<span class="w"> </span>6b886a75333f
Step<span class="w"> </span><span class="m">2</span>/4<span class="w"> </span>:<span class="w"> </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>this<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span>
<span class="w"> </span>---&gt;<span class="w"> </span>Using<span class="w"> </span>cache
<span class="w"> </span>---&gt;<span class="w"> </span>5d253a1fbd54
Step<span class="w"> </span><span class="m">3</span>/4<span class="w"> </span>:<span class="w"> </span>RUN<span class="w"> </span>cat<span class="w"> </span>/etc/os-release
<span class="w"> </span>---&gt;<span class="w"> </span>Using<span class="w"> </span>cache
<span class="w"> </span>---&gt;<span class="w"> </span>df802929c259
Removing<span class="w"> </span>intermediate<span class="w"> </span>container<span class="w"> </span>6bd2a824fe4f
<span class="w"> </span>---&gt;<span class="w"> </span>ba254aa08b88
Step<span class="w"> </span><span class="m">4</span>/4<span class="w"> </span>:<span class="w"> </span>RUN<span class="w"> </span>ls<span class="w"> </span>-la<span class="w"> </span>/etc
<span class="w"> </span>---&gt;<span class="w"> </span>Running<span class="w"> </span><span class="k">in</span><span class="w"> </span>aa3d855d3ae7
total<span class="w"> </span><span class="m">1072</span>
drwxr-xr-x<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w">   </span><span class="m">4096</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">28</span><span class="w"> </span><span class="m">13</span>:25<span class="w"> </span>.
...
drwxr-xr-x<span class="w"> </span><span class="m">2</span><span class="w"> </span>root<span class="w"> </span>root<span class="w">   </span><span class="m">4096</span><span class="w"> </span>Jul<span class="w">  </span><span class="m">9</span><span class="w"> </span><span class="m">06</span>:48<span class="w"> </span>yum.repos.d
Removing<span class="w"> </span>intermediate<span class="w"> </span>container<span class="w"> </span>aa3d855d3ae7
<span class="w"> </span>---&gt;<span class="w"> </span>0b386b132825
Successfully<span class="w"> </span>built<span class="w"> </span>0b386b132825
Successfully<span class="w"> </span>tagged<span class="w"> </span>my_first_ee_image:latest
Complete!<span class="w"> </span>The<span class="w"> </span>build<span class="w"> </span>context<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>found<span class="w"> </span>at:<span class="w"> </span>context
</pre></div>

<p>As you can see from the output above, the definition file points to the
specific Collection(s) listed, then builds a container image with all of
the dependencies specified in the metadata.  Output such as:</p>
<div class="code"><pre class="code literal-block">Step<span class="w"> </span><span class="m">2</span>/3<span class="w"> </span>:<span class="w"> </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>this<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span>
<span class="w"> </span>---&gt;<span class="w"> </span>Running<span class="w"> </span><span class="k">in</span><span class="w"> </span>e9cea402bd67
this<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span>
</pre></div>

<p>and</p>
<div class="code"><pre class="code literal-block">Step<span class="w"> </span><span class="m">4</span>/4<span class="w"> </span>:<span class="w"> </span>RUN<span class="w"> </span>ls<span class="w"> </span>-la<span class="w"> </span>/etc
<span class="w"> </span>---&gt;<span class="w"> </span>Running<span class="w"> </span><span class="k">in</span><span class="w"> </span>aa3d855d3ae7
total<span class="w"> </span><span class="m">1072</span>
drwxr-xr-x<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w">   </span><span class="m">4096</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">28</span><span class="w"> </span><span class="m">13</span>:25<span class="w"> </span>.
</pre></div>

<p>shows that the <code>prepend</code> and <code>append</code> steps are also being run correctly.
The following output shows that we indeed did not list any Python or system requirements:</p>
<div class="code"><pre class="code literal-block">python:<span class="w"> </span><span class="o">{}</span>
system:<span class="w"> </span><span class="o">{}</span>
</pre></div>

<h3>Validating with Ansible Runner</h3>
<p>Due to this new tool still being in development, we are taking a
shortcut with our current available set of tools to help us validate
against this. That being said, as of now, <code>ansible-runner</code> is a
command-line utility that has the ability to interact with playbooks. 
Also, since it is a key part of Execution Environments, our validation
for now will be that the content runs as expected.  This will change in
the future; we'll definitely come up with something bigger and better!
So stay tuned. </p>
<p>Now without further ado, let's dive into this...</p>
<p>If you do not have Ansible Runner already installed, you can refer to
its
<a href="https://ansible-runner.readthedocs.io/en/latest/install.html">documentation</a>
for guidance. Below is an example playbook (we'll call it
<code>test.yml</code>) that can be
run via Ansible Runner to ensure that the Execution Environment is
working:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ensure the myapp Namespace exists.</span>
<span class="w">      </span><span class="nt">redhat.openshift.k8s</span><span class="p">:</span>
<span class="w">        </span><span class="nt">api_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</pre></div>

<p>To confirm that the <code>my_first_ee_image</code>
Execution Environment image did indeed get built correctly and will work
with the <code>redhat.openshift</code> Collection, run the command below to execute our
<code>test.yml</code> playbook:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>ansible-runner<span class="w"> </span>playbook<span class="w"> </span>--container-image<span class="o">=</span>my_first_ee_image<span class="w"> </span>test.yml
PLAY<span class="w"> </span><span class="o">[</span>localhost<span class="o">]</span><span class="w"> </span>*************************************************************

TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span><span class="w"> </span>*******************************************************
ok:<span class="w"> </span><span class="o">[</span>localhost<span class="o">]</span>

TASK<span class="w"> </span><span class="o">[</span>Ensure<span class="w"> </span>the<span class="w"> </span>myapp<span class="w"> </span>Namespace<span class="w"> </span>exists.<span class="o">]</span><span class="w"> </span>************************************
changed:<span class="w"> </span><span class="o">[</span>localhost<span class="o">]</span>

PLAY<span class="w"> </span>RECAP<span class="w"> </span>*******************************************************************
Localhost:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">rescued</span><span class="o">=</span><span class="m">0</span><span class="w">  </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span>
</pre></div>

<p>Running the command <code>ansible-runner</code> playbook will indicate to Ansible Runner that we want it to execute a playbook
that's similar to running the command <code>ansible-playbook</code> itself.
However, Ansible Runner has additional advantages over a traditional
<code>ansible-playbook</code> command, one of which is to let us take advantage of the Execution
Environment image and its dependencies, which ultimately allows the
playbook to run. For this specific example, note that we also inherited
the <code>kubeconfig</code> set per the <code>redhat.openshift.k8s</code> module; this <code>kubeconfig</code>
is automatically detected and mounted into the Execution Environment
container runtime (just as many other cloud provider modules and SSH
credentials are) without any additional input needed from the user.</p>
<h3>Distributing</h3>
<p>Execution Environment build contexts (as well as the containers built
from them) can be easily shared via public or private registries.  This
new workflow process allows users to automate tasks that were once more
manual (e.g. container images can be scanned and rebuilt automatically
when vulnerabilities are discovered inside).  The build context,
generated when we ran the <code>ansible-builder</code> command,
can be committed to source control and utilized later without the need
for Ansible Builder, either locally or on another system.</p>
<h4>Push to GitHub</h4>
<p>After an Execution Environment image has been built using Ansible
Builder, all of the build context files can be pushed to GitHub (or any
other version control system) for distribution.  See below for an
example of a repository that hosts everything necessary for re-building
a specific image:</p>
<p><img alt="Ansible Builder Blog one" src="../images/posts/archive/ansible-builder-blog-one.png"></p>
<p><a href="https://www.redhat.com/en/technologies/cloud-computing/quay">Red Hat Quay</a> is a
container image registry that provides storage and enables the building,
distribution, and deployment of containers. Set up an account in quay.io
and select "Create New Repository". A series of choices will be
displayed, starting with what's shown below:</p>
<p><img alt="Ansible Builder blog two" src="../images/posts/archive/ansible-builder-blog-two.png"></p>
<p>From here, you can select your specific GitHub repository (or wherever
you are hosting your image files), then navigate through other settings
such as configuring the build triggers, as well as the specific
Containerfile/Dockerfile and context, amongst other things:</p>
<p><img alt="Ansible builder blog three" src="../images/posts/archive/ansible-builder-blog-three.png"></p>
<p>There are other ways you can also share your Execution Environment
images; the above is just a single example of a streamlined and
easy-to-integrate method.</p>
<h2>Conclusion</h2>
<p>We hope you enjoyed learning about Execution Environments and how to
build them using the new Ansible Builder CLI tool!  In a future version
of Red Hat Ansible Automation Platform, Execution Environments will be
able to be used to run jobs in Ansible Automation Platform, so keep an
eye out for details regarding the next release. For further reading,
please refer to the <a href="https://ansible-builder.readthedocs.io/en/latest/">Ansible Builder documentation</a>,
<a href="https://ansible-runner.readthedocs.io/en/latest/execution_environments.html">Ansible Runner documentation</a>,
and be sure to take a look at the <a href="https://github.com/ansible/ansible-builder">Ansible Builder repo</a> on GitHub.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="using-netbox-for-ansible-source-of-truth/" class="u-url">Using NetBox for Ansible Source of Truth</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/josh-vanderaa/">Josh VanDeraa</a>
              </span>
            </p>
            <p class="dateline">
              <a href="using-netbox-for-ansible-source-of-truth/" rel="bookmark">
                <time class="published dt-published" datetime="2020-12-08T00:00:00Z" itemprop="datePublished" title="2020-12-08 00:00">2020-12-08 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Using NetBox for Ansible Source of Truth</h2>
<p>Here you will learn about NetBox at a high level, how it works to become
a Source of Truth (SoT), and look into the use of the Ansible Content
Collection, which is available on Ansible Galaxy. The goal is to show
some of the capabilities that make NetBox a terrific tool and why you
will want to use NetBox as your network Source of Truth for automation!</p>
<h3>Source of Truth</h3>
<p>Why a Source of Truth? The Source of Truth is where you go to get the
intended state of the device. There does not need to be a single Source
of Truth, but you should have a single Source of Truth per data domain,
often referred to as the System of Record (SoR). For example, if you
have a database that maintains your physical sites that is used by teams
outside of the IT domain, that should be the Source of Truth on physical
sites. You can aggregate the data from the physical site Source of Truth
into other data sources for automation. Just be aware that when it comes
time to collect data, then it should come from that other tool.</p>
<p>The first step in creating a network automation framework is to identify
the Source of Truth for the data, which will be used in future
automations. Oftentimes for a traditional network, the device itself has
been considered the SoT. Reading the configuration off of the device
each time you need a configuration data point for automation is
inefficient, and presumes that the device configuration is as intended,
not simply left there in troubleshooting or otherwise inadvertently
left. When it comes to providing data to teams outside of the network
organization, exposing an API  can help to speed up gathering data
without having to check in with the device first.</p>
<h3>NetBox</h3>
<p>For a Source of Truth, one popular open source choice is NetBox. From
the primary documentation site <a href="https://netbox.readthedocs.io/">netbox.readthedocs.io</a>:</p>
<p>"NetBox is an open source web application designed to help manage and document computer networks".</p>
<p>NetBox is currently designed to help manage your:</p>
<ul>
<li>DCIM (Data Center Infrastructure Management)</li>
<li>IPAM (IP Address Management)</li>
<li>Data Circuits</li>
<li>Connections (Network, console, and power)</li>
<li>Equipment racks</li>
<li>Virtualization</li>
<li>Secrets</li>
</ul>
<p>Since NetBox is an IPAM tool, there are misconceptions at times about
what NetBox is able to do. To be clear, NetBox is not:</p>
<ul>
<li>Network monitoring</li>
<li>DNS server</li>
<li>RADIUS server</li>
<li>Configuration management</li>
<li>Facilities management</li>
</ul>
<h3>Why NetBox?</h3>
<p>NetBox is a tool that is built on many common Python based open source
tools, using Postgres for the backend database and Python Django for the
back-end API and front-end UI. The API is extremely friendly as it
supports CRUD (Create, Read, Update, Delete) operations and is fully
documented with Swagger documentation. The NetBox Collection helps with
several aspects of NetBox including an inventory plugin, lookup plugin,
and several modules for updating data in NetBox.</p>
<p>NetBox gives a modern UI from the point of view of a network
organization to help document IP addressing, while keeping the primary
emphasis on network devices, system infrastructure,  and virtual
machines. This makes it ideal to use as your Source of Truth for
automating.</p>
<p>NetBox itself does not do any scanning of network resources. It is
intended to have humans maintain the data as this is going to be the
Source of Truth. It represents what the environment should look like. </p>
<h3>Ansible Content Collection for NetBox</h3>
<p>You will find the Collection within the netbox-community GitHub organization
(<a href="https://github.com/netbox-community/">github.com/netbox-community/</a>).
Here you find a <a href="https://github.com/netbox-community/netbox-docker">Docker container image</a>,
<a href="https://github.com/netbox-community/devicetype-library">device-type library</a>,
<a href="https://github.com/netbox-community/reports">community generated NetBox reports</a>,
and <a href="https://github.com/netbox-community/netbox">source code for NetBox</a> itself.</p>
<p>If you are unfamiliar with what an Ansible Content Collection is, please
watch this brief <a href="https://youtu.be/WOcqhk7TdYc">YouTube video.</a></p>
<p>The Galaxy link for the Collection is at
<a href="https://galaxy.ansible.com/netbox/netbox">galaxy.ansible.com/netbox/netbox</a>. </p>
<p>The NetBox Collection allows you to get started quickly in adding
information into a NetBox instance. The only requirements are  to supply
an API key and a URL to get started. With this Collection, a base
inventory, and a NetBox environment you are able to get a Source of
Truth populated very quickly. </p>
<p>Let's walk through the base setup to get to a place where you are
starting to use the NetBox Inventory Plugin as your Ansible inventory.
First is the example <code>group_vars/all.yml</code> file that will have the list of
items to be used with the tasks.</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="nt">site_list</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“NYC”</span>
<span class="w">    </span><span class="nt">time_zone</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">America/New_York</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Active</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“CHI”</span>
<span class="w">    </span><span class="nt">time_zone</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">America/Chicago</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Active</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“RTP”</span>
<span class="w">    </span><span class="nt">time_zone</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">America/New_York</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Active</span>
<span class="nt">manufacturers</span><span class="p">:</span><span class="w">  </span><span class="c1"># In alphabetical order</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Arista</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cisco</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Juniper</span>
<span class="nt">device_types</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“ASAv”</span>
<span class="w">    </span><span class="nt">manufacturer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“Cisco”</span>
<span class="w">    </span><span class="nt">slug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“asav”</span>
<span class="w">    </span><span class="nt">part_number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“asav”</span>
<span class="w">    </span><span class="nt">Full_depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“CSR1000v”</span>
<span class="w">    </span><span class="nt">manufacturer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“Cisco”</span>
<span class="w">    </span><span class="nt">slug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“csr1000v”</span>
<span class="w">    </span><span class="nt">part_number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“csr1000v”</span>
<span class="w">    </span><span class="nt">Full_depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“vEOS”</span>
<span class="w">    </span><span class="nt">manufacturer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“Arista”</span>
<span class="w">    </span><span class="nt">slug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“veos”</span>
<span class="w">    </span><span class="nt">part_number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“veos”</span>
<span class="w">    </span><span class="nt">Full_depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“vSRX”</span>
<span class="w">    </span><span class="nt">manufacturer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“Juniper”</span>
<span class="w">    </span><span class="nt">slug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“vsrx”</span>
<span class="w">    </span><span class="nt">part_number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“vsrx”</span>
<span class="w">    </span><span class="nt">Full_depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<span class="nt">platforms</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“ASA”</span>
<span class="w">    </span><span class="nt">slug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“asa”</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“EOS”</span>
<span class="w">    </span><span class="nt">slug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“eos”</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“IOS”</span>
<span class="w">    </span><span class="nt">slug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“ios”</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“JUNOS”</span>
<span class="w">    </span><span class="nt">slug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“junos”</span>
</pre></div>

<p><a href="https://gist.github.com/jvanderaa/c11f42c5dd6247808ec3d1acd8604f02">Example group_vars/all.yml</a></p>
<p>The first step is to create a site. Since NetBox models physical gear,
you install equipment at a physical location. Whether that is in your
own facilities or inside of a cloud, this is a site. The module for this
is the <code>netbox.netbox.netbox_site</code> module.</p>
<p>A task in the playbook may be:</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"TASK</span><span class="nv"> </span><span class="s">10:</span><span class="nv"> </span><span class="s">SETUP</span><span class="nv"> </span><span class="s">SITES"</span>
<span class="w">  </span><span class="nt">netbox.netbox.netbox_site</span><span class="p">:</span>
<span class="w">    </span><span class="nt">netbox_url</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_URL')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">    </span><span class="nt">netbox_token</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_API_KEY')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">    </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">site_list</span><span class="nv"> </span><span class="s">}}"</span>
</pre></div>

<p><a href="https://gist.github.com/jvanderaa/e926451a17284bb6c5ec8cd7daa0c73e">Example: Sites Task</a></p>
<p>The next two pieces are the base to add devices to NetBox. In order to
create a specific device, you also need to have the device type and
manufacturer in your NetBox instance. To do this there are specific
modules available to create them. Platforms will help to identify what
OS the device is. I recommend that you use what your automation platform
is using---something like IOS, NXOS, and EOS are good choices and should
match up to your ansible_network_os choices. These tasks look like the
following:</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"TASK</span><span class="nv"> </span><span class="s">20:</span><span class="nv"> </span><span class="s">SETUP</span><span class="nv"> </span><span class="s">MANUFACTURERS"</span>
<span class="w">      </span><span class="nt">netbox.netbox.netbox_manufacturer</span><span class="p">:</span>
<span class="w">        </span><span class="nt">netbox_url</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_URL')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">netbox_token</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_API_KEY')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">manufacturer</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">manufacturers</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">loop_control</span><span class="p">:</span>
<span class="w">        </span><span class="nt">loop_var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manufacturer</span>

<span class="w">  </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"TASK</span><span class="nv"> </span><span class="s">30:</span><span class="nv"> </span><span class="s">SETUP</span><span class="nv"> </span><span class="s">DEVICE</span><span class="nv"> </span><span class="s">TYPES"</span>
<span class="w">      </span><span class="nt">netbox.netbox.netbox_device_type</span><span class="p">:</span>
<span class="w">        </span><span class="nt">netbox_url</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_URL')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">netbox_token</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_API_KEY')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">device_type.model</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">manufacturer</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">device_type.manufacturer</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">slug</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">device_type.slug</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">part_number</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">device_type.part_number</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">is_full_depth</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">device_type.full_depth</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">device_types</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">loop_control</span><span class="p">:</span>
<span class="w">        </span><span class="nt">loop_var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">device_type</span>
<span class="w">        </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">device_type['model']</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">   </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"TASK</span><span class="nv"> </span><span class="s">40:</span><span class="nv"> </span><span class="s">SETUP</span><span class="nv"> </span><span class="s">PLATFORMS"</span>
<span class="w">      </span><span class="nt">netbox.netbox.netbox_platform</span><span class="p">:</span>
<span class="w">        </span><span class="nt">netbox_url</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_URL')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">netbox_token</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_API_KEY')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">platform.name</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">slug</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">platform.slug</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">platforms</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">loop_control</span><span class="p">:</span>
<span class="w">        </span><span class="nt">loop_var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">platform</span>
<span class="w">        </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">platform['name']</span><span class="nv"> </span><span class="s">}}"</span>
</pre></div>

<p><a href="https://gist.github.com/jvanderaa/de4a57f05d963f9291c3f3a4adbb0f45">Example: Manufacturers, Device Types, and Platforms</a></p>
<p>At this stage you are set to add devices and device information to
NetBox. The following tasks leverage the ansible_facts that Ansible
automatically gathers. So for these particular device types, no
additional parsing/data gathering is required outside of using Ansible
to gather facts. In this example for adding a device, you will notice
<em>custom_fields</em>. A nice extension of NetBox is that if there is not a
field already defined, you can set your own fields and use them within
the tool.</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"TASK</span><span class="nv"> </span><span class="s">100:</span><span class="nv"> </span><span class="s">NETBOX</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">ADD</span><span class="nv"> </span><span class="s">DEVICE</span><span class="nv"> </span><span class="s">TO</span><span class="nv"> </span><span class="s">NETBOX"</span>
<span class="w">      </span><span class="nt">netbox.netbox.netbox_device</span><span class="p">:</span>
<span class="w">        </span><span class="nt">netbox_url</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_URL')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">netbox_token</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_API_KEY')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">device_type</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">ansible_facts['net_model']</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IOS</span><span class="w">  </span><span class="c1"># May be able to use a filter to define in future</span>
<span class="w">          </span><span class="nt">serial</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">ansible_facts['net_serialnum']</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Active</span>
<span class="w">          </span><span class="nt">device_role</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">get_role_from_hostname</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">site</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">“ANSIBLE_DEMO_SITE"</span>
<span class="w">          </span><span class="nt">custom_fields</span><span class="p">:</span>
<span class="w">            </span><span class="nt">code_version</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">ansible_facts['net_version']</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">  </span><span class="w w-Error">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"TASK</span><span class="nv"> </span><span class="s">110:</span><span class="nv"> </span><span class="s">NETBOX</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">ADD</span><span class="nv"> </span><span class="s">INTERFACES</span><span class="nv"> </span><span class="s">TO</span><span class="nv"> </span><span class="s">NETBOX"</span>
<span class="w">      </span><span class="nt">netbox.netbox.netbox_device_interface</span><span class="p">:</span>
<span class="w">        </span><span class="nt">netbox_url</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_URL')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">netbox_token</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_API_KEY')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">item.key</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">form_factor</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">item.key</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">get_interface_type</span><span class="nv"> </span><span class="s">}}"</span><span class="w">  </span><span class="c1"># Define types</span>
<span class="w">          </span><span class="nt">mac_address</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">item.value.macaddress</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">ansible.netcommon.hwaddr</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<span class="w">      </span><span class="nt">with_dict</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">ansible_facts['net_interfaces']</span><span class="nv"> </span><span class="s">}}"</span>
</pre></div>

<p><a href="https://gist.github.com/jvanderaa/b5881c5fa778b0601f494d3b73259c23">Example: Add Devices and Interfaces</a></p>
<p>Once you have the interfaces you can add in IP address information that
is included in the ansible_facts data, I show three steps. First is to
add a temporary interface (TASK 200), then add the IP address (TASK
210), and finally associate the IP address to the device (TASK 220).</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"TASK</span><span class="nv"> </span><span class="s">200:</span><span class="nv"> </span><span class="s">NETBOX</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">Add</span><span class="nv"> </span><span class="s">temporary</span><span class="nv"> </span><span class="s">interface"</span>
<span class="w">      </span><span class="nt">netbox.netbox.netbox_device_interface</span><span class="p">:</span>
<span class="w">        </span><span class="nt">netbox_url</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_URL')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">netbox_token</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_API_KEY')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Temporary_Interface</span>
<span class="w">          </span><span class="nt">form_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Virtual</span>
<span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="w">  </span><span class="w w-Error">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"TASK</span><span class="nv"> </span><span class="s">210:</span><span class="nv"> </span><span class="s">NETBOX</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">ADD</span><span class="nv"> </span><span class="s">IP</span><span class="nv"> </span><span class="s">ADDRESS</span><span class="nv"> </span><span class="s">OF</span><span class="nv"> </span><span class="s">ANSIBLE</span><span class="nv"> </span><span class="s">HOST"</span>
<span class="w">      </span><span class="nt">netbox.netbox.netbox_ip_address</span><span class="p">:</span>
<span class="w">        </span><span class="nt">netbox_url</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_URL')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">netbox_token</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_API_KEY')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">family</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">          </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">ansible_host</span><span class="nv"> </span><span class="s">}}/24"</span>
<span class="w">          </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">active</span>
<span class="w">          </span><span class="nt">interface</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Temporary_Interface</span>
<span class="w">            </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"TASK</span><span class="nv"> </span><span class="s">220:</span><span class="nv"> </span><span class="s">NETBOX</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">ASSOCIATE</span><span class="nv"> </span><span class="s">IP</span><span class="nv"> </span><span class="s">ADDRESS</span><span class="nv"> </span><span class="s">TO</span><span class="nv"> </span><span class="s">DEVICE"</span>
<span class="w">      </span><span class="nt">netbox.netbox.netbox_device</span><span class="p">:</span>
<span class="w">        </span><span class="nt">netbox_url</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_URL')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">netbox_token</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">lookup('ENV',</span><span class="nv"> </span><span class="s">'NETBOX_API_KEY')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">device_type</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">ansible_facts['net_model']</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IOS</span>
<span class="w">          </span><span class="nt">serial</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">ansible_facts['net_serialnum']</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Active</span>
<span class="w">          </span><span class="nt">primary_ip4</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">ansible_host</span><span class="nv"> </span><span class="s">}}/24"</span>
</pre></div>

<p><a href="https://gist.github.com/jvanderaa/5d890fc7906390e1dfdc01d297336965">Example: Add temp interface, add IP address, re-add device with the IP address associated</a></p>
<h3>Ansible Inventory Source</h3>
<p>At this point you have NetBox populated with all of your devices that
were in your static inventory. It is now time to make the move to using
NetBox as the Source of Truth for your Ansible dynamic inventory plugin.
This way you don't have to keep finding all of the projects that need to
get updated when you make a change to the environment. You just need to
change your Source of Truth database - NetBox.</p>
<p>You define which inventory plugin to use with a YAML file that defines
the characteristics of how to configure your intended use of the plugin.
Below is an example, showing you are able to query many components of
NetBox for use within your Ansible inventory. You may wish to only make
an update to your access switches? Use the query_filters key to define
what NetBox API searches should be executed. Take a look at the plugin
documentation for updated supported parameters on
<a href="https://github.com/netbox-community/ansible_modules">GitHub</a> or
<a href="https://netbox-ansible-collection.readthedocs.io/en/latest/">ReadTheDocs</a>.
The compose key allows you to pass in additional variables to be used by
Ansible, as such the platform from above would be used with the
ansible_network_os key. This is where you see the definition and what
would get passed from the inventory source.</p>
<p>This definition also has groups created based on the device_roles that
are defined in NetBox and the platforms. So you would be able to access
all platforms_ios devices or platforms_eos as an example, based on the
information in the Source of Truth.</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netbox.netbox.nb_inventory</span>
<span class="nt">api_endpoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://netbox03</span>
<span class="nt">validate_certs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">config_context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">group_by</span><span class="p">:</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">device_roles</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">platforms</span>
<span class="nt">compose</span><span class="p">:</span>
<span class="w"> </span><span class="nt">ansible_network_os</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">platform.slug</span>
<span class="nt">query_filters</span><span class="p">:</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">site</span><span class="p">:</span><span class="w"> </span><span class="s">"minnesota01"</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">has_primary_ip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
</pre></div>

<p><a href="https://gist.github.com/jvanderaa/6bc8f36e2ca1e45e4a4e5e61be4de435">Example: netbox_inventory.yml</a></p>
<h3>Extending NetBox with Plugins</h3>
<p>One of the more recent feature additions to NetBox itself is the ability
to extend it via your own or community driven plugins. From the wiki:</p>
<p>"Plugins are packaged Django apps that can be installed alongside NetBox to provide custom functionality not present in the core application"</p>
<p>https://github.com/netbox-community/netbox/wiki/Plugins</p>
<p>You can find some of the featured plugins in the community at that link. Some include:</p>
<ul>
<li><a href="https://github.com/sjm-steffann/netbox-ddns">Dynamic DNS Connector</a></li>
<li><a href="https://github.com/networktocode/ntc-netbox-plugin-onboarding">NetBox Onboarding Plugin (from Network to Code) - This will read
    additional information about the device and make updates to
    NetBox</a></li>
<li><a href="https://github.com/k01ek/netbox-qrcode">NetBox QR Code - Generate QR Codes about the
    device</a></li>
<li><a href="https://github.com/jeremyschulman/netbox-plugin-auth-saml2">SSO using
    SAML2</a></li>
</ul>
<p>There are many plugins available to the community for you to choose
from---or you can write your own add ons!</p>
<p>Search <a href="https://github.com/topics/netbox-plugi">https://github.com/topics/netbox-plugi</a> for the topic <em>NetBox Plugin.</em></p>
<h3>Summary</h3>
<p>NetBox and Ansible together are a great combination for your network
automation needs!</p>
<p>NetBox is an excellent open source tool that helps make it easy to
create, update, and consume as a Source of Truth. The APIs are easy to
use and make updates to the DB with, even if you did not want to use the
NetBox Collection available for Ansible. Having a tool that is flexible,
capable, and accurate is a must for delivering automation via a Source
of Truth. NetBox delivers on each of these. </p>
<p>This post was inspired by a presentation done in March 2020 at the
Minneapolis Ansible Meetup. For additional material on this, I have many
of these tasks available as a working example on
<a href="https://github.com/jvanderaa/ansible_netbox_demo">ansible_netbox_demo</a>. The YouTube
recording of the presentation from the <a href="https://www.youtube.com/watch?v=GyQf5F0gr3w">Ansible Meetup is available</a>.  </p>
          </div>
      </article><br><hr>
<br>
</div>
          <ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-10.html" rel="prev">Newer posts</a></li>
            <li class="next"><a href="index-8.html" rel="next">Older posts</a></li>
        </ul>
<!--End of body content-->
</div>
        <div class="content-slim redhat-footer">
      <div class="footer-left">
        <ul class="footer-left-links">
<li>
            <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a>
          </li>
          <li>
            <a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy policy</a>
          </li>
          <li>
            <a href="https://docs.ansible.com/ansible/latest/community/code_of_conduct.html" target="_blank">Code of conduct</a>
          </li>
        </ul>
</div>
      <div class="footer-right">
        <span class="redhat">Powered by</span>
        <span class="redhat-logo">
          <a href="https://www.redhat.com/en/technologies/management/ansible" target="_blank">
            <img src="../assets/images/redhat_reversed.svg" alt="Red Hat logo." width="96" height="28"></a>
        </span>
      </div>
    </div>

</div>

            <script src="../assets/js/jquery.min.js"></script><script src="../assets/js/popper.min.js"></script><script src="../assets/js/bootstrap.min.js"></script><script src="../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script><script src="../assets/js/clipboard.min.js" type="text/javascript"></script><script src="../assets/js/clipboard.js" type="text/javascript"></script>
</body>
</html>
