<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Ansible Collaborative Website">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ansible Collaborative (old posts, page 3) | Ansible Collaborative</title>
<link href="../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<!-- Red Hat fonts --><link rel="stylesheet" href="https://static.redhat.com/libs/redhat/redhat-font/2.0.0/webfonts/red-hat-font.css">
<!-- Font Awesome --><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
<!-- Fork Awesome --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css" integrity="sha256-XoaMnoYC5TH6/+ihMEnospgm0J1PM/nioxbOUdnM8HY=" crossorigin="anonymous">
<!-- Sass compiled css  --><link rel="stylesheet" href="../assets/css/main.css">
<link rel="stylesheet" href="../assets/css/redhat-footer.css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://ansible.com/blog/index-3.html">
<link rel="prev" href="index-4.html" type="text/html">
<link rel="next" href="index-2.html" type="text/html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]-->
</head>
<body id="top">

<div class="global-container" id="content" role="main">
<!-- Start menubar -->
<nav class="navbar navbar-expand-lg static-top mb-4 navbar-padding full-width-bg   navbar-dark   bg-pool   "><div class="masthead">
    <!-- This keeps the margins nice -->
    <a class="navbar-brand" href="../">
        <img src="../images/ansible_logo-small-15.png" alt="Ansible community logo" id="logo" class="d-inline-block align-top" width="50" height="50"></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon nav-toggle-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="bs-navbar">
      <ul class="navbar-nav mr-auto"></ul>
<ul class="navbar-nav navbar-right">
<li class="nav-item dropdown">
	        <a href="#" class="nav-link nav-link-color dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		    <i class=""></i> Documentation
                </a>
		<div class="dropdown-menu dropdown-menu-border">
	    
                    <a href="https://docs.ansible.com/" class="dropdown-item">
		        <i class=""></i> Project documentation
                    </a>
                    <a href="https://access.redhat.com/documentation/en-us/red_hat_ansible_automation_platform/" class="dropdown-item">
		        <i class=""></i> Ansible Automation Platform documentation
                    </a>
            </div>
                 </li>
<li class="nav-item">
		     <a href="https://galaxy.ansible.com/" target="_blank" class="nav-link nav-link-color">
		         <i class=""></i> Galaxy
		     </a>
		 </li>
                 <li class="nav-item">
		     <a href="https://forum.ansible.com/" target="_blank" class="nav-link nav-link-color">
		         <i class=""></i> Forum
		     </a>
		 </li>
            <li class="nav-item dropdown">
	        <a href="#" class="nav-link nav-link-color dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		    <i class=""></i> Resources
                </a>
		<div class="dropdown-menu dropdown-menu-border">
	    
                    <a href="../how-ansible-works/" class="dropdown-item">
		        <i class=""></i> How Ansible works
                    </a>
                    <a href="../ecosystem/" class="dropdown-item">
		        <i class=""></i> Ansible ecosystem
                    </a>
                    <a href="archive.html" class="dropdown-item">
		        <i class=""></i> Blog
                    </a>
                    <a href="../faq/" class="dropdown-item">
		        <i class=""></i> Frequently asked questions
                    </a>
                    <a href="../ansible-community-training/" class="dropdown-item">
		        <i class=""></i> Ansible community training
                    </a>
                    <a href="../contact-us/" class="dropdown-item">
		        <i class=""></i> Contact us
                    </a>
            </div>
                 </li>
<li class="nav-item">
		     <a href="https://www.redhat.com/en/technologies/management/ansible?sc_cid=7015Y000003szaKQAQ" target="_blank" class="nav-link nav-link-color">
		         <i class=""></i> Ansible Automation Platform
		     </a>
		 </li>

        
      </ul>
</div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav><!-- End default Menubar --><div class="body-content center-band">
        <!--Body content-->
        
    
  <div class="postindex ansible-content">
      <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="thoughts-on-restructuring-the-ansible-project/" class="u-url">Thoughts on Restructuring the Ansible Project</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/the-ansible-community-team/">The Ansible Community Team</a>
              </span>
            </p>
            <p class="dateline">
              <a href="thoughts-on-restructuring-the-ansible-project/" rel="bookmark">
                <time class="published dt-published" datetime="2019-07-23T00:00:00Z" itemprop="datePublished" title="2019-07-23 00:00">2019-07-23 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Thoughts on Restructuring the Ansible Project</h2>
<p>Ansible became popular largely because we adopted some key principles
early, and stuck to them.</p>
<p>The first key principle was simplicity: simple to install, simple to
use, simple to find documentation and examples, simple to write
playbooks, and simple to make contributions.</p>
<p>The second key principle was modularity: Ansible functionality could be
easily extended by writing modules, and anyone could write a module and
contribute it back to Ansible.</p>
<p>The third key principle was "batteries included": all of the modules for
Ansible would be built-in, so you wouldn't have to figure out where to
get them. They'd just be there.</p>
<p>We've come a long way by following these principles, and we intend to
stick to them.</p>
<p>Recently though, we've been reevaluating how we might better structure
Ansible to support these principles. We now find ourselves dealing with
problems of scale that are becoming more challenging to solve. Jan-Piet
Mens, who has continued to be a close friend to Ansible since our very
earliest days, recently described those problems <a href="https://jpmens.net/2019/06/21/i-care-about-ansible/">quite
succinctly</a> from
his perspective as a long-time contributor -- and I think his analysis
of the problems we face is quite accurate. Simply, we've become victims
of our own success.</p>
<p>Success means growth, and growth means more users, more customers, more
contributors, and more responsibilities -- whichÂ  bring increases in
complexity. We've continued to build tools like
<a href="https://github.com/ansible/ansibullbot">Ansibot</a> to help us manage that
complexity, but as we continue towards hyperscale, even as we merge more
and more community code, we're seeing more pull requests and issues fall
through the cracks.</p>
<p>Consider the following visual representation of the evolution of contributions to the Ansible project:</p>
<p><img alt="visual representation of the evolution of contributions to the Ansible project" src="../images/posts/archive/evolution-of-contributions.gif"></p>
<p>Most of our current challenges stem from <strong>increased complexity that our
simple model was not built to handle</strong>. If we want to break through our
current constraints, we're going to need to build a new organizational
model to do it.</p>
<p>That's exactly what we've been working on -- and it's taking some time,
because it's a complex set of challenges -- but we're getting there.</p>
<p>So let's discuss some of our key challenges.</p>
<p>First, there's the <strong>growing support challenge</strong>.</p>
<p>Originally, Ansible had a simple policy: if we shipped it, we supported
it. In the very beginning, this policy made perfect sense; we had
comparatively few modules, and we also had comparatively few customers.
The Ansible support team knew all of the modules well enough to provide
support for all of them, to anyone who was willing to pay for that
support.</p>
<p>In truth, though, supporting modules ourselves can be a tricky
proposition, and the larger we grow, the trickier it becomes. The
majority of our modules are <a href="https://docs.ansible.com/ansible/latest/modules/community_maintained.html">community
maintained</a>.
We obviously know Ansible itself very well, but we don't know the
community maintained modules as well as our contributors do. In some
cases, we may not even have access to the underlying software or
hardware with which the modules interface; in such cases we are
completely reliant upon our community to keep the modules working.</p>
<p>Some of our community maintainers are exceptionally responsive. Some are
less responsive. That's the nature of community developed software. But
because all of the modules live in the same place, and are a part of our
"batteries included" model, many people -- including paying customers
-- don't realize that such a distinction exists.</p>
<p>It's unfair for us to place an enterprise support burden on volunteer
contributors. It's also important that we're as clear as possible with
our customers about what is fully supported as part of their
subscription, and what is not.</p>
<p>Next, there's <strong>the lifecycle challenge</strong>.</p>
<p>As Ansible itself becomes more mature and used by more enterprise
customers, the lifecycle of Ansible is slowing down. Even until fairly
recently, we would cut a major release of Ansible every four months, but
our most recent release cycle was eight months, and that slower release
cycle will become the rule.</p>
<p>This is a challenge because it means that over time it will take longer
for new code to reach users. This will be especially constraining for
our partners; under the current structure, they can only update their
modules and plug-ins on our schedule. We've already received feedback
from many partners that they want the ability to release their own
modules and plugins independently of our release cycle, and as our
release cycle continues to slow down, we expect these calls to grow
louder.</p>
<p>Then, there's <strong>the challenge of the rising bar</strong>.</p>
<p>Everyone, both partners and community, want modules to be ever better:
better written, better tested, more secure. With every release, we try
to raise the quality bar.</p>
<p>For the upcoming Ansible 2.9 release, for instance, we expect soon to be
asking contributors <a href="https://github.com/ansible/ansible/issues/57699">to provide basic integration
tests</a> for every
module.</p>
<p>That rising bar comes with its own challenges. How do we handle
contributions that have previously been good enough, but no longer meet
the new standards? How do we deal with contributors who are not
necessarily able or willing to do the work necessary to reach these
standards? What do we do about existing modules that don't keep up with
our rising quality standard -- do we mark them in some way, or do we
kick them out of Ansible entirely, even if they're relatively stable
modules that a lot of people depend upon? We continue to grapple with
these questions.</p>
<p>Which brings us to the <strong>new module contributor challenge</strong>.</p>
<p><img alt="graph of survival curves for Ansible PRs in the past year" src="../images/posts/archive/ansible-survival-curves.png"></p>
<p><em>the average merge time for PRs. New Modules (blue) vs everything else
(Red). Notice that over the past year, on average 80% of non-new-module
PRs are merged within 22.4 days.</em></p>
<p>As the quality bar goes up, our ability to bring new contributors
onboard goes down -- or at least slows down. It just takes contributors
more time and effort to get their new modules accepted than it once did.</p>
<p>It's comparatively easy to bring in PRs to extant modules, because those
modules generally have maintainers that have earned our collective
trust. Our PR merge numbers for extant modules are actually quite good
(we can always improve, of course).</p>
<p>But new modules require a higher degree of vetting, because we're not
only vetting the code, we're also implicitly vetting the contributors of
that code for their interest and ability to maintain that code.</p>
<p>Given our current structure, this is an unfortunate but necessary
barrier. Our support challenge makes us more reluctant to merge new
modules without strong assurances that the maintainer will be willing
and able to maintain those modules to increasingly stringent
requirements.</p>
<p>At the heart of all of these challenges is the fact that we've got one
code base that's supporting two categories of participants that have
different primary interests.</p>
<p>Enterprise users and partners need, more than anything, a stable and
well supported platform that they can trust to automate their IT
infrastructure.</p>
<p>But our community users and contributors need something else, and that's
what Ansible has always delivered in the past: an easy way to install
Ansible, and easy ways to contribute to Ansible.</p>
<p>To those of us who lived through the old days at Red Hat, these problems
are eerily similar to the problems we experienced around the original
Red Hat Linux product -- problems that led to the creation of the
Fedora Project and Red Hat Enterprise Linux. Our problems aren't
identical, but similar.</p>
<p>Which is why we believe that the solutions should be not identical, but
similar.</p>
<p>So let's talk about <strong>our proposal to solve some of these challenges</strong>.</p>
<p>From <strong>a development perspective</strong>, Ansible would be <strong>broken out into
different components</strong>:</p>
<ul>
<li>
<p>The <strong>core engine</strong>, which would essentially be the platform to run
everything else. Keeping this engine stable, more secure, and
well-tested will be critically important for everyone. The Core Team
would be responsible for maintaining this engine. Community contribution
policies would be the same as present policies.</p>
</li>
<li>
<p>The <strong>core modules and plugins</strong>, which are the modules and plugins
that the Ansible team would support directly. These would be the most
used modules and plugins (think template, copy, lineinfile, and so on.)
Community contribution policies would be the same as present policies,
though no new modules would be introduced.</p>
</li>
<li>
<p>The <strong>community modules and plugins</strong>, which would be where most
non-core modules and plugins would live. Community contribution policies
would be relaxed to some degree, to help onboard new content and new
contributors, but we would still maintain a bar of quality to help
ensure that community content would be functional, documented, and
usable. The separate structure would allow the community to be much more
effectively involved in the curation process.</p>
</li>
<li>
<p>Various supported <strong>partner modules and plugins</strong>, which would be
broken out and managed more directly by partners. Community contribution
policies would be up to the discretion of the individual partners.</p>
</li>
</ul>
<p>All of these different components would be built in the form of
<strong>Ansible Content Collections</strong>, which we first introduced in Ansible
2.8.</p>
<p>From a <strong>deployment perspective</strong>, Ansible would be delivered in one of
two fundamental ways:</p>
<ul>
<li>
<p>A <strong>batteries-included method</strong>, which would be very similar to how
Ansible is delivered currently: a bundling of the core engine, all of
the core modules and plugins, all of the community modules and plugins,
and select partner modules and plugins, all via collections. There would
be no official Red Hat support offered for this method.</p>
</li>
<li>
<p>A <strong>supported enterprise method</strong>, which would be only the fully
supported subset of that content: the core modules and plugins, and
select partner modules and plugins, all via collections. This would be
the method that would be supported by Red Hat as part of the Red Hat
Ansible Automation product. Customers would retain the ability to
install and use any additional content at their discretion, but the
separation between Red Hat supported content and non-Red Hat supported
content would be much more explicit.</p>
</li>
</ul>
<p>Both of these methods would depend heavily on Ansible Galaxy as the de
facto delivery mechanism, which we would plan to improve substantially
to handle the increased traffic load.</p>
<p>Some may note that there are similarities between this new proposed
structure and the <a href="https://github.com/ansible/ansible-modules-extras">Ansible Extras</a> structure
that we moved to, and then <a href="https://docs.ansible.com/ansible/2.6/dev_guide/repomerge.html">moved away from</a>, a
few years back. It's true; there are definite similarities, and many of
the advantages and potential disadvantages are the same. It's our hope,
and intention, to learn the lessons from that previous attempt to gain
the advantages while also mitigating the potential disadvantages.</p>
<p>We believe that these structural changes will help Ansible keep our
strong community focus, while also providing the structure necessary to
support our growing base of partners and customers. We recognize that
these are significant changes, which is why we plan to move very
carefully towards them. We want to make sure that we understand the
implications of these changes before we make them. None of these changes
are imminent, but we believe that we've come to a point at which we are
prepared to discuss the possibilities.</p>
<p>There are many questions yet to be answered: infrastructure questions,
licensing questions, release policy questions, and others. We will be
discussing some of those questions in an upcoming webinar.Â </p>
<p>We will also be digging deeply into these questions at our community
contributor conference at AnsibleFest Atlanta in September. We hope to
see our contributors there in person, but we strive for <a href="https://etherpad.openstack.org/p/ansible-summit-atlanta-2019">full remote participation</a>
as well, as always. Please join us however you can.</p>
<p>In the early days of Ansible, we could only have dreamt of this kind of
success. In our seven years of existence, we have built
<a href="https://octoverse.github.com/projects">one of the top open source projects in the world</a>, with a dedicated
community pushing us and supporting us from the very beginning. Had we
imagined the kinds of challenges we face today, we would surely have put
them in the category of "good problems to have."</p>
<p>But "good problems" are still problems, and if we fail to solve them,
they won't stay "good problems" for long. It's time for us to take the
next step, so that we can continue to be a reliable partner for all of
our users, customers, and contributors. Without all of you, we would
never have made it nearly so far.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="ansible-servicenow-part-2-parsing-facts-from-network-devices-using-pyats/genie/" class="u-url">Ansible and ServiceNow Part 2</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/colin-mccarthy/">Colin McCarthy</a>
              </span>
            </p>
            <p class="dateline">
              <a href="ansible-servicenow-part-2-parsing-facts-from-network-devices-using-pyats/genie/" rel="bookmark">
                <time class="published dt-published" datetime="2019-07-19T00:00:00Z" itemprop="datePublished" title="2019-07-19 00:00">2019-07-19 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Parsing facts from network devices using PyATS/Genie</h2>
<p>This blog is part two in a series covering how Red Hat Ansible
Automation can integrate with ticket automation. This time we'll cover
dynamically adding a set of network facts from your switches and routers
and into your ServiceNow tickets.</p>
<p>Suppose there was a certain network operating system software version
that contained an issue you knew was always causing problems and making
your uptime SLA suffer. How could you convince your management to
finance an upgrade project? How could you justify to them that the fix
would be well worth the cost? Better yet, how would you even know?</p>
<p>A great start would be having metrics that you could track. The ability
to data mine against your tickets would prove just how many tickets were
involved with hardware running that buggy software version. In this
blog, I'll show you how to automate adding a set of facts to all of your
tickets going forward. Indisputable facts can then be pulled directly
from the device with no chance of mistakes or accidentally being
overlooked and not created.</p>
<p>This blog post will demonstrate returning structured data in JSON using
Ansible in conjunction with Cisco pyATS and Cisco Genie. This allows us
to retrieve the output from operational show commands and convert them
in any format we want, in this case pushing them into ServiceNow.</p>
<p>There are many ways to parse facts from network devices with Ansible.
The following blog example could also all be done via the open source
<a href="https://galaxy.ansible.com/ansible-network/network-engine">Network Engine Ansible Role</a>, but
for this example we are using Cisco's sponsored pyATS/Genie
implementation to parse the following show version command. As you can
see this is not very friendly to programmatically interact with:</p>
<p><img alt="image7" src="../images/posts/archive/image7.png"></p>
<h3>Step 1: Create a Python3 virtual environment in Red Hat Ansible Tower</h3>
<p>With the release of Ansible Tower 3.5, we can now use Python 3 virtual
environments (virtualenv) for added playbook flexibility and
compatibility across Python versions. This is great news because Python3
is required to use the pyATS and Genie packages. We need to create a new
(virtualenv) that is running Python3 and install all of the
dependencies.</p>
<div class="code"><pre class="code literal-block">su<span class="w"> </span>-
yum<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>rh-python36
yum<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>python36-devel<span class="w"> </span>gcc
scl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>rh-python36<span class="w"> </span>bash
python3.6<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>/var/lib/awx/venv/pyats-sandbox
<span class="nb">source</span><span class="w"> </span>/var/lib/awx/venv/pyats-sandbox/bin/activate
<span class="nb">umask</span><span class="w"> </span><span class="m">0022</span>
pip<span class="w"> </span>install<span class="w"> </span>pyats<span class="w"> </span>genie<span class="w"> </span>python-memcached<span class="w"> </span>psutil<span class="w"> </span>pysnow<span class="w"> </span>paramiko
pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span><span class="s2">"ansible == 2.8</span>
</pre></div>

<p>Once a custom virtualenv is created a new field appears in the Job
Templates section in Ansible Tower. You can select your newly created
venv from the following dropdown
menu:<img alt="image1-6" src="../images/posts/archive/image1-6.png"></p>
<p>Cisco has released two Python3 packages that are very useful for network
automation - pyATS, and Genie. The first one, pyATS, functions as a
python framework while Genie builds on top of it. Genie can be used to
parse, learn, and diff. Implementing Genie is accomplished by installing
and calling the Galaxy role in our playbook named parse_genie.</p>
<h3>Step 2: Create a requirements.yml file in your roles directory</h3>
<p><code>roles/requirements.yml</code></p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parse_genie</span>
<span class="w">  </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/clay584/parse_genie</span>
<span class="w">  </span><span class="nt">scm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git</span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">master</span>
</pre></div>

<p>By default, Ansible Tower has a system-wide setting that allows roles to
be dynamically downloaded via a requirements.yml file in your Git repo.
So there is no need to run the
<code>ansible-galaxy install -r roles/requirements.yml</code> command like you
might do if using Ansible Engine on the CLI.</p>
<p>For more information about Projects in Ansible Tower, <a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/projects.html">refer to the
documentation</a>.</p>
<h3>Step 3: Call the parse_genie Ansible Role</h3>
<p>Now that you have a Python 3 virtualenv in Tower and a
roles/requirements.yml file, you can write and test a playbook. In the
first play of the playbook, define the name, hosts identified for
Ansible to run against, the connection plugin and disabling gather_facts
for network devices. Next, create a roles: section and invoke the
parse_genie role:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parser example</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ios</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">network_cli</span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parse_genie</span>
</pre></div>

<p>Then create the tasks: section and add a show version task. This will
execute the show version command via the ios_command module, then store
the output to a variable named version.</p>
<div class="code"><pre class="code literal-block"><span class="nt">tasks</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show version</span>
<span class="w">  </span><span class="nt">ios_command</span><span class="p">:</span>
<span class="w">    </span><span class="nt">commands</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show version</span>
<span class="w">    </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">version</span>
</pre></div>

<p>The next tasks will apply the parse_genie filter plugin to create
structured data out of the show version command we executed. As well as
set the structured data as a fact and debug it.</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set Fact Genie Filter</span>
<span class="w">  </span><span class="nt">set_fact</span><span class="p">:</span>
<span class="w">    </span><span class="nt">pyats_version</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">version['stdout'][0]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">parse_genie(command='show</span><span class="nv"> </span><span class="s">version',</span><span class="nv"> </span><span class="s">os='ios')</span><span class="nv"> </span><span class="s">}}"</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Debug Genie Filter</span>
<span class="w">  </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">    </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pyats_version</span>
</pre></div>

<h3>Step 4: Run the Ansible Playbook</h3>
<p>At this point the playbook is largely complete and you can execute and
then test it.</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parser example</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ios</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">network_cli</span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parse_genie</span>

<span class="nt">tasks</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show version</span>
<span class="w">  </span><span class="nt">ios_command</span><span class="p">:</span>
<span class="w">    </span><span class="nt">commands</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show version</span>
<span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">version</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set Fact Genie Filter</span>
<span class="w">  </span><span class="nt">set_fact</span><span class="p">:</span>
<span class="w">    </span><span class="nt">pyats_version</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">version['stdout'][0]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">parse_genie(command='show</span><span class="nv"> </span><span class="s">version',</span><span class="nv"> </span><span class="s">os='ios')</span><span class="nv"> </span><span class="s">}}"</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Debug Genie Filter</span>
<span class="w">  </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">    </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pyats_version</span>
</pre></div>

<p>The parser takes the command output and creates a structured data in
JSON format. The facts that you want to use later in your playbook, are
now easily accessible.</p>
<h3>Step 5: Validate the Ansible Playbook run</h3>
<p>After running the playbook (we did it via Ansible Tower), the following
is the debug Genie Filter Task from playbook
run:</p>
<p><img alt="image6-2" src="../images/posts/archive/image6-2.png"></p>
<p>The full output:</p>
<div class="code"><pre class="code literal-block"><span class="err">TASK</span><span class="w"> </span><span class="p">[</span><span class="err">Debug</span><span class="w"> </span><span class="err">Ge</span><span class="kc">n</span><span class="err">ie</span><span class="w"> </span><span class="err">Fil</span><span class="kc">ter</span><span class="p">]</span><span class="w"> </span><span class="err">******************************************************</span>

<span class="err">ok</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">192.168.161.9</span><span class="p">]</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"msg"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">"version"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">"chassis"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WS-C3550-24"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"chassis_sn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CAT0651Z1E8"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"curr_config_register"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0x10F"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"hostname"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nco-rtr-9"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"image_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"C3550-IPSERVICESK9-M"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"image_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"developer image"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"last_reload_reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"warm-reset"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"main_mem"</span><span class="p">:</span><span class="w"> </span><span class="s2">"65526"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"number_of_intfs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">"FastEthernet"</span><span class="p">:</span><span class="w"> </span><span class="s2">"24"</span><span class="p">,</span>
<span class="w">                </span><span class="nt">"Gigabit Ethernet"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">"os"</span><span class="p">:</span><span class="w"> </span><span class="s2">"C3550 boot loader"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"platform"</span><span class="p">:</span><span class="w"> </span><span class="s2">"C3550"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"processor_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PowerPC"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"rom"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bootstrap program is C3550 boot loader"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"rtr_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WS-C3550-24"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"system_image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"flash:c3550-ipservicesk9-mz.122-44.SE3/c3550-ipservicesk9-mz.122-44.SE3.bin"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"uptime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"44 minutes"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"12.2(44)SE3"</span><span class="p">,</span>
<span class="w">            </span><span class="nt">"version_short"</span><span class="p">:</span><span class="w"> </span><span class="s2">"12.2"</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h3>Step 6: Integrate parsed content into ServiceNow tickets</h3>
<p>What I would like to do now is add some new fields in the ServiceNow
incident layout. Let's add the version, uptime, hostname, platform,
device type, serial number, and last reload reason facts to every
incident ticket Ansible creates.</p>
<p>In the ServiceNow Web dashboard, add these new fields in <strong>Configure &gt; Form Layout</strong>.</p>
<p><img alt="image2-6" src="../images/posts/archive/image2-6.png"></p>
<p>Now when you run your playbook from part one of this blog with the table
parameter set as incident. When you debug the incident.record dictionary
it should now have the new fields you just created, such as
u_device_up_time, u_ios_version, etc.</p>
<p>Snippet of the record dictionary the ServiceNow API sends back:</p>
<p><img alt="image4-3" src="../images/posts/archive/image4-3.png"></p>
<p>We can use these new fields in the data section of our Ansible Playbook
that uses the <a href="https://docs.ansible.com/ansible/latest/modules/snow_record_module.html">snow_record module</a>.
The following is the complete playbook that runs the show version
command, parses the output and adds the parameters into the new fields:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create ticket with notes</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ios</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">network_cli</span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parse_genie</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">include vars</span>
<span class="w">    </span><span class="nt">include_vars</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">incident_vars.yml</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show version</span>
<span class="w">    </span><span class="nt">ios_command</span><span class="p">:</span>
<span class="w">      </span><span class="nt">commands</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show version</span>
<span class="w">    </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">version</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set Fact Genie Filter</span>
<span class="w">    </span><span class="nt">set_fact</span><span class="p">:</span>
<span class="w">      </span><span class="nt">pyats_version</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">version['stdout'][0]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">parse_genie(command='show</span><span class="nv"> </span><span class="s">version',</span><span class="nv"> </span><span class="s">os='ios')</span><span class="nv"> </span><span class="s">}}"</span>

<span class="c1"># Example 1 showing version information</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Debug Pyats facts</span>
<span class="w">    </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">      </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pyats_version.version.version</span>

<span class="c1"># Example 2 showing uptime</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Debug Pyats facts</span>
<span class="w">    </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">      </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pyats_version.version.uptime</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create an incident</span>
<span class="w">    </span><span class="nt">snow_record</span><span class="p">:</span>
<span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<span class="w">      </span><span class="nt">table</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">incident</span>
<span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">sn_username</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">sn_password</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">instance</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">sn_instance</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">data</span><span class="p">:</span>
<span class="w">        </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">sn_priority}}"</span>
<span class="w">        </span><span class="nt">u_device_up_time</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">pyats_version.version.uptime</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">u_ios_version</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">pyats_version.version.version</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">u_hostname</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">pyats_version.version.hostname</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">u_platform</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">pyats_version.version.platform</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">u_device_type</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">pyats_version.version.rtr_type</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">u_serial_number</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">pyats_version.version.chassis_sn</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">u_last_reload_reason</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">pyats_version.version.last_reload_reason</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">short_description</span><span class="p">:</span><span class="w"> </span><span class="s">"This</span><span class="nv"> </span><span class="s">ticket</span><span class="nv"> </span><span class="s">was</span><span class="nv"> </span><span class="s">created</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">Ansible"</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">var=new_incident.record.number</span>
</pre></div>

<p>Two additional debug examples are provided above to show how to work
with the pyATS dictionary that was returned. With structured output it
is much easier to grab the specific information you want using the key
(e.g. pyats_version.version.uptime is the key that returns the value for
the uptime of the system). The full dictionary is provided above in step 5.</p>
<p>The following screenshot is the output of the playbook shown from Red
Hat Ansible Tower:</p>
<p><img alt="image3-3" src="../images/posts/archive/image3-3.png"></p>
<p>The new fields are now
populated in our ServiceNow incident ticket:</p>
<p><img alt="image5 copy" src="../images/posts/archive/image5-copy.png"></p>
<p>During an outage things can become chaotic. We have all seen how on
certain days in the network field, tickets can become a very low
priority. Automating the creation and dynamic facts solves this and
allows engineers to remain focused on the outage.</p>
<h3>Final thoughts</h3>
<p>Something like this may help your organization adopt automation in
steps. These Ansible Playbooks are low risk because they do not modify
any configurations, they are read-only. This might be a great first step
for network engineers, without having to be doing holistic automation or
even config management. You may consider replacing the ios entry in the
filter plugin to use ansible_network_os variable that was introduced
with the network_cli connection plugin. That way you could run against
nxos, ios, junos, etc. all in the same inventory and playbook run. In
this blog we left it as ios so it could be easier to grasp if this is
your first time seeing it.</p>
<p>Stay tuned for part 3 of this series - we will cover integration from
ServiceNow to Ansible Tower's API. Where you can automatically have
ServiceNow execute Ansible Playbooks.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="red-hat-and-ibm-and-the-ansible-community/" class="u-url">The Song Remains The Same</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/the-ansible-community-team/">The Ansible Community Team</a>
              </span>
            </p>
            <p class="dateline">
              <a href="red-hat-and-ibm-and-the-ansible-community/" rel="bookmark">
                <time class="published dt-published" datetime="2019-07-15T00:00:00Z" itemprop="datePublished" title="2019-07-15 00:00">2019-07-15 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>The Song Remains The Same</h2>
<p><a href="https://www.redhat.com/en/about/press-releases/ibm-closes-landmark-acquisition-red-hat-34-billion-defines-open-hybrid-cloud-future">Now that Red Hat is a part of IBM</a>,
some people may wonder about the future of the Ansible project.</p>
<p>Here is the good news: the Ansible community strategy has not changed.</p>
<p>As always, we want to make it as easy as possible to work with any
projects and communities who want to work with Ansible. With the
resources of IBM behind us, we plan to accelerate these efforts. We want
to do more integrations with more open source communities and more
technologies.</p>
<p>One of the reasons we are excited for the merger is that IBM understands
the importance of a broad and diverse community. Search for "Ansible
plus open source project" and you can find Ansible information, such
as playbooks and modules and blog posts and videos and slide decks,
intended to make working with that project easier. We have thousands of
people attending Ansible meetups and events all over the world. We have
millions of downloads. We have had this momentum because we provide
users flexibility and freedom. IBM is committed to our independence as a
community so that we can continue this work.</p>
<p>We've worked hard to be good open source citizens. We value the trust
that we've built with our users and our contributors, and we intend to
continue to live up to the trust that our community has placed in us.
IBM is committed to the same ideals and will be supportive of our
ongoing efforts to build a strong, diverse community. The song remains
the same.</p>
<p>If you have questions or would like to learn more about the IBM
acquisition, we encourage you to review the list of materials below. Red
Hat CTO Chris Wright will host an online Q&amp;A session July 23 in the
coming days where you can ask questions you may have about what the
acquisition means for Red Hat and our involvement in open source
communities. Details will be announced on the <a href="https://www.redhat.com/en/blog">Red Hat blog</a>.</p>
<p>Additional resources:</p>
<ul>
<li><a href="https://www.redhat.com/en/about/press-releases/ibm-closes-landmark-acquisition-red-hat-34-billion-defines-open-hybrid-cloud-future">Press release</a></li>
<li><a href="https://www.redhat.com/en/blog/red-hat-and-ibm-accelerating-adoption-open-source">Blog from Chris Wright</a></li>
<li><a href="https://community.redhat.com/blog/2019/07/faq-for-communities/">IBM + Red Hat FAQ for Communities</a></li>
</ul>
</div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="configure-network-cards-by-pci-address-with-ansible-facts/" class="u-url">Configure Network Cards by PCI Address with Ansible Facts</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/till-maas/">Till Maas</a>
              </span>
            </p>
            <p class="dateline">
              <a href="configure-network-cards-by-pci-address-with-ansible-facts/" rel="bookmark">
                <time class="published dt-published" datetime="2019-06-14T00:00:00Z" itemprop="datePublished" title="2019-06-14 00:00">2019-06-14 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Configure Network Cards by PCI Address with Ansible Facts</h2>
<p>In this post, you will learn advanced applications of Ansible facts to
configure Linux networking. Instead of hard-coding device names, you
will find out how to specify network devices by PCI addresses. This
prepares your configuration to work on different Red Hat Enterprise
Linux releases with different network naming schemes.</p>
<h3>Red Hat Enterprise Linux System Roles</h3>
<p>The <a href="https://access.redhat.com/articles/3050101">RHEL System Roles</a>
provide a uniform configuration interface across multiple RHEL releases.
However, the names of network devices in modern Linux distributions can
often not be stable for various releases. In the past, the kernel named
the devices after their order of appearance. The first device got the
name <code>eth0</code>, the next <code>eth1</code>, and so on.</p>
<p>To make the device names more reliable, developers introduced
<a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/ch-consistent_network_device_naming">other methods</a>.
This interferes with creating a release-independent network
configuration based on interface names. An initial solution to this
problem is to address network cards by MAC address. But this will
require an up-to-date inventory with MAC addresses of all network cards.
Also, it requires updating the inventory after replacing broken
hardware. This results in extra work. To avoid this effort, it would be
great to be able to specify network cards by their PCI address. With a
uniform hardware setup (same model, same slot, same motherboard), the
PCI address should be stable. This is because it defines the PCI bus,
device and function.</p>
<h3>Ansible facts</h3>
<p>Ansible facts already expose the PCI address for network cards as <code>pciid</code>.
The following playbook shows how to obtain the PCI address for the network card <code>enp0s31f6</code>:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">nic</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enp0s31f6</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Show PCI address (pciid) for a network card</span>
<span class="w">      </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">"The</span><span class="nv"> </span><span class="s">PCI</span><span class="nv"> </span><span class="s">address</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">nic</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts[nic]['pciid']</span><span class="nv"> </span><span class="s">}}."</span>
</pre></div>

<p>When running the playbook, it shows that the PCI address in this case is <code>0000:00:1f.6</code>:</p>
<div class="code"><pre class="code literal-block">ansible-playbook<span class="w"> </span>show_pciid.yml
<span class="o">[</span>...<span class="o">]</span>

TASK<span class="w"> </span><span class="o">[</span>Show<span class="w"> </span>PCI<span class="w"> </span>address<span class="w"> </span><span class="o">(</span>pciid<span class="o">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>a<span class="w"> </span>network<span class="w"> </span>card<span class="o">]</span><span class="w"> </span>**************************
ok:<span class="w"> </span><span class="o">[</span>localhost<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">"msg"</span>:<span class="w"> </span><span class="s2">"The PCI address for enp0s31f6 is 0000:00:1f.6."</span>
<span class="o">}</span>

<span class="o">[</span>...<span class="o">]</span>
</pre></div>

<h3>Transforming the facts</h3>
<p>Selecting a network card by PCI address is not always straightforward.
Ansible facts can't query devices by their attributes directly. Luckily,
there are <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html">filters in Ansible</a>
that make it possible to reorganize the facts. From them, the
<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html#json-query-filter">json_query</a>
filter allows users to reorganize and filter data using the JMESPath
query language for JSON. To be able to use it, you might need to install
the <code>python2-jmespath</code> or <code>python3-jmespath</code> package.
Ansible uses a dictionary with the device names as keys to organize the
network facts. But we need the key to be the PCI address. To do this, we
will use a JMESPath expression that extracts all values of the Ansible
facts dictionary (<code>@.*</code>)
and then selects only the values that contain a
<code>pciid</code> key (<code>[?pciid]</code>). Then we will
use the expression <code>{key: pciid, value: device}</code> to create a new
dictionary with an item named key for the PCI ID and one named value for
the interface name. This structure allows us to use the
<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html#items2dict-filter">items2dict</a>
filter (introduced in Ansible 2.7) to build the final dictionary.</p>
<h3>Example</h3>
<p>The following playbook shows how to create the dictionary
<code>device_by_pci_address</code> this
way. It will contain a mapping from PCI address to device name:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">pci_address</span><span class="p">:</span><span class="w"> </span><span class="s">"0000:00:1f.6"</span>
<span class="w">    </span><span class="nt">device_by_pci_address</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span>
<span class="w">        </span><span class="s">ansible_facts</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">json_query('@.*</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">[?pciid].{key:</span><span class="nv"> </span><span class="s">pciid,</span><span class="nv"> </span><span class="s">value:</span><span class="nv"> </span><span class="s">device}')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">items2dict</span>
<span class="w">    </span><span class="s">}}"</span>
</pre></div>

<p>The following tasks shows the structure of this dictionary and how to use it:</p>
<div class="code"><pre class="code literal-block"><span class="nt">tasks</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Show devices by PCI address</span>
<span class="w">    </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">      </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">device_by_pci_address</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"Show</span><span class="nv"> </span><span class="s">device</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">PCI</span><span class="nv"> </span><span class="s">address</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">pci_address</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">    </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">"The</span><span class="nv"> </span><span class="s">device</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">device_by_pci_address[pci_address]</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">at</span><span class="nv"> </span><span class="s">the</span>
<span class="w">         </span><span class="s">PCI</span><span class="nv"> </span><span class="s">address</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">pci_address</span><span class="nv"> </span><span class="s">}}"</span>
</pre></div>

<p>When running these tasks, Ansible outputs the following:</p>
<div class="code"><pre class="code literal-block">TASK<span class="w"> </span><span class="o">[</span>Show<span class="w"> </span>devices<span class="w"> </span>by<span class="w"> </span>PCI<span class="w"> </span>address<span class="o">]</span><span class="w"> </span>*****************************************
ok:<span class="w"> </span><span class="o">[</span>localhost<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">"device_by_pci_address"</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">"0000:00:1f.6"</span>:<span class="w"> </span><span class="s2">"enp0s31f6"</span>,
<span class="w">        </span><span class="s2">"0000:3a:00.0"</span>:<span class="w"> </span><span class="s2">"wlp58s0"</span>,
<span class="w">        </span><span class="s2">"6-1:1.0"</span>:<span class="w"> </span><span class="s2">"enp8s0u1"</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>

TASK<span class="w"> </span><span class="o">[</span>Show<span class="w"> </span>device<span class="w"> </span>with<span class="w"> </span>PCI<span class="w"> </span>address<span class="w"> </span><span class="m">0000</span>:00:1f.6<span class="o">]</span><span class="w"> </span>***************************
ok:<span class="w"> </span><span class="o">[</span>localhost<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">"msg"</span>:<span class="w"> </span><span class="s2">"The device enp0s31f6 is at the PCI address 0000:00:1f.6"</span>
<span class="o">}</span>
</pre></div>

<p>If you look carefully, you will notice one device has a different PCI address format (<code>6-1:1.0</code>).
This is actually a USB device. On virtual machines you might encounter other types of addresses.
Virtio devices have addresses like <code>virtio0</code>, <code>virtio1</code> and so on.
Using the device name in the configuration makes it still specific for certain releases.
With a small change it is also possible to look up MAC addresses:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">pci_address</span><span class="p">:</span><span class="w"> </span><span class="s">"0000:00:1f.6"</span>
<span class="w">    </span><span class="nt">macaddress_by_pci_address</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span>
<span class="w">        </span><span class="s">ansible_facts</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">json_query('@.*</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">[?pciid].{key:</span><span class="nv"> </span><span class="s">pciid,</span><span class="nv"> </span><span class="s">value:</span><span class="nv"> </span><span class="s">macaddress}')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">items2dict</span>
<span class="w">    </span><span class="s">}}"</span>

<span class="p p-Indicator">[</span><span class="nv">...</span><span class="p p-Indicator">]</span>
</pre></div>

<p>Note that we changed <code>value: device</code> to <code>value: macaddress</code> here.</p>
<h3>Combining with the network role</h3>
<p>To put this all together, here is an example about how to use these
variables with the <a href="https://github.com/linux-system-roles/network">Network RHEL System Role</a>:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">pciid</span><span class="p">:</span><span class="w"> </span><span class="s">"0000:00:1f.6"</span>
<span class="w">    </span><span class="nt">macaddress_by_pci_address</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span>
<span class="w">        </span><span class="s">ansible_facts</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">json_query('@.*</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">[?pciid].{key:</span><span class="nv"> </span><span class="s">pciid,</span><span class="nv"> </span><span class="s">value:</span><span class="nv"> </span><span class="s">macaddress}')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">items2dict</span>
<span class="w">    </span><span class="s">}}"</span>
<span class="w">    </span><span class="nt">network_connections</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">internal_network</span>
<span class="w">        </span><span class="nt">mac</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">macaddress_by_pci_address[pciid]</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ethernet</span>
<span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">up</span>
<span class="w">        </span><span class="nt">ip</span><span class="p">:</span>
<span class="w">          </span><span class="nt">address</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.0.2.73/31</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Import network role</span>
<span class="w">      </span><span class="nt">import_role</span><span class="p">:</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rhel-system-roles.network</span>
</pre></div>

<p>This will configure the connection profile internal_network. It limits
the profile to the device at the PCI address
<code>0000:00:1f.6</code> using the device's MAC address.</p>
<h3>Outlook</h3>
<p>Since the on-disk configuration still uses the MAC address, changing a
network card will require to run the playbook again. To avoid this,
NetworkManager would need to allow specifying the PCI address in the
configuration directly. I filed an <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1673321">RFE proposal</a> for
NetworkManager to support this in the future. Depending on the installed
version of the Jinja2 templating engine, the
<code>dict()</code> constructor allows
to create the dictionary without
<code>items2dict</code>:</p>
<div class="code"><pre class="code literal-block"><span class="nt">vars</span><span class="p">:</span>
<span class="w">  </span><span class="nt">macaddress_by_pci_addresss</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span>
<span class="w">      </span><span class="s">dict(ansible_facts</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">json_query('@.*</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">[?pciid].[pciid,</span><span class="nv"> </span><span class="s">macaddress]'))</span>
<span class="w">  </span><span class="s">}}"</span>
</pre></div>

<p>This works on RHEL 8 and recent versions of Fedora now.
But, <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1697237">RHEL 7 does not support it, yet</a>.</p>
<h3>Conclusion</h3>
<p>In this post, we've learned about network interface naming in modern
versions of Linux. The ability to identify the PCI address for network
cards becomes useful in larger environments to maintain consistency.
Being able to transform facts in Ansible Automation allows for many
possibilities, including using facts to identify which device to
configure when used with RHEL System Roles or any other role for that
matter.</p>
<p>If you are interested in learning more about certified networking
modules approved by the Ansible community and Red Hat, check
outÂ [nsible Automation Certified Content today! Or, you can learn
more about Ansible network automation solutions.Â </p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="ansible-servicenow-opening-and-closing-tickets/" class="u-url">Ansible and ServiceNow Part 1, Opening and Closing Tickets</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/colin-mccarthy/">Colin McCarthy</a>
              </span>
            </p>
            <p class="dateline">
              <a href="ansible-servicenow-opening-and-closing-tickets/" rel="bookmark">
                <time class="published dt-published" datetime="2019-06-06T00:00:00Z" itemprop="datePublished" title="2019-06-06 00:00">2019-06-06 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Ansible and ServiceNow Part 1, Opening and Closing Tickets</h2>
<p>As a Network Engineer, I hated filling out tickets. Anytime a router
would reboot or a power outage took place at a remote site, the
resulting ticket generation took up about 50% of my day. If there had
been a way to automate ticket creation, I would have saved a lot of
time. The only thing unique to provide would have been case-specific
comment sections needing additional information about the issue.</p>
<p>While ticket creation was a vital activity, automating this was not an
option at the time. This is surprising because my management was always
asking me to include more information in my tickets. Tickets were often
reviewed months later and sometimes never got created or did not have
much relevant information included.</p>
<p>Fast forward to today, companies are now data mining from tickets with a
standard <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#variables-discovered-from-systems-facts">set of facts</a>
that are pulled directly from the device during ticket creation, such as
network platform, software version, uptime, etc.Â  Network operations
(NetOps) teams now use massive amounts of ticket data to make budget
decisions.</p>
<p>For example, if there were 400 network outages due to power issues,
NetOps could then make a case to spend \$40,000 on battery backups,
having proved that it would prevent around 400 outages a year. Having
access to these metrics is extremely valuable for making informed
business decisions.</p>
<p>This first blog in the series covers how Ansible automates change
requests from ServiceNow, a popular cloud-based SaaS provider. For
convenience, ServiceNow provides developers a test instance to use
Ansible Playbooks, which is utilized for this and future blog posts. You
can sign up for your own free developers instance at the ServiceNow
Developer portal.</p>
<h3>Creating a ServiceNow ticket</h3>
<p>The Ansible distribution includes the
<a href="https://docs.ansible.com/ansible/latest/modules/snow_record_module.html">snow_record</a>
module that makes it easy to open and close ServiceNow tickets. The
<code>pysnow</code> Python library
will first need to be installed to use this module.</p>
<p>The next requirement is getting the
<code>username</code>, <code>password</code> and <code>instance</code> for
authentication to your recently created developer cloud based ServiceNow
instance.</p>
<p>NOTE: the instance should look something like this instance: dev99999 not the full URL</p>
<p><code>instance:_http://dev99999.service-now.com</code>Â as shown below in <code>change_request_vars.yml</code>:</p>
<div class="code"><pre class="code literal-block"><span class="o">---</span>
<span class="c1">#snow_record variables</span>

<span class="n">sn_username</span><span class="p">:</span><span class="w"> </span><span class="n">admin</span>
<span class="n">sn_password</span><span class="p">:</span><span class="w"> </span><span class="n">my_password</span>
<span class="n">sn_instance</span><span class="p">:</span><span class="w"> </span><span class="n">dev99999</span>

<span class="c1">#data variables</span>

<span class="n">sn_severity</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>
<span class="n">sn_priority</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>
</pre></div>

<p>The following is the Ansible Playbook to create a ServiceNow ticket:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create ticket with notes</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">include vars</span>
<span class="w">    </span><span class="nt">include_vars</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">change_request_vars.yml</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create a change request</span>
<span class="w">    </span><span class="nt">snow_record</span><span class="p">:</span>
<span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<span class="w">      </span><span class="nt">table</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">change_request</span>
<span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">sn_username</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">sn_password</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">instance</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">sn_instance</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">      </span><span class="nt">data</span><span class="p">:</span>
<span class="w">        </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">sn_severity</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">sn_priority</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">short_description</span><span class="p">:</span><span class="w"> </span><span class="s">"This</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">test</span><span class="nv"> </span><span class="s">opened</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">Ansible"</span>
<span class="w">    </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">new_incident</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">      </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">new_incident.record</span>
</pre></div>

<h3>Leveraging the ServiceNow API</h3>
<p>The <code>table</code> parameter
determines what type of ticket will be opened. A great way to determine
the other parameters available is to view the JSON dictionary the
ServiceNow API sends back after you have created your ticket. I am using
<code>register</code> to give a
variable name to that dictionary and then using <code>debug</code> to view it in the
terminal. The following is just a portion of the full dictionary for the
sake of brevity:</p>
<p><img alt="blog_leverage-servicenow-api" src="../images/posts/archive/blog_leverage-servicenow-api.png"></p>
<p>This is very handy in spelling out the parameters you can add under the
<code>data</code> section of your
task. If you want to see just one parameter of the dictionary, for
example the ticket number, you can simply modify your debug to look like
the following:</p>
<p><code>- debug: var=new_incident.record.number</code></p>
<p>This variable (var) is defined as pulling from the stored register
<code>new_change_request</code> to then show the dictionary named
<code>record</code> and the parameter
of that dictionary called <code>number</code>.</p>
<p><img alt="blog_leverage-servicenow-api-2" src="../images/posts/archive/blog_leverage-servicenow-api-2.png"></p>
<p>You could do the same thing with any parameter of the record dictionary
such as <code>close_code</code>, <code>state</code>, <code>comments</code>, and many
others.</p>
<h3>Validating changes in ServiceNow web portal</h3>
<p>Next, log into your developers instance of ServiceNow and view the
<strong>Change-&gt;all</strong> section in the left menu bar. You should see your change
request in the list.</p>
<p><img alt="blog_servicenow-screen" src="../images/posts/archive/blog_servicenow-screen.png"></p>
<p>Notice that the short description has been filled out by our Ansible
Playbook task: This is a test opened by Ansible as well as the priority
<code>2 - High</code>.</p>
<p><img alt="blog_servicenow-screen-2" src="../images/posts/archive/blog_servicenow-screen-2.png"></p>
<h3>Closing a ServiceNow ticket</h3>
<p>Now that we've demonstrated the opening of ServiceNow tickets, we should
demonstrate closing or resolving the ticket as well. This is done by
specifying the <code>state</code>
parameter in another Ansible task. This is where it can get tricky
because <code>state</code> is a
parameter of the record dictionary as well as a parameter of the
<code>snow_record</code> module.
Please be mindful of this multi-purpose parameter used in Ansible.</p>
<p>The following is a snippet from the
<code>record</code> dictionary when
we created our ticket:</p>
<p><img alt="blog_closing-servicenow-ticket" src="../images/posts/archive/blog_closing-servicenow-ticket.png"></p>
<p>Notice the original <code>state</code> was <code>-5</code>. The Ansible task
below will change it to <code>-3</code>, which results in a
ticket state changing from New to Authorize.</p>
<div class="code"><pre class="code literal-block"><span class="o">---</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">Modify</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="n">request</span>
<span class="w">    </span><span class="n">snow_record</span><span class="p">:</span>
<span class="w">      </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="n">present</span>
<span class="w">      </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="n">change_request</span>
<span class="w">      </span><span class="n">username</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ sn_username }}"</span>
<span class="w">      </span><span class="n">password</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ sn_password }}"</span>
<span class="w">      </span><span class="n">instance</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ sn_instance }}"</span>
<span class="w">      </span><span class="n">number</span><span class="p">:</span><span class="w"> </span><span class="n">CHG0030002</span>
<span class="w">      </span><span class="n">data</span><span class="p">:</span>
<span class="w">        </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span>
<span class="w">    </span><span class="n">register</span><span class="p">:</span><span class="w"> </span><span class="n">incident</span>

<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">debug</span><span class="p">:</span><span class="w"> </span>
<span class="w">      </span><span class="k">var</span><span class="p">:</span><span class="w"> </span><span class="n">incident</span><span class="o">.</span><span class="n">record</span><span class="o">.</span><span class="n">state</span>
</pre></div>

<p>In ServiceNow a <code>change_request</code> needs to
be walked through a few different states before it can be closed. The
numeric values for the different states can be found in the ServiceNow
documentation. I recommend you have five separate Ansible tasks that
each change the state in this order: <code>-3</code>, <code>-2</code>, <code>-1</code>, <code>0</code>, <code>3</code>. Please note that these
values are for the ServiceNow Kingston release and that other releases
may use different state numbers. Your organization may have other steps
required along the way, but hopefully this article was enough to get you
started. At this point you've learned how to open tickets, and close
tickets with specific labels via Ansible Playbooks.</p>
<p>Stay tuned for part 2 - I'll describe adding a set of parsed facts to
your tickets.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="using-infoblox-as-a-dynamic-inventory-in-red-hat-ansible-tower/" class="u-url">Using Infoblox as a dynamic inventory in Red Hat Ansible Tower</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/victor-da-costa/">Victor da Costa</a>
              </span>
            </p>
            <p class="dateline">
              <a href="using-infoblox-as-a-dynamic-inventory-in-red-hat-ansible-tower/" rel="bookmark">
                <time class="published dt-published" datetime="2019-05-24T00:00:00Z" itemprop="datePublished" title="2019-05-24 00:00">2019-05-24 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Using Infoblox as a dynamic inventory in Red Hat Ansible Tower</h2>
<p>Do you still use spreadsheets to keep track of all your device
inventory? Do you have Infoblox Appliances deployed in your
infrastructure? Do you want to start automating without the burden of
maintaining a static register of devices? If you answered yes to any of
these questions, this blog is for you.</p>
<p>Operations teams often struggle to keep their <em>Configuration Management
Databases</em> (CMDBs) up-to-date, primarily because they were not involved
in the specification process to share what pieces of information are
relevant to them, or even if they were, once it is put in place:</p>
<p>Teams are not allowed to change any of their <strong>Configuration Items (CI) because they have only read-only access!</strong></p>
<p>The reality is that a lot of the time when we talk about a <em>CMDB</em>, we
are talking about tables in a database without any version control
mechanism, therefore only read access is provided to end users.</p>
<p>The impact is that in order to perform lifecycle management
(Create/Update/Decommission) of their configuration items, teams must go
through a fastidious and manual process until they give up changing CIs
(Configuration Items) in the CMDB and just leave everything as it is.
<strong>What happens next?</strong> Different teams start to rely on their own
<em>CMDBs</em> (A.K.A spreadsheets), to track subnets, IP allocations, DNS
records, Zones, Views, etc. <strong>What's the end result?</strong> End users
request their machines and still need to wait at least a week before
someone from the NetOps team consults their own CMDB (yes, the
spreadsheet) to provide them DNS records and IP addresses.</p>
<h3>Dynamic Inventory</h3>
<p>Dynamic Inventory is one of the most powerful features in Red Hat
Ansible Tower. Dynamic Inventory allows Ansible to query external
systems and use the response data to construct its inventory. Red Hat
Ansible Tower provides some out-of-the-box integrations through dynamic
inventory scripts, and also allows users to extend these capabilities by
providing their own <a href="https://docs.ansible.com/ansible-tower/latest/html/administration/custom_inventory_script.html">custom dynamic inventory script</a>.</p>
<h4>Red Hat Ansible Tower and Infoblox</h4>
<p>Let's take a look at the steps required to configure a custom dynamic
inventory script to query Infoblox and rely on it as our inventory
source of truth.</p>
<h5>Install infoblox-client</h5>
<p>First we need to install the infoblox-client python library in Red Hat
Ansible Tower's venv of each node of the cluster, and the configuration
file required by the infoblox inventory script:</p>
<div class="code"><pre class="code literal-block"><span class="c1"># source /var/lib/awx/venv/awx/bin/activate</span>
<span class="c1"># pip install infoblox-client</span>
</pre></div>

<p>NOTE: You could also create a <a href="https://gist.github.com/victorock/493b2d41f5a148efbed9e66dc2e8dee1">playbook to do</a>
this, using the Ansible <a href="https://docs.ansible.com/ansible/latest/pip_module.html">pip_module</a>.</p>
<p>Create the <a href="https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/infoblox.yaml">infoblox configuration file</a>
in <a href="https://gist.github.com/victorock/3c28056b41e3489d731cc5a2801f2166">/etc/ansible/infoblox.yaml</a>:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="nt">filters</span><span class="p">:</span>
<span class="w">  </span><span class="nt">extattrs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">  </span><span class="nt">view</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</pre></div>

<p><em>NOTE: Follow</em> <a href="https://github.com/ansible/ansible/issues/53526"><em>this Ansible GitHub
Issue</em></a> <em>where I
suggest taking configuration items from an environment variable or a
file for added flexibility.</em></p>
<h5>Credential Type</h5>
<p>After the installation in the previous step completes successfully in
all the nodes of the cluster, we need to specify in Ansible Tower the
credential and hostname to establish communication with Infoblox
Appliances. As of today we don't have any specific Ansible Tower
Credential for Infoblox, so let's create a <a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/credential_types.html">custom credential
type</a>.
We can then provide the information required to communicate with
Infoblox, have the password protected by Ansible Tower and
<a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/security.html#role-based-access-controls">RBAC</a>
(Role-Based Access Control).</p>
<p>As Administrator, go to <a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/credential_types.html">Credential
Types</a>
in the left menu.</p>
<p>Create a new credential type: <em>INFOBLOX_INVENTORY</em> (Green + sign)</p>
<p><img alt="Credential Types - Infoblox Inventory" src="../images/posts/archive/image12.png"></p>
<p><img alt="screenshot" src="../images/posts/archive/image5-2.png"></p>
<p>Define the inputs required in the <em>INPUT CONFIGURATION</em> field:</p>
<div class="code"><pre class="code literal-block"><span class="nt">fields</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostname</span>
<span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Hostname</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">username</span>
<span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Username</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Password</span>
<span class="nt">required</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">username</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
</pre></div>

<p>Define the injection of inputs as environment variables in <em>INJECTOR CONFIGURATION</em> field:</p>
<div class="code"><pre class="code literal-block">env:
<span class="w">  </span>INFOBLOX_HOST:<span class="w"> </span><span class="s1">'{{ hostname }}'</span>
<span class="w">  </span>INFOBLOX_PASSWORD:<span class="w"> </span><span class="s1">'{{ password }}'</span>
<span class="w">  </span>INFOBLOX_USERNAME:<span class="w"> </span><span class="s1">'{{ username }}'</span>
</pre></div>

<h5>Credential</h5>
<p>After the creation of the credential type INFOBLOX_INVENTORY in Ansible
Tower, we can use it to create a new credential, specifying the
information to communicate with the Infoblox Appliance.</p>
<p>Create a credential to communicate with Infoblox Appliance:
<code>infoblox-ip.ip.ip.ip</code></p>
<p><img alt="Create credential" src="../images/posts/archive/image2-4.png"></p>
<p><em>NOTE: In the example, the name includes theÂ IP or FQDN, so we can know
what appliance this particular credential refers to.</em></p>
<h5>Inventory Script</h5>
<p>Creation of custom inventory script to query Infoblox Appliances and
parse the output to the format expected by Ansible inventory.</p>
<p>Create a new <a href="https://docs.ansible.com/ansible-tower/latest/html/administration/custom_inventory_script.html">custom inventory script</a>: <code>_infoblox-inventory-script.py</code></p>
<p>Get the <a href="https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/infoblox.py">infoblox.py</a>
from Ansible's GitHub and paste into the <em>CUSTOM SCRIPT</em> field:</p>
<p><img alt="Create inventory script" src="../images/posts/archive/image14.png"></p>
<h5>Inventory Source</h5>
<p>Creation of inventory with the infoblox dynamic script as dynamic source
and sync to populate our inventory with entries returned by Infoblox
Appliance.</p>
<p>Go to Inventories and <a href="https://docs.ansible.com/ansible-tower/latest/html/quickstart/create_inventory.html">create a new Inventory</a>: <code>netops</code></p>
<p><img alt="Create inventory" src="../images/posts/archive/image8.png"></p>
<p><a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/inventories.html#add-source">Add Source</a> referring to the infoblox-dynamic-script.py:</p>
<p><img alt="add source" src="../images/posts/archive/image2-5.png"></p>
<p><a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/inventories.html#add-source">Sync the Inventory Source</a>:</p>
<p><img alt="sync inventory source" src="../images/posts/archive/image10.png"></p>
<p><a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/inventories.html#view-completed-jobs">Check Sync Status</a>:</p>
<p><img alt="check sync status" src="../images/posts/archive/image1-5.png"></p>
<h5>Inventory Entries</h5>
<p>Verification if the hosts, groups and variables are being populated
correctly in the inventory, based on existing entries in Infoblox
Appliance:</p>
<p>Check host entries in inventory: Â <code>netops</code> -&gt; <code>hosts</code></p>
<p><img alt="check host inventory " src="../images/posts/archive/image11.png"></p>
<p>Check variables associate to a host entry: <code>netops</code> -&gt; <code>hosts</code> -&gt; <code>rtr01.acme.com</code></p>
<p><img alt="check variables" src="../images/posts/archive/image4-2.png"></p>
<p><img alt="host details " src="../images/posts/archive/image13.png"></p>
<p><img alt="check inventories" src="../images/posts/archive/image6-1.png"></p>
<p>At this point we have servers and routers in our dynamic inventory,
therefore from now on we can execute any Ansible Playbooks against them.
Â In the next section we'll cover how the configurations looks like in
the infoblox side.</p>
<h5>Infoblox</h5>
<p>At this point you may be wondering: How are these variables in Ansible
Tower's Inventory specified in my Infoblox Appliance? The answer is
that we are using <em>Extensible Attributes</em> in Infoblox to fulfill
ansible_* variables, so they are automatically populated in Ansible
Tower's inventory. Follow below some screenshots taken from Infoblox's
WEBUI:</p>
<p>Extensible Attributes Configuration in Infoblox, for the variable "ansible_host":</p>
<p><img alt="Extensible Attributes Configuration in Infoblox" src="../images/posts/archive/image9.png"></p>
<h5>Why are we using Extensible Attributes?</h5>
<p>The answer is simple. It is common to have entries in the DNS that
refers to the production interface of the server or the service being
provided, meanwhile the management access is only available via a
dedicated out-of-band management interface. The <em>ansible_host</em> extra
attribute defines that for this particular entry, Ansible shall use its
value to establish communication with the server, via the management
interface.</p>
<p>Additionally, we could rely on Extensible Attributes variable to specify
if an entry is managed by Ansible Tower or not (<em>Ex: ansible_managed:
true/false</em>), and update our "<em>Dynamic Inventory Configuration File</em>"
accordingly, to use this particular attribute as a filter. The result is
that Ansible Tower's inventory will only populate with entries that we
want to automate (<em>ansible_managed: true</em>).</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="summary-of-authentication-methods-in-red-hat-ansible-tower/" class="u-url">Summary of Authentication Methods For Red Hat Ansible Tower</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/christian-adams/">Christian Adams</a>
              </span>
            </p>
            <p class="dateline">
              <a href="summary-of-authentication-methods-in-red-hat-ansible-tower/" rel="bookmark">
                <time class="published dt-published" datetime="2019-04-22T00:00:00Z" itemprop="datePublished" title="2019-04-22 00:00">2019-04-22 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Summary of Authentication Methods For Red Hat Ansible Tower</h2>
<p>Red Hat Ansible Tower 3.4.0 has added token authentication as a new
method for authentication so I wanted to use this post to summarize the
numerous enterprise authentication methods and the best use case for
each. Ansible Tower is designed for organizations to centralize and
control their automation with a visual dashboard for out-of-the box
control while providing a REST API to integrate with your other tooling
on a deeper level. We support a number of authentication methods to make
it easy to embed Ansible Tower into existing tools and processes to help
ensure the right people can access Ansible Tower resources. For this
blog post I will go over four of Ansible Tower's authentication methods:
Session, Basic, OAuth2 Token, and Single Sign-on (SSO). For each method
I will provide some quick examples and links to the relevant supporting
documentation, so you can easily integrate Ansible Tower into your
environment.</p>
<h3>Session Authentication</h3>
<p>Session authentication is what's used when logging in directly to
Ansible Tower's API or UI. It is used when a user wants to remain logged
in for a prolonged period of time, not just for that HTTP request, i.e.
when browsing the UI or API in a browser like Chrome or Firefox. When a
user logs in, a session cookie is created, which enables the user to
remain logged in when navigating to different pages within Ansible
Tower.</p>
<p><img alt="Blog-TAO-Login" src="../images/posts/archive/Blog-TAO-Login.png"></p>
<p><strong>How does it work?</strong></p>
<p><img alt="Blog-TAO-API" src="../images/posts/archive/Blog-TAO-API.png"></p>
<p>Using the Curl tool, let's take a deeper look at what happens when you
log in to Ansible Tower.</p>
<ol>
<li>
<p>GET to <code>/api/login/</code> endpoint to grab the <code>csrftoken</code> cookie</p>
<p>```bash
curl -k -c - https://<tower-host>/api/login/</tower-host></p>
<p>localhost   FALSE   /   FALSE   0   csrftoken
AswSFn5p1qQvaX4KoRZN6A5yer0Pq0VG2cXMTzZnzuhaY0L4tiidYqwf5PXZckuj
```</p>
</li>
<li>
<p>POST to the <code>/api/login/</code> endpoint with username, password, and
<code>X-CSRFToken=&lt;token-value&gt;</code></p>
<p><code>bash
curl -X POST -H 'Content-Type: application/x-www-form-urlencoded' \
  --referer https://&lt;tower-host&gt;/api/login/ \
  -H 'X-CSRFToken: K580zVVm0rWX8pmNylz5ygTPamgUJxifrdJY0UDtMMoOis5Q1UOxRmV9918BUBIN' \
  --data 'username=root&amp;password=reverse' \
  --cookie 'csrftoken=K580zVVm0rWX8pmNylz5ygTPamgUJxifrdJY0UDtMMoOis5Q1UOxRmV9918BUBIN' \
  https://&lt;tower-host&gt;/api/login/ -k -D - -o /dev/null</code></p>
</li>
</ol>
<p>All of this is done by Ansible Tower when you log in to the UI or API in
the browser, and should only be used when authenticating in the browser.
For programmatic integration with Ansible Tower, you should use OAuth 2
tokens, not the process described above.</p>
<p>Note: The session expiration time can be changed by setting the
<a href="https://docs.ansible.com/ansible-tower/latest/html/administration/session_limits.html#working-with-session-limits">SESSION_COOKIE_AGE</a>
setting.</p>
<p>Example with browsable API:</p>
<p><img alt="Blog-TAO-Cred-List" src="../images/posts/archive/Blog-TAO-Cred-List.png"></p>
<h3>Basic Authentication</h3>
<p>Basic Authentication is stateless, thus the base64 encoded `username`
and <code>password</code> must be sent along with each request via the
Authorization header.</p>
<p>Use Case: For API calls from curls, python scripts, or individual
requests to the API. Â OAuth2 Authentication is recommended for accessing
the API when at all possible. Â </p>
<p>Example with curl:</p>
<div class="code"><pre class="code literal-block">curl<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span>-H<span class="w"> </span><span class="s1">'Authorization: Basic dXNlcjpwYXNzd29yZA==â</span>
<span class="s1">https://&lt;tower-host&gt;/api/v2/credentials -k -L</span>

<span class="s1"># the --user flag adds this Authorization header for us</span>
<span class="s1">curl -X GET --user '</span>user:password<span class="err">'</span><span class="w"> </span>https://&lt;tower-host&gt;/api/v2/credentials<span class="w"> </span>-k<span class="w"> </span>-L
</pre></div>

<p>For more information about the Basic HTTP Authentication scheme, see
<a href="https://tools.ietf.org/html/rfc7617">RFC 7617</a>.</p>
<p>Note: Basic Auth can be disabled for security purposes, see the
<a href="https://docs.ansible.com/ansible-tower/2.4.3/html/administration/social_auth.html#basic-authentication-settings">docs</a>
for more info.</p>
<h3>OAuth 2 Token Authentication</h3>
<p>OAuth (Open Authorization) is an open standard for token-based
authentication and authorization. OAuth 2 authentication is commonly
used when interacting with the Ansible Tower API programmatically. Like
Basic Auth, an OAuth 2 token is supplied with each API request via the
Authorization header. Unlike Basic Auth, OAuth 2 tokens have a
configurable timeout and are scopable. Tokens have a configurable
expiration time and can be easily revoked for one user or for the entire
Ansible Tower system by an admin if needed. This can be done with the
<code>tower-manage revoke_oauth2_tokens</code> management command. Here is<a href="https://docs.ansible.com/ansible-tower/latest/html/administration/tower-manage.html#revoke-oauth2-tokens">Â more
information</a>
on doing that. Additionally, the type of users able to create tokens can
be limited to users created in Ansible Tower, as opposed to external
users created from an SSO (see SSO section below). For more on how to do
this see the note in these
<a href="https://docs.ansible.com/ansible-tower/latest/html/administration/oauth2_token_auth.html#revoke-an-access-token">docs</a>.</p>
<p>Different methods for obtaining OAuth 2 Access Tokens in Ansible Tower:</p>
<ul>
<li>Personal access tokens (PAT)</li>
<li>Application Token: Password grant type</li>
<li>Application Token: Implicit grant type</li>
<li>Application Token: Authorization Code grant type</li>
</ul>
<p>First, a user needs to create an OAuth 2 Access Token in the API, or in
their User's <code>Token</code> tab in the UI. For the purposes of this article,
we will use the personal access token method (PAT) for creating a token.
Upon token creation, the user can set the scope. The expiration time of
the token can be configured system-wide as well.</p>
<p>Below is an example of creating a PAT in the UI:\
Â <img alt="Blog-TAO-Token" src="../images/posts/archive/Blog-TAO-Token.png"></p>
<p>Token authentication is best used for any programmatic use of Ansible
Tower's API, such as Python scripts or tools like curl. See the example
for a personal access token (PAT) below:</p>
<p><strong>Curl Example</strong></p>
<p>First, create an OAuth 2 token without an associated Application; in
other words, a personal access token. In this example, we will do so
through the API with curl.</p>
<div class="code"><pre class="code literal-block">curl<span class="w"> </span>-u<span class="w"> </span>user:password<span class="w"> </span>-k<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>https://&lt;tower-host&gt;/api/v2/tokens/
</pre></div>

<p>You can now use that token to perform a GET request for an Ansible Tower
resource, e.g., Hosts.</p>
<div class="code"><pre class="code literal-block">curl<span class="w"> </span>-k<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-H<span class="w"> </span>âContent-Type:<span class="w"> </span>application/jsonâ
<span class="w">    </span>-H<span class="w"> </span>âAuthorization:<span class="w"> </span>Bearer<span class="w"> </span>&lt;oauth2-token-value&gt;â<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://&lt;tower-host&gt;/api/v2/hosts/
</pre></div>

<p>Similarly, a job can be launched by making a POST to the job template
that you want to launch.</p>
<div class="code"><pre class="code literal-block">curl<span class="w"> </span>-k<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-H<span class="w"> </span><span class="s2">"Authorization: Bearer &lt;oauth2-token-value&gt;"</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-H<span class="w"> </span><span class="s2">"Content-Type: application/json"</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--data<span class="w"> </span><span class="s1">'{"limit" : "ansible"}'</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://&lt;tower&gt;/api/v2/job_templates/14/launch/
</pre></div>

<p><strong>Python Example</strong></p>
<p>Tower-CLI is an open source tool that makes it easy to use HTTP requests
to access Ansible Tower's API. You can have Tower-CLI authenticate to
Tower using your OAuth 2 token by setting it in <code>tower-cli config</code>, or
have it acquire a PAT on your behalf by using the <code>tower-cli login</code>
command. It is easy to use and I would recommend checking it out:</p>
<div class="code"><pre class="code literal-block">pip<span class="w"> </span>install<span class="w"> </span>ansible-tower-cli

tower-cli<span class="w"> </span>config<span class="w"> </span>tower
tower-cli<span class="w"> </span>login
</pre></div>

<p>For more information on how to use OAuth 2 in Ansible Tower in the
context of integrating external applications, check out these
<a href="https://docs.ansible.com/ansible-tower/latest/html/administration/oauth2_token_auth.html">docs</a>.</p>
<p>If you need to write custom requests, you can write a Python script
using the <a href="https://pypi.org/project/requests/">Python library requests</a>. Here is
an example.</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">oauth2_token_value</span> <span class="o">=</span> <span class="s1">'y1Q8ye4hPvT61aQq63Da6N1C25jiA'</span>   <span class="c1"># your token value from Tower</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">'https://&lt;tower-host&gt;/api/v2/users/'</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'Authorization'</span><span class="p">:</span> <span class="s1">'Bearer '</span> <span class="o">+</span> <span class="n">oauth2_token_value</span><span class="p">,}</span>

<span class="c1"># makes request to Tower user endpoint</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
<span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># prints json returned from Tower with formatting</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>

<h3>SSO Authentication</h3>
<p>Single sign-on (SSO) authentication methods are fundamentally different
because the authentication of the user happens external to Ansible
Tower. For example, with GitHub SSO GitHub is the single source of
truth, which verifies your identity based on the username and password
you gave Tower.</p>
<p>Once you have configured an SSO method in Ansible Tower, a button for
that SSO will be present on the login screen. If you click that button,
it will redirect you to the Identity Provider, in this case GitHub,
where you will present your credentials. If the Identity Provider
verifies you successfully, then Ansible Tower will make a user linked to
your GitHub user (if this is your first time logging in via this SSO
method), and log you in.</p>
<ul>
<li>
<a href="https://docs.ansible.com/ansible-tower/latest/html/administration/ldap_auth.html#ag-ldap">LDAP</a> -
    a directory of identities external to Ansible Tower that can be used
    to check authentication credentials against. Active Directory can be
    configured via the LDAP SSO in Ansible Tower.</li>
<li>SAML - allows Ansible Tower users to authenticate via a single
    sign-on authentication service, so that authentication is consistent
    for the user across multiple services used by their team. SAML is
    particularly useful for maintaining permission groups across
    services.</li>
<li>
<a href="https://docs.ansible.com/ansible-tower/latest/html/administration/social_auth.html#github-oauth2-settings">GitHub</a> -
    allows Ansible Tower users to authenticate with their GitHub
    credentials if they are in the Github Organization, Team or User
    that the system admin specified in
    `/api/v2/settings/authentication/`. Ansible Tower uses OAuth 2 to
    verify the user's credentials with GitHub.</li>
<li>
<a href="https://docs.ansible.com/ansible-tower/latest/html/administration/ent_auth.html#azure-active-directory-ad">Azure Active
    Directory</a> -
    allows Ansible Tower users to authenticate with the Azure
    credentials. Ansible Tower uses OAuth 2 to authenticate to Azure to
    verify your credentials and obtain user group data.</li>
<li>
<a href="https://docs.ansible.com/ansible-tower/latest/html/administration/ent_auth.html#radius-authentication-settings">RADIUS</a> -
    is an authentication protocol generally used for network devices. It
    can minimize network traffic for authentication, as it is
    lightweight.</li>
<li>
<a href="https://docs.ansible.com/ansible-tower/latest/html/administration/social_auth.html#google-oauth2-settings">Google OAuth</a> -
    allows Ansible Tower users to authenticate with their Google Cloud.
    Ansible Tower authenticates to Google using the OAuth 2 protocol to
    check your username and password credentials against the identities
    in your Google organization.</li>
</ul>
<h3>Which Authentication is right for me?</h3>
<p>I've shown you four types of authentication you can use in Ansible
Tower. Each method has pros and cons and lends itself to certain use
cases.</p>
<ul>
<li>
<strong>Session Authentication</strong> (logging in to the UI or browsable API): I am using Ansible Tower to manually create resources (inventory, project, job template) and launch jobs in the browser.</li>
<li>
<strong>Basic Authentication:</strong>Â  I am troubleshooting Ansible Tower with curl, HTTPie, or another similar tool and have not yet set up an OAuth 2 Token for my user</li>
<li>
<strong>OAuth 2 Token Authentication</strong><ul>
<li>Authorization Code Flow -I am a user of an application interfacing withÂ Ansible Tower</li>
<li>Personal Access Tokens (PAT) - I am automating my usage of Ansible Tower programmatically</li>
</ul>
</li>
<li>
<strong>SSO:</strong>Â I am using Ansible Tower inside a large organization and want to use a central Identity provider or want to allow users to authenticate using external authentication like Google SSO, Azure SSO, LDAP, SAML, or GitHub.</li>
</ul>
<p>You now have the knowledge needed to choose the most effective
authentication methods for your needs! I hope this guide helps to
clarify your options for authenticating with Ansible Tower.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="three-quick-ways-to-move-your-ansible-inventory-into-red-hat-ansible-tower/" class="u-url">Three quick ways to move your Ansible inventory into Red Hat Ansible Tower</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/sean-cavanaugh/">Sean Cavanaugh</a>
              </span>
            </p>
            <p class="dateline">
              <a href="three-quick-ways-to-move-your-ansible-inventory-into-red-hat-ansible-tower/" rel="bookmark">
                <time class="published dt-published" datetime="2019-03-18T00:00:00Z" itemprop="datePublished" title="2019-03-18 00:00">2019-03-18 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Three quick ways to move your Ansible inventory into Red Hat Ansible Tower</h2>
<p>If you've been using Ansible at the command line for a while, you
probably have a lot of servers, network devices, and other target nodes
listed in your inventory. You know that Red Hat Ansible Tower makes it
easier for everyone on your team to run your Ansible Playbooks. So
you've thought about using Ansible Tower to take your automation to the
next level, but you want to retain all the data and variables in your
existing inventory file or directory. Are you worried about transferring
your inventory from command-line use to Ansible Tower? Let me show you
how easy it is to import your existing Ansible inventory into Ansible
Tower!</p>
<p>This blog covers three quick and effective ways to connect your existing
Ansible inventory into Ansible Tower:</p>
<ol>
<li>Migrating an inventory file from the Ansible Tower control node
    (awx-manage)</li>
<li>Migrating an inventory file from anywhere with a playbook</li>
<li>Setting Tower to access a git source-controlled inventory file</li>
</ol>
<p>If you're using <a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/inventories.html">dynamic inventory</a>,
you don't need to import your inventory into Ansible Tower. Dynamic
inventory retrieves your inventory from an existing source. With dynamic
inventory, you don't need to manage an inventory file at all, you just
retrieve the latest and most up-to-date listing every time. Ansible
<a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/inventories.html#credential-sources">Tower seamlessly integrates</a>
with popular dynamic inventory sources including Red Hat OpenStack
Platform, Red Hat Satellite, public cloud platforms (Amazon Web
Services/AWS, Google Compute Engine/GCE, Microsoft Azure), and
virtualization solutions like Red Hat Virtualization and VMware vCenter.
You can use scripts to integrate Infoblox DDI and ServiceNowÂ CMDB for
dynamic inventory in Ansible Tower as well.</p>
<p>NOTE: This blog does not cover the importing of Ansible Playbooks or
Ansible Tower workflows into Ansible Tower and is strictly focused on
Ansible inventory portability.</p>
<h3>Migrating an inventory file from the Ansible Tower control node (awx-manage)</h3>
<p>The command line tool
<a href="https://docs.ansible.com/ansible-tower/latest/html/administration/tower-manage.html">awx-manage</a>,
which comes with your Ansible Tower installation, is a simple and
effective tool to import your inventory. Using awx-manage makes the most
sense when your inventory is a flat file inÂ YAML or ini format that
already lives on your Ansible control node. You run the command and
point to your existing inventory fileÂ then Ansible Tower will be loaded
with all the hosts.</p>
<ol>
<li>
<p>Using the WebUI login to Ansible Tower and create an empty
    inventory.</p>
<p><img alt="inventory" src="../images/posts/archive/inventory.gif"></p>
</li>
<li>
<p>Login via SSH to your Ansible Tower control node (This is the Linux
    machine that has Ansible Tower installed on it).</p>
</li>
<li>
<p>Locate the flat-file that represents your Ansible inventory.</p>
</li>
<li>
<p>Run the awx-manage inventory_import command like this</p>
<div class="code"><pre class="code literal-block"><span class="n">sudo</span> <span class="n">awx</span><span class="o">-</span><span class="n">manage</span> <span class="n">inventory_import</span> <span class="o">--</span><span class="n">source</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">hosts</span> <span class="o">--</span><span class="n">inventory</span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="s2">"My Inventory"</span>
</pre></div>

<p>On the terminal window you will receive some output similar to the
following:</p>
<div class="code"><pre class="code literal-block"><span class="mf">1.387</span> <span class="n">INFO</span> <span class="n">Updating</span> <span class="n">inventory</span> <span class="mi">3</span><span class="p">:</span> <span class="n">My</span> <span class="n">Inventory</span>
<span class="mf">1.475</span> <span class="n">INFO</span> <span class="n">Reading</span> <span class="n">Ansible</span> <span class="n">inventory</span> <span class="n">source</span><span class="p">:</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">hosts</span>
<span class="mf">2.119</span> <span class="n">INFO</span> <span class="n">Processing</span> <span class="n">JSON</span> <span class="n">output</span><span class="o">...</span>
<span class="mf">2.120</span> <span class="n">INFO</span> <span class="n">Loaded</span> <span class="mi">6</span> <span class="n">groups</span><span class="p">,</span> <span class="mi">6</span> <span class="n">hosts</span>
<span class="mf">2.329</span> <span class="n">INFO</span> <span class="n">Inventory</span> <span class="kn">import</span> <span class="nn">completed</span> <span class="k">for</span> <span class="p">(</span><span class="n">My</span> <span class="n">Inventory</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">0.9</span><span class="n">s</span>
</pre></div>

</li>
<li>
<p>Now when you login via the WebUI you will see all the hosts under
    the inventory</p>
<p><img alt="loaded_inventory" src="../images/posts/archive/loaded_inventory.gif"></p>
</li>
</ol>
<p>The awx-manage command line tool is very simple and fast. It only took
me a couple seconds to take my existing inventory and import it into
Ansible Tower.</p>
<p>For teams that use Ansible Tower to run playbooks, but manage inventory
outside of Ansible Tower, importing with awx-manage is not the best
option, since you would need to re-import the flat-file inventory every
time a change is made to your inventory file. If your team will continue
to manage inventory outside of Ansible Tower, you probably want to use
the GitHub option described below.</p>
<h3>Migrating an inventory file from anywhere with a playbook</h3>
<p>You can use the <a href="https://docs.ansible.com/ansible/latest/modules/list_of_web_infrastructure_modules.html#ansible-tower">Ansible Tower modules</a>
to automate the transfer of your inventory into Ansible Tower. These
modules make it possible to use Ansible Playbooks to automate and manage
everything, including inventory, in your Ansible Tower instance. There
is a <a href="https://docs.ansible.com/ansible/latest/modules/tower_inventory_module.html#tower-inventory-module">tower_inventory module</a>
that will let us create an inventory, and there is a <a href="https://docs.ansible.com/ansible/latest/modules/tower_host_module.html#tower-host-module">tower_host module</a>
that lets us add a host to an existing inventory. Assume that we already
created an inventory called "Network Routers" and I will build an
Ansible Playbook to add all my routers in the group routers to that
inventory using the tower_host module. The Ansible Playbook will look
like this:</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NETWORK SETUP</span>
<span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">routers</span>
<span class="w">      </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">      </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<span class="w">      </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<span class="w">      </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ADD NETWORK HOSTS INTO TOWER</span>
<span class="w">          </span><span class="nt">tower_host</span><span class="p">:</span>
<span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                </span><span class="nt">inventory</span><span class="p">:</span><span class="w"> </span><span class="s">"Network</span><span class="nv"> </span><span class="s">Routers"</span>
<span class="w">                </span><span class="nt">tower_username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
<span class="w">                </span><span class="nt">tower_password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span>
<span class="w">                </span><span class="nt">tower_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://localhost</span>
<span class="w">                </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">ansible_network_os</span><span class="p">:</span><span class="w"> </span><span class="s">"{{ansible_network_os}}"</span>
<span class="w">                  </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="s">"{{ansible_host}}"</span>
<span class="w">                  </span><span class="nt">ansible_user</span><span class="p">:</span><span class="w"> </span><span class="s">"{{ansible_user}}"</span>
<span class="w">                  </span><span class="nt">ansible_connection</span><span class="p">:</span><span class="w"> </span><span class="s">"{{ansible_connection}}"</span>
<span class="w">                  </span><span class="nt">ansible_become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<span class="w">                  </span><span class="nt">ansible_become_method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable</span>
</pre></div>

<p>The Ansible Playbook will add all devices in the group routers
simultaneously. The playbook output will look similar to this:Â </p>
<p><img alt="Ansible-Playbook" src="../images/posts/archive/Ansible-Playbook.png"></p>
<p>The advantage of this method is you don't have to be on the control
node, you can run the Ansible Playbook from anywhere. Like the
awx-manage option, transferring your inventory to Ansible Tower with an
Ansible Playbook works well only if you will manage your inventory in
Tower in future. These two methods are migration strategies to Tower.
Ansible If you use dynamic inventory or source control to manage
inventory, you'd have to re-run the playbook for Ansible Tower every
time you changed your inventory.</p>
<h3>Setting Tower to access a git source-controlled inventory file</h3>
<p>The final method I want to cover in this post is using source control to
manage my inventory. I have a flat-file inventory file stored in a
Github repo. I made an example repo to illustrate this concept here:</p>
<p>https://github.com/ipvsean/sample_inventory</p>
<p>Unlike the previous two methods, this is not meant as a migration
strategy, but a more permanent way to manage your Ansible inventory
using git and source control. Inventory can be managed in Github and
Ansible Tower can simply reflect those changes.Â </p>
<p>First we need to create an Ansible Tower Project. An Ansible Tower
Project is how we can sync Ansible Tower to source code management (SCM)
system supported by Ansible Tower, including Git, Subversion, and
Mercurial. I will add a Project named Sean's Github, set the SCM Type to
Git, and put the SCM URL I listed above.</p>
<p><img alt="Tower project ui" src="../images/posts/archive/tower-project-ui.gif"></p>
<p>Now I need to create an Inventory that will use this Ansible Tower
project. I will:</p>
<ol>
<li>Create an inventory called Sean Github Inventory.</li>
<li>Add a Source called Sean Github Source, and choose the Ansible Tower
    Project previously created (named Sean's Github).</li>
<li>As soon as the Project is selected a drop down menu will appear and
    allow us to point directly the hosts flat-file.</li>
<li>Once you create the source you can sync it using the circular arrow
    sync button. The hosts and groups will automatically show up under
    the hosts button as shown in the animation below.</li>
</ol>
<p><img alt="github_inventory" src="../images/posts/archive/github_inventory.gif"></p>
<p>Using source control for managing inventory is popular with Ansible
Tower users and can scale really well.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="deep-dive-on-cli-command-for-network-automation/" class="u-url">Deep Dive on cli_command for Network Automation</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/sean-cavanaugh/">Sean Cavanaugh</a>
              </span>
            </p>
            <p class="dateline">
              <a href="deep-dive-on-cli-command-for-network-automation/" rel="bookmark">
                <time class="published dt-published" datetime="2019-02-06T00:00:00Z" itemprop="datePublished" title="2019-02-06 00:00">2019-02-06 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Deep Dive on cli_command for Network Automation</h2>
<p>In October Ansible 2.7 was released and brought us two powerful agnostic
network modules,
<a href="https://docs.ansible.com/ansible/latest/modules/cli_command_module.html">cli_command</a>
and
<a href="https://docs.ansible.com/ansible/latest/modules/cli_config_module.html">cli_config</a>.
Do you have two or more network vendors within your environment? The
goal of agnostic modules is to simplify Ansible Playbooks for network
engineers that deal with a variety of network platforms. Rather than
having to deal with platform specific modules (e.g. eos_config,
ios_config, junos_config), you can now use cli_command or cli_config to
reduce the amount of tasks and conditionals within a playbook, and make
the playbook easier to use. This post will demonstrate how to use these
modules and contrast them to platform specific modules. I'll show some
playbook examples and common use cases to help illustrate how you can
use these new platform agnostic modules.</p>
<p>Both the <code>cli_command</code> and <code>cli_config</code> only work with the
network_cli connection plugin.
The goal of network_cli is to make playbooks look, feel and operate on
network devices, the same way Ansible works on Linux hosts.</p>
<h3>What can you do with the cli_command?</h3>
<p>The cli_command allows you to run arbitrary commands on network devices.
Let's show a simple example using the cli_command, on an Arista vEOS device.</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN COMMAND AND PRINT TO TERMINAL WINDOW</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arista</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN ARISTA COMMAND</span>
<span class="w">  </span><span class="nt">cli_command</span><span class="p">:</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show ip interface brief</span>
<span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">command_output</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PRINT TO TERMINAL WINDOW</span>
<span class="w">  </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">"{{command_output.stdout}}"</span>
</pre></div>

<p>Previously this would require the eos_command module and would look
like this:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN COMMAND AND PRINT TO TERMINAL WINDOW</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arista</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN ARISTA COMMAND</span>
<span class="w">  </span><span class="nt">eos_command</span><span class="p">:</span>
<span class="w">    </span><span class="nt">commands</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show ip interface brief</span>
<span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">command_output</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PRINT TO TERMINAL WINDOW</span>
<span class="w">  </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">"{{command_output.stdout}}"</span>
</pre></div>

<p>Both Ansible Playbooks are simple and will output identically. This is
what it would look like:</p>
<p><img alt="screenshot" src="../images/posts/archive/Ansible-Agnostic--Network-Automation-Screen.png"></p>
<p>Now these two playbooks don't look much different yet, but when you add
multiple vendors the playbook complexity without these new agnostic
network modules can increase quickly. Previously if I had a mixed vendor
environment, I would see the playbook evolve a couple different ways.
Sometimes they would contain numerous conditionals (the when statement)
like this:</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN ARISTA COMMAND</span>
<span class="w">  </span><span class="nt">eos_command</span><span class="p">:</span>
<span class="w">    </span><span class="nt">commands</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show ip int br</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_network_os == 'eos'</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN CISCO NXOS COMMAND</span>
<span class="w">  </span><span class="nt">nxos_command</span><span class="p">:</span>
<span class="w">    </span><span class="nt">commands</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show ip int br</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_network_os == 'nxos'</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN JUNOS COMMAND</span>
<span class="w">  </span><span class="nt">junos_command</span><span class="p">:</span>
<span class="w">    </span><span class="nt">commands</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show interface terse</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_network_os == 'junos'</span>
</pre></div>

<p>Or somewhat better, network automation playbooks would evolve like this:</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN JUNOS COMMAND</span>
<span class="w">  </span><span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">â{{ansible_network_os}}â</span>
</pre></div>

<p>This second method is much cleaner. The include_tasks calls an Ansible
Playbook named eos.yml, ios.yml, nxos.yml, etc and runs the
corresponding command or tasks that were needed. While this is much
better because you can separate Ansible Playbooks based on the network
platform, it is still not as succinct or easy as agnostic modules. The
underlying functionality is the same, but the Ansible Playbooks become
much simpler.</p>
<p>The reason I bring up this include_tasks method is that there is still
going to be a time and place, even with agnostic modules, to separate
out the playbook logic. For example the command shown above for Juniper
is different compared to Arista and Cisco (show ip interface brief
versus show interface terse).</p>
<p>With the cli_command let's look at how we can make this agnostic
playbook for Cisco, Juniper and Arista extremely simple:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN COMMAND AND PRINT TO TERMINAL WINDOW</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">routers</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN SHOW COMMAND</span>
<span class="w">      </span><span class="nt">cli_command</span><span class="p">:</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">"{{show_interfaces}}"</span>
<span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">command_output</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PRINT TO TERMINAL WINDOW</span>
<span class="w">      </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">"{{command_output.stdout}}"</span>
</pre></div>

<p>Three <code>*os_command</code> tasks are reduced to one task. The show_interfaces
variable is stored as a group variable on a per-platform basis. For a
full example look at this <a href="https://github.com/network-automation/agnostic_example">GitHub repository</a>.</p>
<h3>Backup example</h3>
<p>Let's look at another use-case with the cli_command module. Backing up
network configurations is a common network operational task. Ansible
Network Automation modules have a backup parameter that helps network
engineers automate this mundane, yet critical, task. For example with
Arista EOS we can do this:</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BACKUP NETWORK CONFIGURATIONS</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arista</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BACKUP CONFIG</span>
<span class="w">      </span><span class="nt">eos_config</span><span class="p">:</span>
<span class="w">        </span><span class="nt">backup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</pre></div>

<p>The cli_command module does not have a backup parameter. Why? Because
the backup parameter can be quite inflexible and hard to manipulate. One
of the most common feature requests from Ansible users is for every
config module to be able to set the backup destination. Rather than
recreate an incredible amount of logic and code in each config module,
we can reuse an existing module. In this case we can leverage the
already widely used copy module!</p>
<div class="code"><pre class="code literal-block"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN COMMAND AND PRINT TO TERMINAL WINDOW</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arista</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RUN ARISTA COMMAND</span>
<span class="w">  </span><span class="nt">cli_command</span><span class="p">:</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show run</span>
<span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backup</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PRINT TO TERMINAL WINDOW</span>
<span class="w">  </span><span class="nt">copy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="s">"{{backup.stdout}}"</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">"{{inventory_hostname}}.backup"</span>
</pre></div>

<p>This becomes easy to manipulate what command output we want to save. In
this case it is the running configuration, but now we can switch to
startup-config just as easily. It also gives the user the control to
pick the backup destination directory and file name. An example of an
agnostic playbook for backups for Arista EOS, Juniper Junos and Cisco
IOS can be found here:</p>
<p>https://github.com/network-automation/agnostic_example</p>
<p>There are a lot of incredible things we can do with the agnostic modules
that help make our Ansible Network Automation Playbooks much more
succinct and simple. The cli_comand and cli_config modules have been in
the Ansible project since October 2018. Consider upgrading if you have
not already. If you are already using the cli_command or cli_config
module, please share! I will be highlighting more examples using
agnostic modules in subsequent blog posts so stay tuned.</p>
          </div>
      </article><br><hr>
<br><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title">
            <a href="ansible-tips-and-tricks-dealing-with-unreliable-connections-and-services/" class="u-url">Ansible Tips and Tricks, Dealing with Unreliable Connections and Services</a>
          </h1>
          <div class="metadata">
            <p class="byline author vcard">
              <span class="byline-name fn" itemprop="author">
                  <a href="../authors/sean-cavanaugh/">Sean Cavanaugh</a>
              </span>
            </p>
            <p class="dateline">
              <a href="ansible-tips-and-tricks-dealing-with-unreliable-connections-and-services/" rel="bookmark">
                <time class="published dt-published" datetime="2018-12-18T00:00:00Z" itemprop="datePublished" title="2018-12-18 00:00">2018-12-18 00:00</time></a>
            </p>
          </div>
        </header><div class="p-summary entry-summary">
            <h2>Ansible Tips and Tricks, Dealing with Unreliable Connections and Services</h2>
<p>Red Hat Ansible Automation is widely known to automate and configure
Linux and Windows hosts, as well as network automation for routers,
switches, firewalls and load balancers. Plus, there are a variety of
modules that deal with the cloud and the API around it such as Microsoft
Azure, Amazon Web Services (AWS) and Google Compute Engine.Â  And there
are other modules that interact with Software as a Service (SaaS) tools
like Slack or ServiceNow. Although the downtime for these APIs is very
minimal, it does happen, and it is even more likely that the connection
between your Ansible control host (where you are running Ansible from)
and the cloud-centric API could be down.</p>
<p>In this blog post, I will cover some tips and tricks for dealing with
unreliable connections to cloud-centric APIs and how I build Ansible
Playbooks in a reliable manner. As a technical marketing engineer, I
consider my customers the Red Hat field teams, and often Solutions
Architects are running playbooks from unreliable hotel wireless, coffee
shops and sometimes even airplanes! I have to make sure playbooks have
some more robustness built in for these odd situations. It is
hair-pulling frustrating to get through a 20 task playbook for it to
fail on the 19th task because your wireless went out for a couple
seconds. This is especially frustrating if you are at the airport just
trying to setup a demo or playground to show something to a client.</p>
<h3>The Until Loop</h3>
<p>Many people that use Ansible are very familiar with the loop construct.
A loop (previously known as with_items) is very simple and powerful and
allows you to iterate over a list or dictionary in an easy fashion.
However, I find that many people are not aware of the until loop. Let us
look at how this can work.</p>
<p>The module
<a href="https://docs.ansible.com/ansible/latest/modules/ec2_vpc_net_module.html">ec2_vpc_net</a>
allows us to create an AWS Virtual Private Cloud.</p>
<div class="code"><pre class="code literal-block"><span class="o">-</span><span class="w"> </span><span class="nl">name:</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">AWS</span><span class="w"> </span><span class="n">VPC</span><span class="w"> </span><span class="n">sean</span><span class="o">-</span><span class="n">vpc</span>
<span class="w">  </span><span class="nl">ec2_vpc_net:</span>
<span class="w">    </span><span class="nl">name:</span><span class="w"> </span><span class="s">"sean-vpcâ</span>
<span class="w">    </span><span class="nl">cidr_block:</span><span class="w"> </span><span class="s">"192.168.1.0/16â</span>
<span class="w">    </span><span class="nl">region:</span><span class="w"> </span><span class="s">"us-east-1â</span>
<span class="w">  </span><span class="nl">register:</span><span class="w"> </span><span class="n">create_vpc</span>
<span class="w">  </span><span class="nl">until:</span><span class="w"> </span><span class="n">create_vpc</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">failed</span>
<span class="w">  </span><span class="nl">retries:</span><span class="w"> </span><span class="mh">5</span>
</pre></div>

<p>The name, cidr_block and region are module parameters for the
ec2_vpc_net module. However the register, until and retries are task
level parameters, meaning that you can use these on any module. This
task will attempt to create the VPC five times before it gives up and
fails.</p>
<p>Let's step back a minute to see how this works. Each time we run a task
there are some common variables that the task returns to let us know how
the task performed:</p>
<div class="code"><pre class="code literal-block"><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">playbook</span>
<span class="w">  </span><span class="n">hosts</span><span class="p">:</span><span class="w"> </span><span class="n">localhost</span>
<span class="w">  </span><span class="n">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="bp">false</span>

<span class="w">  </span><span class="n">tasks</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">dumb</span><span class="w"> </span><span class="n">easy</span><span class="w"> </span><span class="n">command</span>
<span class="w">        </span><span class="n">shell</span><span class="p">:</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="o">-</span><span class="n">la</span>
<span class="w">        </span><span class="n">register</span><span class="p">:</span><span class="w"> </span><span class="n">task_variable</span>

<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">debug</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">var</span>
<span class="w">        </span><span class="n">debug</span><span class="p">:</span>
<span class="w">          </span><span class="k">var</span><span class="p">:</span><span class="w"> </span><span class="n">task_variable</span>
</pre></div>

<p>When we run this playbook with ansible-playbook test_output.yml we get
some standard output (via the debug module) printed to the terminal
window (or browser window when using Ansible Tower).</p>
<div class="code"><pre class="code literal-block"><span class="n">TASK</span><span class="w"> </span><span class="o">[</span><span class="n">debug the var</span><span class="o">]</span><span class="w"> </span><span class="o">**************************************************************</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">localhost</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w"> </span><span class="nl">task_variable</span><span class="p">:</span>
<span class="w">      </span><span class="nl">changed</span><span class="p">:</span><span class="w"> </span><span class="k">true</span>
<span class="w">      </span><span class="nl">cmd</span><span class="p">:</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="o">-</span><span class="n">la</span>
<span class="w">      </span><span class="nl">delta</span><span class="p">:</span><span class="w"> </span><span class="s1">'0:00:00.011018'</span>
<span class="w">      </span><span class="k">end</span><span class="err">:</span><span class="w"> </span><span class="s1">'2018-12-07 09:53:14.595811'</span>
<span class="w">      </span><span class="nl">failed</span><span class="p">:</span><span class="w"> </span><span class="k">false</span>
<span class="p">...</span>
</pre></div>

<p>One of the key, value pairs we always get returned from any Ansible task
is a <strong>failed</strong> key. If the task completed successfully the task will
return a failed: false. If the task failed, the task will return a
failed: true. Looking back at the until loop logic for the AWS VPC task:</p>
<div class="code"><pre class="code literal-block"><span class="n">register</span><span class="o">:</span><span class="w"> </span><span class="n">create_vpc</span>
<span class="n">until</span><span class="o">:</span><span class="w"> </span><span class="n">create_vpc</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">failed</span>
<span class="n">retries</span><span class="o">:</span><span class="w"> </span><span class="mi">5</span>
</pre></div>

<p>We are registering the result of the task so we can look at the failed
key, value pair. The until value is the conditional we are applying. In
this case we keep running the task until the create_vpc does not have
failed: true. However we don't want the task to run this for infinity.
The default value for "retries" is 3, however I have increased this to 5.
The until loop provides significant robustness to the task.
There is also a delay parameter that can be combined with the until
loop.Â  The delay is how much time to wait between retries.Â  The default
value for the delay is 5 seconds.Â  Check out the
<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html#do-until-loops">documentation</a>
for more details and examples of the until loop and the delay parameter.</p>
<h4>Changing What A Failure Means</h4>
<p>By default, if Ansible fails the playbook will end on that task, for the
respective host it was running on. If I had a playbook running on 10
hosts, and it failed on 1 host on task three out of ten, the 7
subsequent tasks would not run for that host. The other hosts would
remain unaffected.</p>
<p>With unreliable connections to an outside API we need to think about
what is required and not required to define success for a playbook to
finish. For example if you had a task spin up a DNS record on AWS's
Route53 service, the DNS can be nice to have, but isn't required for you
to begin using the instance you created. I can use an until loop to make
the route53 tasks more reliable, but it might be OK if the Route53
service is down and unusable. I can use the IP address to get some work
done done on my instance until I get a more reliable internet connection
to re-run the playbook or the Route53 service becomes available again.
There are some tasks that are "nice to have" vs. required.</p>
<p>The way to ignore a failed value is to use the <strong>ignore_errors</strong>
parameter which is a task level parameter outlined in the 
<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_error_handling.html">documentation here</a>.
I think there is plenty of content in the docs and various blogs about
using the ignore_errors so I think it is sufficient to summarize that
ignore_errors will show red and report a failed: true key, value pair,
but the playbook will continue on.</p>
<p>What happens if we want to combine the until loop with an ignore_errors?</p>
<div class="code"><pre class="code literal-block"><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">playbook</span>
<span class="w">  </span><span class="n">hosts</span><span class="p">:</span><span class="w"> </span><span class="n">localhost</span>
<span class="w">  </span><span class="n">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="bp">false</span>
<span class="w">  </span><span class="n">tasks</span><span class="p">:</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">purposely</span><span class="w"> </span><span class="n">fail</span>
<span class="w">      </span><span class="n">shell</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="bp">false</span>
<span class="w">      </span><span class="n">register</span><span class="p">:</span><span class="w"> </span><span class="n">task_register_var</span>
<span class="w">      </span><span class="n">until</span><span class="p">:</span><span class="w"> </span><span class="n">task_register_var</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">failed</span>
<span class="w">      </span><span class="n">retries</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">      </span><span class="n">ignore_errors</span><span class="p">:</span><span class="w"> </span><span class="n">yes</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">debug</span><span class="w"> </span><span class="n">task_register_var</span>
<span class="w">      </span><span class="n">debug</span><span class="p">:</span>
<span class="w">        </span><span class="n">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ task_register_var }}"</span>
</pre></div>

<p>We actually get the best of both worlds with an unreliable task. We get
robustness with the until loop, combined with an ignore_errors which
allows the playbook to complete regardless of that task completing
successfully. I find myself using this combination of ignore_errors and
until loops in conjunction with services like Let's Encrypt where it's
not 100% required for me to have an SSL cert to start using the web app
(I can rely on a self-signed cert until I can figure out the problem).</p>
<p>The Ansible Playbook outputs like this:</p>
<div class="code"><pre class="code literal-block"><span class="n">TASK</span><span class="w"> </span><span class="p">[</span><span class="n">purposely</span><span class="w"> </span><span class="n">fail</span><span class="p">]</span><span class="w"> </span><span class="o">*************************************************************</span>
<span class="n">FAILED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">RETRYING</span><span class="o">:</span><span class="w"> </span><span class="n">purposely</span><span class="w"> </span><span class="n">fail</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="n">retries</span><span class="w"> </span><span class="n">left</span><span class="p">).</span>
<span class="n">FAILED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">RETRYING</span><span class="o">:</span><span class="w"> </span><span class="n">purposely</span><span class="w"> </span><span class="n">fail</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">retries</span><span class="w"> </span><span class="n">left</span><span class="p">).</span>
<span class="n">FAILED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">RETRYING</span><span class="o">:</span><span class="w"> </span><span class="n">purposely</span><span class="w"> </span><span class="n">fail</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="n">retries</span><span class="w"> </span><span class="n">left</span><span class="p">).</span>
<span class="n">FAILED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">RETRYING</span><span class="o">:</span><span class="w"> </span><span class="n">purposely</span><span class="w"> </span><span class="n">fail</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">retries</span><span class="w"> </span><span class="n">left</span><span class="p">).</span>
<span class="n">FAILED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">RETRYING</span><span class="o">:</span><span class="w"> </span><span class="n">purposely</span><span class="w"> </span><span class="n">fail</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="n">retries</span><span class="w"> </span><span class="n">left</span><span class="p">).</span>
<span class="nl">fatal</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">localhost</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="n">FAILED</span><span class="o">!</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">changed</span><span class="o">=</span><span class="nb">true</span>
<span class="w">  </span><span class="nl">attempts</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">  </span><span class="nl">cmd</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="nb">false</span>
<span class="w">  </span><span class="nl">delta</span><span class="p">:</span><span class="w"> </span><span class="err">'</span><span class="mi">0</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mf">00.007936</span><span class="err">'</span>
<span class="w">  </span><span class="nl">end</span><span class="p">:</span><span class="w"> </span><span class="err">'</span><span class="mi">2018-12</span><span class="mo">-07</span><span class="w"> </span><span class="mi">13</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mf">13.277624</span><span class="err">'</span>
<span class="w">  </span><span class="nl">msg</span><span class="p">:</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">zero</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">code</span>
<span class="w">  </span><span class="nl">rc</span><span class="p">:</span><span class="w"> </span><span class="mi">127</span>
<span class="w">  </span><span class="nl">start</span><span class="p">:</span><span class="w"> </span><span class="err">'</span><span class="mi">2018-12</span><span class="mo">-07</span><span class="w"> </span><span class="mi">13</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mf">13.269688</span><span class="err">'</span>
<span class="w">  </span><span class="nl">stderr</span><span class="p">:</span><span class="w"> </span><span class="err">'</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="o">:</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="nb">false</span><span class="o">:</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">directory</span><span class="err">'</span>
<span class="w">  </span><span class="nl">stderr_lines</span><span class="p">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="err">'</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="o">:</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="nb">false</span><span class="o">:</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">directory</span><span class="err">'</span>
<span class="w">  </span><span class="nl">stdout</span><span class="p">:</span><span class="w"> </span><span class="err">''</span>
<span class="w">  </span><span class="nl">stdout_lines</span><span class="p">:</span>
<span class="p">...</span><span class="n">ignoring</span>

<span class="n">TASK</span><span class="w"> </span><span class="p">[</span><span class="n">debug</span><span class="w"> </span><span class="n">task_register_var</span><span class="p">]</span><span class="w"> </span><span class="o">****************************************************</span>
<span class="w">  </span><span class="nl">msg</span><span class="p">:</span>
<span class="w">    </span><span class="nl">attempts</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="nl">changed</span><span class="p">:</span><span class="w"> </span><span class="nb">true</span>
</pre></div>

<p>In the Ansible workshops I am actually using this combination of error
handling for Let's Encrypt to make it easy for Ansible users to
troubleshoot the issue.Â  If there are any tasks that have a failure that
can be skipped, I can add it to a variable and print it at the end of
the workshop playbook (the playbook responsible for provisioning
instances for students to use).</p>
<div class="code"><pre class="code literal-block"><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">playbook</span>
<span class="w">  </span><span class="n">hosts</span><span class="p">:</span><span class="w"> </span><span class="n">localhost</span>
<span class="w">  </span><span class="n">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="bp">false</span>
<span class="w">  </span><span class="n">vars</span><span class="p">:</span>
<span class="w">    </span><span class="n">summary_information</span><span class="p">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="n">PROVISIONER</span><span class="w"> </span><span class="n">SUMMARY</span>
<span class="w">      </span><span class="o">*******************</span>

<span class="w">  </span><span class="n">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">ISSUE</span><span class="w"> </span><span class="n">CERT</span>
<span class="w">      </span><span class="n">shell</span><span class="p">:</span><span class="w"> </span><span class="n">certbot</span><span class="w"> </span><span class="n">certonly</span><span class="w"> </span><span class="o">--</span><span class="n">standalone</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">student1</span><span class="o">.</span><span class="n">testworkshop</span><span class="o">.</span><span class="n">rhdemo</span><span class="o">.</span><span class="n">io</span><span class="w"> </span><span class="o">--</span><span class="n">email</span><span class="w"> </span><span class="n">ansible</span><span class="o">-</span><span class="n">network</span><span class="err">@</span><span class="n">redhat</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="o">--</span><span class="n">noninteractive</span><span class="w"> </span><span class="o">--</span><span class="n">agree</span><span class="o">-</span><span class="n">tos</span>
<span class="w">      </span><span class="n">register</span><span class="p">:</span><span class="w"> </span><span class="n">issue_cert</span>
<span class="w">      </span><span class="n">until</span><span class="p">:</span><span class="w"> </span><span class="n">issue_cert</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">failed</span>
<span class="w">      </span><span class="n">retries</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">      </span><span class="n">ignore_errors</span><span class="p">:</span><span class="w"> </span><span class="n">yes</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">facts</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">output</span>
<span class="w">      </span><span class="n">set_fact</span><span class="p">:</span>
<span class="w">      </span><span class="n">summary_information</span><span class="p">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="p">{{</span><span class="n">summary_information</span><span class="p">}}</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Lets</span><span class="w"> </span><span class="n">Encrypt</span><span class="w"> </span><span class="n">certbot</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">please</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">letsencrypt</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">running</span>
<span class="w">      </span><span class="n">when</span><span class="p">:</span><span class="w"> </span><span class="n">issue_cert</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">failed</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">print</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">summary</span><span class="w"> </span><span class="n">information</span>
<span class="w">      </span><span class="n">debug</span><span class="p">:</span>
<span class="w">        </span><span class="n">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{summary_information}}"</span>
</pre></div>

<p>This prints out a very easy to understand message to the terminal window:</p>
<p><img alt="Terminal Readout" src="../images/posts/archive/Ansible-Networking-Tips-Tricks-Terminal-Screenshot.png"></p>
<p>In conclusion, Ansible is extremely flexible at adding some additional
logic when it is necessary. The until loop can add robustness and the
ignore_errors allows us to determine success criteria. In combination
your Ansible Playbooks can be much more user proof, allowing you to have
a proactive vs. a reactive approach to troubleshooting issues. Ansible
can't control if an API or service is down, but we can definitely
operate more robustly than home made scripts or DIY API implementations.
The playbooks provided are extremely human readable and easy for novice
users to understand.</p>
          </div>
      </article><br><hr>
<br>
</div>
          <ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-4.html" rel="prev">Newer posts</a></li>
            <li class="next"><a href="index-2.html" rel="next">Older posts</a></li>
        </ul>
<!--End of body content-->
</div>
        <div class="content-slim redhat-footer">
      <div class="footer-left">
        <ul class="footer-left-links">
<li>
            <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a>
          </li>
          <li>
            <a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy policy</a>
          </li>
          <li>
            <a href="https://docs.ansible.com/ansible/latest/community/code_of_conduct.html" target="_blank">Code of conduct</a>
          </li>
        </ul>
</div>
      <div class="footer-right">
        <span class="redhat">Powered by</span>
        <span class="redhat-logo">
          <a href="https://www.redhat.com/en/technologies/management/ansible" target="_blank">
            <img src="../assets/images/redhat_reversed.svg" alt="Red Hat logo." width="96" height="28"></a>
        </span>
      </div>
    </div>

</div>

            <script src="../assets/js/jquery.min.js"></script><script src="../assets/js/popper.min.js"></script><script src="../assets/js/bootstrap.min.js"></script><script src="../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script><script src="../assets/js/clipboard.min.js" type="text/javascript"></script><script src="../assets/js/clipboard.js" type="text/javascript"></script>
</body>
</html>
