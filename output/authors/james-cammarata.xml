<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="../assets/xml/rss.xsl" media="all"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Ansible Collaborative (Posts by James Cammarata)</title><link>https://ansible.com/</link><description></description><atom:link href="https://ansible.com/authors/james-cammarata.xml" rel="self" type="application/rss+xml"></atom:link><language>en</language><copyright>Contents © 2024 &lt;a href="mailto:website@ansible.community"&gt;Ansible Collaborative, et al&lt;/a&gt; </copyright><lastBuildDate>Tue, 19 Mar 2024 16:48:34 GMT</lastBuildDate><generator>Nikola (getnikola.com)</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>Kubernetes Operators with Ansible Deep Dive, Part 2</title><link>https://ansible.com/blog/kubernetes-operators-ansible-deep-dive-part-2/</link><dc:creator>James Cammarata</dc:creator><description>&lt;h2&gt;Kubernetes Operators with Ansible Deep Dive, Part 2&lt;/h2&gt;
&lt;p&gt;In part 1 of this series, we looked at operators overall, and what they do in
OpenShift/Kubernetes. We peeked at the Operator SDK, and why you'd want
to use an Ansible Operator rather than other kinds of operators provided
by the SDK. We also explored how Ansible Operators are structured and
the relevant files created by the Operator SDK when building Kubernetes
Operators with Ansible.&lt;/p&gt;
&lt;p&gt;In this the second part of this deep dive series, we'll:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Take a look at creating an OpenShift Project and deploying a Galera Operator.&lt;/li&gt;
&lt;li&gt;Next we'll check the MySQL cluster, then setup and test a Galera cluster.&lt;/li&gt;
&lt;li&gt;Then we'll test scaling down, disaster recovery, and demonstrate cleaning up.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Creating the project and deploying the operator&lt;/h3&gt;
&lt;p&gt;We start by creating a new project in OpenShift, which we'll simply call &lt;code&gt;test&lt;/code&gt;:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;new-project&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--display-name&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"Testing Ansible Operator"&lt;/span&gt;
Now&lt;span class="w"&gt; &lt;/span&gt;using&lt;span class="w"&gt; &lt;/span&gt;project&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"test"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;on&lt;span class="w"&gt; &lt;/span&gt;server&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"https://ec2-xx-yy-zz-1.us-east-2.compute.amazonaws.com:8443"&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;We won't delve too much into this role, however the basic operation is:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Use &lt;code&gt;set_fact&lt;/code&gt; to generate variables using the &lt;code&gt;k8s&lt;/code&gt; lookup plugin or other variables defined in &lt;code&gt;defaults/main.yml&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Determine if any corrective action needs to be taken based on the above variables.
    For example, one variable determines how many Galera node pods are currently running.
    This is compared against the variable defined on the &lt;code&gt;CustomResource&lt;/code&gt;.
    If they differ, the role will add or remove pods as needed.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;To begin the deployment, we have a simple script, which builds the operator image and pushes it to the OpenShift registry for
the &lt;code&gt;test&lt;/code&gt; project:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;cat&lt;span class="w"&gt; &lt;/span&gt;./create_operator.sh
&lt;span class="c1"&gt;#!/bin/bash&lt;/span&gt;

docker&lt;span class="w"&gt; &lt;/span&gt;build&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="w"&gt; &lt;/span&gt;docker-registry-default.router.default.svc.cluster.local/test/galera-ansible-operator:latest&lt;span class="w"&gt; &lt;/span&gt;.
docker&lt;span class="w"&gt; &lt;/span&gt;push&lt;span class="w"&gt; &lt;/span&gt;docker-registry-default.router.default.svc.cluster.local/test/galera-ansible-operator:latest
kubectl&lt;span class="w"&gt; &lt;/span&gt;create&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/operator.yaml
kubectl&lt;span class="w"&gt; &lt;/span&gt;create&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/cr.yaml
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Before we run this script, we need to first deploy the RBAC rules and
custom resource definition for our Galera example:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;create&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/rbac.yaml
clusterrole&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"galera-ansible-operator"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;created
clusterrolebinding&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"default-account-app-operator"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;created
$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;create&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/crd.yaml
customresourcedefinition&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"galeraservices.galera.database.coreos.com"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;created
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now, we run the script (after using the login command to allow docker to
connect to the OpenShift registry we created):&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;docker&lt;span class="w"&gt; &lt;/span&gt;login&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;whoami&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-u&lt;span class="w"&gt; &lt;/span&gt;unused&lt;span class="w"&gt; &lt;/span&gt;docker-registry-default.router.default.svc.cluster.local
Login&lt;span class="w"&gt; &lt;/span&gt;Succeeded

$&lt;span class="w"&gt; &lt;/span&gt;./create_operator.sh
Sending&lt;span class="w"&gt; &lt;/span&gt;build&lt;span class="w"&gt; &lt;/span&gt;context&lt;span class="w"&gt; &lt;/span&gt;to&lt;span class="w"&gt; &lt;/span&gt;Docker&lt;span class="w"&gt; &lt;/span&gt;daemon&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;490&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;kB
...
deployment.apps/galera-ansible-operator&lt;span class="w"&gt; &lt;/span&gt;created
galeraservice&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"galera-example"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;created
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In short order, we will see the galera-ansible-operator pod start up,
followed by a single pod named galera-node-0001 and a LoadBalancer
service which provides our ingress to our Galera cluster:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;all
NAME&lt;span class="w"&gt; &lt;/span&gt;DOCKER&lt;span class="w"&gt; &lt;/span&gt;REPO&lt;span class="w"&gt; &lt;/span&gt;TAGS&lt;span class="w"&gt; &lt;/span&gt;UPDATED
is/galera-ansible-operator&lt;span class="w"&gt; &lt;/span&gt;docker-registry-default.router...:5000/test/galera-ansible-operator&lt;span class="w"&gt; &lt;/span&gt;latest&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;hours&lt;span class="w"&gt; &lt;/span&gt;ago

NAME&lt;span class="w"&gt; &lt;/span&gt;DESIRED&lt;span class="w"&gt; &lt;/span&gt;CURRENT&lt;span class="w"&gt; &lt;/span&gt;UP-TO-DATE&lt;span class="w"&gt; &lt;/span&gt;AVAILABLE&lt;span class="w"&gt; &lt;/span&gt;AGE
deploy/galera-ansible-operator&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;4m

NAME&lt;span class="w"&gt; &lt;/span&gt;CLUSTER-IP&lt;span class="w"&gt; &lt;/span&gt;EXTERNAL-IP&lt;span class="w"&gt; &lt;/span&gt;PORT&lt;span class="o"&gt;(&lt;/span&gt;S&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;AGE
svc/galera-external-loadbalancer&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;172&lt;/span&gt;.30.251.195&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;172&lt;/span&gt;.29.17.210,172.29.17.210&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;33066&lt;/span&gt;:30072/TCP&lt;span class="w"&gt; &lt;/span&gt;1m
svc/glusterfs-dynamic-galera-node-0001-mysql-data&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;172&lt;/span&gt;.30.49.250&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;none&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/TCP&lt;span class="w"&gt; &lt;/span&gt;1m

NAME&lt;span class="w"&gt; &lt;/span&gt;DESIRED&lt;span class="w"&gt; &lt;/span&gt;CURRENT&lt;span class="w"&gt; &lt;/span&gt;READY&lt;span class="w"&gt; &lt;/span&gt;AGE
rs/galera-ansible-operator-bc6cd548&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;4m

NAME&lt;span class="w"&gt; &lt;/span&gt;READY&lt;span class="w"&gt; &lt;/span&gt;STATUS&lt;span class="w"&gt; &lt;/span&gt;RESTARTS&lt;span class="w"&gt; &lt;/span&gt;AGE
po/galera-ansible-operator-bc6cd548-46b2r&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;4m
po/galera-node-0001&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;1m
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Verifying the MySQL cluster, initial setup and testing&lt;/p&gt;
&lt;p&gt;We can use the describe function to see the status of our custom
resource, specifically the size we specified:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;kubectl&lt;span class="w"&gt; &lt;/span&gt;describe&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/cr.yaml&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;size
Galera&lt;span class="w"&gt; &lt;/span&gt;_&lt;span class="w"&gt; &lt;/span&gt;Cluster&lt;span class="w"&gt; &lt;/span&gt;_&lt;span class="w"&gt; &lt;/span&gt;Size:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now that we have a MySQL cluster, let's test it using
&lt;a href="https://github.com/akopytov/sysbench"&gt;sysbench&lt;/a&gt;.
As mentioned above, we have a system from which to do the testing so we
can avoid internet round trips. But first, we'll need some info. We
need to know the forwarded port we can connect to through the load
balancing service created as part of the operator deployment:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;services
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next, we need to know the IP of the master. We can get this with &lt;code&gt;oc describe&lt;/code&gt;:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;describe&lt;span class="w"&gt; &lt;/span&gt;node&lt;span class="w"&gt; &lt;/span&gt;ec2-xx-yy-zz-1.us-east-2.compute.amazonaws.com&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;^Addresses
Addresses:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.0.46,ec2-xx-yy-zz-1.us-east-2.compute.amazonaws.com
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So for this test, we'll be connecting to the IP 10.0.0.46 on port
XXXXX. The port value 33066 was specified in the spec above, and is the
port which will receive the forwarded traffic. We'll export those to
make it a little easier to re-use our test commands.&lt;/p&gt;
&lt;p&gt;From the test server:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;export&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;MYSQL_IP&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.0.46
$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;export&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;MYSQL_PORT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;XXXXX
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Before running sysbench, we need to create the database it expects
(future versions of the Galera operator will be able to do this
automatically):&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;mysql&lt;span class="w"&gt; &lt;/span&gt;-h&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$MYSQL_IP&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--port&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nv"&gt;$MYSQL_PORT&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-u&lt;span class="w"&gt; &lt;/span&gt;root&lt;span class="w"&gt; &lt;/span&gt;-e&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'create database sbtest;'&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next, we'll prepare the test by running sysbench using the OLTP
read-only test with a table of 1 million rows:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;sysbench&lt;span class="w"&gt; &lt;/span&gt;--db-driver&lt;span class="o"&gt;=&lt;/span&gt;mysql&lt;span class="w"&gt; &lt;/span&gt;--threads&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;150&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-host&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;MYSQL_IP&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-port&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;MYSQL_PORT&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-user&lt;span class="o"&gt;=&lt;/span&gt;root&lt;span class="w"&gt; &lt;/span&gt;--mysql-password&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-ignore-errors&lt;span class="o"&gt;=&lt;/span&gt;all&lt;span class="w"&gt; &lt;/span&gt;--table-size&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1000000&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/usr/share/sysbench/oltp_read_only.lua&lt;span class="w"&gt; &lt;/span&gt;prepare
sysbench&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;.0.9&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;using&lt;span class="w"&gt; &lt;/span&gt;system&lt;span class="w"&gt; &lt;/span&gt;LuaJIT&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.0.4&lt;span class="o"&gt;)&lt;/span&gt;
Initializing&lt;span class="w"&gt; &lt;/span&gt;worker&lt;span class="w"&gt; &lt;/span&gt;threads...
Creating&lt;span class="w"&gt; &lt;/span&gt;table&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'sbtest1'&lt;/span&gt;...
Inserting&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1000000&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;records&lt;span class="w"&gt; &lt;/span&gt;into&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'sbtest1'&lt;/span&gt;
Creating&lt;span class="w"&gt; &lt;/span&gt;a&lt;span class="w"&gt; &lt;/span&gt;secondary&lt;span class="w"&gt; &lt;/span&gt;index&lt;span class="w"&gt; &lt;/span&gt;on&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'sbtest1'&lt;/span&gt;

...
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Note that we use 150 threads here, as a single MySQL/MariaDB instance
defaults to this size for its maximum connections allowed.&lt;/p&gt;
&lt;p&gt;So now that everything's ready, lets run our first test with sysbench:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;sysbench&lt;span class="w"&gt; &lt;/span&gt;--db-driver&lt;span class="o"&gt;=&lt;/span&gt;mysql&lt;span class="w"&gt; &lt;/span&gt;--threads&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;150&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-host&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;MYSQL_IP&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-port&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;MYSQL_PORT&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-user&lt;span class="o"&gt;=&lt;/span&gt;root&lt;span class="w"&gt; &lt;/span&gt;--mysql-password&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-ignore-errors&lt;span class="o"&gt;=&lt;/span&gt;all&lt;span class="w"&gt; &lt;/span&gt;/usr/share/sysbench/oltp_read_only.lua&lt;span class="w"&gt; &lt;/span&gt;run
sysbench&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;.0.9&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;using&lt;span class="w"&gt; &lt;/span&gt;system&lt;span class="w"&gt; &lt;/span&gt;LuaJIT&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.0.4&lt;span class="o"&gt;)&lt;/span&gt;
Running&lt;span class="w"&gt; &lt;/span&gt;the&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;with&lt;span class="w"&gt; &lt;/span&gt;following&lt;span class="w"&gt; &lt;/span&gt;options:
Number&lt;span class="w"&gt; &lt;/span&gt;of&lt;span class="w"&gt; &lt;/span&gt;threads:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;150&lt;/span&gt;
Initializing&lt;span class="w"&gt; &lt;/span&gt;random&lt;span class="w"&gt; &lt;/span&gt;number&lt;span class="w"&gt; &lt;/span&gt;generator&lt;span class="w"&gt; &lt;/span&gt;from&lt;span class="w"&gt; &lt;/span&gt;current&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;time&lt;/span&gt;
Initializing&lt;span class="w"&gt; &lt;/span&gt;worker&lt;span class="w"&gt; &lt;/span&gt;threads...
Threads&lt;span class="w"&gt; &lt;/span&gt;started!
SQL&lt;span class="w"&gt; &lt;/span&gt;statistics:
&lt;span class="w"&gt;    &lt;/span&gt;queries&lt;span class="w"&gt; &lt;/span&gt;performed:
&lt;span class="w"&gt;        &lt;/span&gt;read:&lt;span class="w"&gt;                            &lt;/span&gt;&lt;span class="m"&gt;174776&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;write:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;other:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;24968&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;total:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;199744&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;transactions:&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="m"&gt;12484&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;1239&lt;/span&gt;.55&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;queries:&lt;span class="w"&gt;                             &lt;/span&gt;&lt;span class="m"&gt;199744&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;19832&lt;/span&gt;.77&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;ignored&lt;span class="w"&gt; &lt;/span&gt;errors:&lt;span class="w"&gt;                      &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;.00&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;reconnects:&lt;span class="w"&gt;                          &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;.00&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
General&lt;span class="w"&gt; &lt;/span&gt;statistics:
&lt;span class="w"&gt;    &lt;/span&gt;total&lt;span class="w"&gt; &lt;/span&gt;time:&lt;span class="w"&gt;                          &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0700s
&lt;span class="w"&gt;    &lt;/span&gt;total&lt;span class="w"&gt; &lt;/span&gt;number&lt;span class="w"&gt; &lt;/span&gt;of&lt;span class="w"&gt; &lt;/span&gt;events:&lt;span class="w"&gt;              &lt;/span&gt;&lt;span class="m"&gt;12484&lt;/span&gt;
Latency&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;ms&lt;span class="o"&gt;)&lt;/span&gt;:
&lt;span class="w"&gt;         &lt;/span&gt;min:&lt;span class="w"&gt;                                  &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;.82
&lt;span class="w"&gt;         &lt;/span&gt;avg:&lt;span class="w"&gt;                                &lt;/span&gt;&lt;span class="m"&gt;120&lt;/span&gt;.66
&lt;span class="w"&gt;         &lt;/span&gt;max:&lt;span class="w"&gt;                               &lt;/span&gt;&lt;span class="m"&gt;1028&lt;/span&gt;.51
&lt;span class="w"&gt;         &lt;/span&gt;95th&lt;span class="w"&gt; &lt;/span&gt;percentile:&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="m"&gt;292&lt;/span&gt;.60
&lt;span class="w"&gt;         &lt;/span&gt;sum:&lt;span class="w"&gt;                            &lt;/span&gt;&lt;span class="m"&gt;1506263&lt;/span&gt;.71
Threads&lt;span class="w"&gt; &lt;/span&gt;fairness:
&lt;span class="w"&gt;    &lt;/span&gt;events&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;avg/stddev&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt;           &lt;/span&gt;&lt;span class="m"&gt;83&lt;/span&gt;.2267/42.84
&lt;span class="w"&gt;    &lt;/span&gt;execution&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;avg/stddev&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0418/0.02
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This was just one run, but re-running a few times produces similar
results. So our one-node cluster can process about 20K queries/second.
But a cluster with only one member isn't very useful - so lets scale it
up. We do this by editing the custom resource we defined earlier and
changing the &lt;code&gt;galera_cluster_size&lt;/code&gt; variable.
For now, we'll spin up to a three-node cluster:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;edit&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/cr.yaml
galeraservice.galera.database.coreos.com/galera-example&lt;span class="w"&gt; &lt;/span&gt;edited
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next, we can verify OpenShift sees this new value:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;kubectl&lt;span class="w"&gt; &lt;/span&gt;describe&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/cr.yaml&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;size
Galera&lt;span class="w"&gt; &lt;/span&gt;_&lt;span class="w"&gt; &lt;/span&gt;Cluster&lt;span class="w"&gt; &lt;/span&gt;_&lt;span class="w"&gt; &lt;/span&gt;Size:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And in short order, we see the Ansible operator receive an event
signalling the change and start working to update the cluster:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;pods
NAME&lt;span class="w"&gt; &lt;/span&gt;READY&lt;span class="w"&gt; &lt;/span&gt;STATUS&lt;span class="w"&gt; &lt;/span&gt;RESTARTS&lt;span class="w"&gt; &lt;/span&gt;AGE
galera-ansible-operator-bc6cd548-46b2r&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;30m
galera-node-0001&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;26m
galera-node-0002&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;1m
galera-node-0003&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;56s
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And after about a minute (each Galera node has to start and sync data from another member), we see the new pods become ready:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;pods
NAME&lt;span class="w"&gt; &lt;/span&gt;READY&lt;span class="w"&gt; &lt;/span&gt;STATUS&lt;span class="w"&gt; &lt;/span&gt;RESTARTS&lt;span class="w"&gt; &lt;/span&gt;AGE
galera-ansible-operator-bc6cd548-46b2r&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;31m
galera-node-0001&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;27m
galera-node-0002&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;2m
galera-node-0003&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;2m
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now that we have a three node cluster, we can re-run the same test as earlier:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;sysbench&lt;span class="w"&gt; &lt;/span&gt;--db-driver&lt;span class="o"&gt;=&lt;/span&gt;mysql&lt;span class="w"&gt; &lt;/span&gt;--threads&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;150&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-host&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;MYSQL_IP&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-port&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;MYSQL_PORT&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-user&lt;span class="o"&gt;=&lt;/span&gt;root&lt;span class="w"&gt; &lt;/span&gt;--mysql-password&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-ignore-errors&lt;span class="o"&gt;=&lt;/span&gt;all&lt;span class="w"&gt; &lt;/span&gt;/usr/share/sysbench/oltp_read_only.lua&lt;span class="w"&gt; &lt;/span&gt;run
sysbench&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;.0.9&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;using&lt;span class="w"&gt; &lt;/span&gt;system&lt;span class="w"&gt; &lt;/span&gt;LuaJIT&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.0.4&lt;span class="o"&gt;)&lt;/span&gt;
Running&lt;span class="w"&gt; &lt;/span&gt;the&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;with&lt;span class="w"&gt; &lt;/span&gt;following&lt;span class="w"&gt; &lt;/span&gt;options:
Number&lt;span class="w"&gt; &lt;/span&gt;of&lt;span class="w"&gt; &lt;/span&gt;threads:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;150&lt;/span&gt;
Initializing&lt;span class="w"&gt; &lt;/span&gt;random&lt;span class="w"&gt; &lt;/span&gt;number&lt;span class="w"&gt; &lt;/span&gt;generator&lt;span class="w"&gt; &lt;/span&gt;from&lt;span class="w"&gt; &lt;/span&gt;current&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;time&lt;/span&gt;
Initializing&lt;span class="w"&gt; &lt;/span&gt;worker&lt;span class="w"&gt; &lt;/span&gt;threads...
Threads&lt;span class="w"&gt; &lt;/span&gt;started!
SQL&lt;span class="w"&gt; &lt;/span&gt;statistics:
&lt;span class="w"&gt;    &lt;/span&gt;queries&lt;span class="w"&gt; &lt;/span&gt;performed:
&lt;span class="w"&gt;        &lt;/span&gt;read:&lt;span class="w"&gt;                            &lt;/span&gt;&lt;span class="m"&gt;527282&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;write:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;other:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;75326&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;total:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;602608&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;transactions:&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="m"&gt;37663&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;3756&lt;/span&gt;.49&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;queries:&lt;span class="w"&gt;                             &lt;/span&gt;&lt;span class="m"&gt;602608&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;60103&lt;/span&gt;.86&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;ignored&lt;span class="w"&gt; &lt;/span&gt;errors:&lt;span class="w"&gt;                      &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;.00&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;reconnects:&lt;span class="w"&gt;                          &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;.00&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
General&lt;span class="w"&gt; &lt;/span&gt;statistics:
&lt;span class="w"&gt;    &lt;/span&gt;total&lt;span class="w"&gt; &lt;/span&gt;time:&lt;span class="w"&gt;                          &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0247s
&lt;span class="w"&gt;    &lt;/span&gt;total&lt;span class="w"&gt; &lt;/span&gt;number&lt;span class="w"&gt; &lt;/span&gt;of&lt;span class="w"&gt; &lt;/span&gt;events:&lt;span class="w"&gt;              &lt;/span&gt;&lt;span class="m"&gt;37663&lt;/span&gt;
Latency&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;ms&lt;span class="o"&gt;)&lt;/span&gt;:
&lt;span class="w"&gt;         &lt;/span&gt;min:&lt;span class="w"&gt;                                  &lt;/span&gt;&lt;span class="m"&gt;4&lt;/span&gt;.30
&lt;span class="w"&gt;         &lt;/span&gt;avg:&lt;span class="w"&gt;                                 &lt;/span&gt;&lt;span class="m"&gt;39&lt;/span&gt;.88
&lt;span class="w"&gt;         &lt;/span&gt;max:&lt;span class="w"&gt;                               &lt;/span&gt;&lt;span class="m"&gt;8371&lt;/span&gt;.55
&lt;span class="w"&gt;         &lt;/span&gt;95th&lt;span class="w"&gt; &lt;/span&gt;percentile:&lt;span class="w"&gt;                     &lt;/span&gt;&lt;span class="m"&gt;82&lt;/span&gt;.96
&lt;span class="w"&gt;         &lt;/span&gt;sum:&lt;span class="w"&gt;                            &lt;/span&gt;&lt;span class="m"&gt;1501845&lt;/span&gt;.63
Threads&lt;span class="w"&gt; &lt;/span&gt;fairness:
&lt;span class="w"&gt;    &lt;/span&gt;events&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;avg/stddev&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt;           &lt;/span&gt;&lt;span class="m"&gt;251&lt;/span&gt;.0867/87.82
&lt;span class="w"&gt;    &lt;/span&gt;execution&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;avg/stddev&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0123/0.01
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;With dramatic results! Our cluster is now able to process 60K queries
per second! How far can we take this? Well, if you noticed our node
count at the start we have five nodes in our k8s cluster, so lets make
our Galera cluster match that:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;edit&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/cr.yaml
galeraservice.galera.database.coreos.com/galera-example&lt;span class="w"&gt; &lt;/span&gt;edited
$&lt;span class="w"&gt; &lt;/span&gt;kubectl&lt;span class="w"&gt; &lt;/span&gt;describe&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/cr.yaml&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;size
Galera&lt;span class="w"&gt; &lt;/span&gt;_&lt;span class="w"&gt; &lt;/span&gt;Cluster&lt;span class="w"&gt; &lt;/span&gt;_&lt;span class="w"&gt; &lt;/span&gt;Size:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The Ansible operator starts growing the Galera cluster...:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;pods
NAME&lt;span class="w"&gt; &lt;/span&gt;READY&lt;span class="w"&gt; &lt;/span&gt;STATUS&lt;span class="w"&gt; &lt;/span&gt;RESTARTS&lt;span class="w"&gt; &lt;/span&gt;AGE
galera-ansible-operator-bc6cd548-46b2r&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;35m
galera-node-0001&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;32m
galera-node-0002&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;7m
galera-node-0003&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;7m
galera-node-0004&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;38s
galera-node-0005&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;34s
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And again after about a minute or so we have a Galera cluster with five
pods ready to serve queries:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;pods
NAME&lt;span class="w"&gt; &lt;/span&gt;READY&lt;span class="w"&gt; &lt;/span&gt;STATUS&lt;span class="w"&gt; &lt;/span&gt;RESTARTS&lt;span class="w"&gt; &lt;/span&gt;AGE
galera-ansible-operator-bc6cd548-46b2r&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;36m
galera-node-0001&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;33m
galera-node-0002&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;8m
galera-node-0003&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;8m
galera-node-0004&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;1m
galera-node-0005&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;1m
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Oddly, the fifth node had a problem, but OpenShift retried it after it
failed and it came up and into the cluster. Great!&lt;/p&gt;
&lt;p&gt;So let's rerun our same test once again:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;sysbench&lt;span class="w"&gt; &lt;/span&gt;--db-driver&lt;span class="o"&gt;=&lt;/span&gt;mysql&lt;span class="w"&gt; &lt;/span&gt;--threads&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;150&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-host&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;MYSQL_IP&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-port&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;MYSQL_PORT&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-user&lt;span class="o"&gt;=&lt;/span&gt;root&lt;span class="w"&gt; &lt;/span&gt;--mysql-password&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-ignore-errors&lt;span class="o"&gt;=&lt;/span&gt;all&lt;span class="w"&gt; &lt;/span&gt;/usr/share/sysbench/oltp_read_only.lua&lt;span class="w"&gt; &lt;/span&gt;run
sysbench&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;.0.9&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;using&lt;span class="w"&gt; &lt;/span&gt;system&lt;span class="w"&gt; &lt;/span&gt;LuaJIT&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.0.4&lt;span class="o"&gt;)&lt;/span&gt;
Running&lt;span class="w"&gt; &lt;/span&gt;the&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;with&lt;span class="w"&gt; &lt;/span&gt;following&lt;span class="w"&gt; &lt;/span&gt;options:
Number&lt;span class="w"&gt; &lt;/span&gt;of&lt;span class="w"&gt; &lt;/span&gt;threads:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;150&lt;/span&gt;
Initializing&lt;span class="w"&gt; &lt;/span&gt;random&lt;span class="w"&gt; &lt;/span&gt;number&lt;span class="w"&gt; &lt;/span&gt;generator&lt;span class="w"&gt; &lt;/span&gt;from&lt;span class="w"&gt; &lt;/span&gt;current&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;time&lt;/span&gt;
Initializing&lt;span class="w"&gt; &lt;/span&gt;worker&lt;span class="w"&gt; &lt;/span&gt;threads...
Threads&lt;span class="w"&gt; &lt;/span&gt;started!
SQL&lt;span class="w"&gt; &lt;/span&gt;statistics:
queries&lt;span class="w"&gt; &lt;/span&gt;performed:
&lt;span class="w"&gt;        &lt;/span&gt;read:&lt;span class="w"&gt;                            &lt;/span&gt;&lt;span class="m"&gt;869260&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;write:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;other:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;124180&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;total:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;993440&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;transactions:&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="m"&gt;62090&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;6196&lt;/span&gt;.82&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;queries:&lt;span class="w"&gt;                             &lt;/span&gt;&lt;span class="m"&gt;993440&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;99149&lt;/span&gt;.17&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;ignored&lt;span class="w"&gt; &lt;/span&gt;errors:&lt;span class="w"&gt;                      &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;.00&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;reconnects:&lt;span class="w"&gt;                          &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;.00&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
General&lt;span class="w"&gt; &lt;/span&gt;statistics:
&lt;span class="w"&gt;    &lt;/span&gt;total&lt;span class="w"&gt; &lt;/span&gt;time:&lt;span class="w"&gt;                          &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0183s
&lt;span class="w"&gt;    &lt;/span&gt;total&lt;span class="w"&gt; &lt;/span&gt;number&lt;span class="w"&gt; &lt;/span&gt;of&lt;span class="w"&gt; &lt;/span&gt;events:&lt;span class="w"&gt;              &lt;/span&gt;&lt;span class="m"&gt;62090&lt;/span&gt;
Latency&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;ms&lt;span class="o"&gt;)&lt;/span&gt;:
&lt;span class="w"&gt;         &lt;/span&gt;min:&lt;span class="w"&gt;                                  &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;.41
&lt;span class="w"&gt;         &lt;/span&gt;avg:&lt;span class="w"&gt;                                 &lt;/span&gt;&lt;span class="m"&gt;24&lt;/span&gt;.18
&lt;span class="w"&gt;         &lt;/span&gt;max:&lt;span class="w"&gt;                                &lt;/span&gt;&lt;span class="m"&gt;159&lt;/span&gt;.70
&lt;span class="w"&gt;         &lt;/span&gt;95th&lt;span class="w"&gt; &lt;/span&gt;percentile:&lt;span class="w"&gt;                     &lt;/span&gt;&lt;span class="m"&gt;46&lt;/span&gt;.63
&lt;span class="w"&gt;         &lt;/span&gt;sum:&lt;span class="w"&gt;                            &lt;/span&gt;&lt;span class="m"&gt;1501042&lt;/span&gt;.93
Threads&lt;span class="w"&gt; &lt;/span&gt;fairness:
&lt;span class="w"&gt;    &lt;/span&gt;events&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;avg/stddev&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt;           &lt;/span&gt;&lt;span class="m"&gt;413&lt;/span&gt;.9333/78.17
&lt;span class="w"&gt;    &lt;/span&gt;execution&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;avg/stddev&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0070/0.00
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And we're hitting 100K queries per second. Our cluster has thus-far
scaled linearly with the number of nodes we've spun up. At this point,
we've maxed out the resources of our OpenShift cluster, and spinning up
more Galera nodes doesn't help:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;edit&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/cr.yaml
galeraservice.galera.database.coreos.com/galera-example&lt;span class="w"&gt; &lt;/span&gt;edited
$&lt;span class="w"&gt; &lt;/span&gt;kubectl&lt;span class="w"&gt; &lt;/span&gt;describe&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/cr.yaml&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;size
Galera&lt;span class="w"&gt; &lt;/span&gt;_&lt;span class="w"&gt; &lt;/span&gt;Cluster&lt;span class="w"&gt; &lt;/span&gt;_&lt;span class="w"&gt; &lt;/span&gt;Size:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;9&lt;/span&gt;

$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;pods
NAME&lt;span class="w"&gt; &lt;/span&gt;READY&lt;span class="w"&gt; &lt;/span&gt;STATUS&lt;span class="w"&gt; &lt;/span&gt;RESTARTS&lt;span class="w"&gt; &lt;/span&gt;AGE
galera-ansible-operator-bc6cd548-46b2r&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;44m
galera-node-0001&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;41m
galera-node-0002&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;16m
galera-node-0003&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;16m
galera-node-0004&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;9m
galera-node-0005&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;9m
galera-node-0006&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;1m
galera-node-0007&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;1m
galera-node-0008&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;1m
galera-node-0009&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;1m

$&lt;span class="w"&gt; &lt;/span&gt;sysbench&lt;span class="w"&gt; &lt;/span&gt;--db-driver&lt;span class="o"&gt;=&lt;/span&gt;mysql&lt;span class="w"&gt; &lt;/span&gt;--threads&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;150&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-host&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;MYSQL_IP&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-port&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;MYSQL_PORT&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-user&lt;span class="o"&gt;=&lt;/span&gt;root&lt;span class="w"&gt; &lt;/span&gt;--mysql-password&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--mysql-ignore-errors&lt;span class="o"&gt;=&lt;/span&gt;all&lt;span class="w"&gt; &lt;/span&gt;/usr/share/sysbench/oltp_read_only.lua&lt;span class="w"&gt; &lt;/span&gt;run
sysbench&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;.0.9&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;using&lt;span class="w"&gt; &lt;/span&gt;system&lt;span class="w"&gt; &lt;/span&gt;LuaJIT&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.0.4&lt;span class="o"&gt;)&lt;/span&gt;
Running&lt;span class="w"&gt; &lt;/span&gt;the&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;with&lt;span class="w"&gt; &lt;/span&gt;following&lt;span class="w"&gt; &lt;/span&gt;options:
Number&lt;span class="w"&gt; &lt;/span&gt;of&lt;span class="w"&gt; &lt;/span&gt;threads:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;150&lt;/span&gt;
Initializing&lt;span class="w"&gt; &lt;/span&gt;random&lt;span class="w"&gt; &lt;/span&gt;number&lt;span class="w"&gt; &lt;/span&gt;generator&lt;span class="w"&gt; &lt;/span&gt;from&lt;span class="w"&gt; &lt;/span&gt;current&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;time&lt;/span&gt;
Initializing&lt;span class="w"&gt; &lt;/span&gt;worker&lt;span class="w"&gt; &lt;/span&gt;threads...
Threads&lt;span class="w"&gt; &lt;/span&gt;started!
SQL&lt;span class="w"&gt; &lt;/span&gt;statistics:
&lt;span class="w"&gt;    &lt;/span&gt;queries&lt;span class="w"&gt; &lt;/span&gt;performed:
&lt;span class="w"&gt;        &lt;/span&gt;read:&lt;span class="w"&gt;                            &lt;/span&gt;&lt;span class="m"&gt;841260&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;write:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;other:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;120180&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;total:&lt;span class="w"&gt;                           &lt;/span&gt;&lt;span class="m"&gt;961440&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;transactions:&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="m"&gt;60090&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;5995&lt;/span&gt;.71&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;queries:&lt;span class="w"&gt;                             &lt;/span&gt;&lt;span class="m"&gt;961440&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;95931&lt;/span&gt;.35&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;ignored&lt;span class="w"&gt; &lt;/span&gt;errors:&lt;span class="w"&gt;                      &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;.00&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;reconnects:&lt;span class="w"&gt;                          &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;.00&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;sec.&lt;span class="o"&gt;)&lt;/span&gt;
General&lt;span class="w"&gt; &lt;/span&gt;statistics:
&lt;span class="w"&gt;    &lt;/span&gt;total&lt;span class="w"&gt; &lt;/span&gt;time:&lt;span class="w"&gt;                          &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0208s
&lt;span class="w"&gt;    &lt;/span&gt;total&lt;span class="w"&gt; &lt;/span&gt;number&lt;span class="w"&gt; &lt;/span&gt;of&lt;span class="w"&gt; &lt;/span&gt;events:&lt;span class="w"&gt;              &lt;/span&gt;&lt;span class="m"&gt;60090&lt;/span&gt;
Latency&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;ms&lt;span class="o"&gt;)&lt;/span&gt;:
&lt;span class="w"&gt;         &lt;/span&gt;min:&lt;span class="w"&gt;                                  &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;.24
&lt;span class="w"&gt;         &lt;/span&gt;avg:&lt;span class="w"&gt;                                 &lt;/span&gt;&lt;span class="m"&gt;24&lt;/span&gt;.98
&lt;span class="w"&gt;         &lt;/span&gt;max:&lt;span class="w"&gt;                                &lt;/span&gt;&lt;span class="m"&gt;192&lt;/span&gt;.46
&lt;span class="w"&gt;         &lt;/span&gt;95th&lt;span class="w"&gt; &lt;/span&gt;percentile:&lt;span class="w"&gt;                     &lt;/span&gt;&lt;span class="m"&gt;57&lt;/span&gt;.87
&lt;span class="w"&gt;         &lt;/span&gt;sum:&lt;span class="w"&gt;                            &lt;/span&gt;&lt;span class="m"&gt;1501266&lt;/span&gt;.08
Threads&lt;span class="w"&gt; &lt;/span&gt;fairness:
&lt;span class="w"&gt;    &lt;/span&gt;events&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;avg/stddev&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt;           &lt;/span&gt;&lt;span class="m"&gt;400&lt;/span&gt;.6000/134.04
&lt;span class="w"&gt;    &lt;/span&gt;execution&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;avg/stddev&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0084/0.01
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Performance actually decreased a bit! This shows that MySQL/MariaDB are
pretty resource-intensive, so if you want to continue scaling out the
performance you may need to add more OpenShift cluster resources. But at
this point, our cluster is serving nearly 5x the traffic as when we
originally started it up. Continued tuning of MySQL/MariaDB and Galera
could extend that and allow us to increase performance further. However
the goal here was to show how to create an Ansible operator to control a
very complex, data-oriented application.&lt;/p&gt;
&lt;h3&gt;Scaling the cluster down&lt;/h3&gt;
&lt;p&gt;Since those extra nodes aren't helping out (other than providing a bit
more redundancy in the event of a failure), lets scale the cluster back
down to five nodes:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;edit&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/cr.yaml
galeraservice.galera.database.coreos.com/galera-example&lt;span class="w"&gt; &lt;/span&gt;edited
$&lt;span class="w"&gt; &lt;/span&gt;kubectl&lt;span class="w"&gt; &lt;/span&gt;describe&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;deploy/cr.yaml&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;size
Galera&lt;span class="w"&gt; &lt;/span&gt;_&lt;span class="w"&gt; &lt;/span&gt;Cluster&lt;span class="w"&gt; &lt;/span&gt;_&lt;span class="w"&gt; &lt;/span&gt;Size:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;After a short while, we see the operator begin to terminate pods that
are no longer required:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;pods
NAME&lt;span class="w"&gt; &lt;/span&gt;READY&lt;span class="w"&gt; &lt;/span&gt;STATUS&lt;span class="w"&gt; &lt;/span&gt;RESTARTS&lt;span class="w"&gt; &lt;/span&gt;AGE
galera-ansible-operator-bc6cd548-46b2r&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;46m
galera-node-0001&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;43m
galera-node-0002&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;18m
galera-node-0003&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;18m
galera-node-0004&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;11m
galera-node-0005&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;11m
galera-node-0006&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Terminating&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;3m
galera-node-0007&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Terminating&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;3m
galera-node-0008&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Terminating&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;3m
galera-node-0009&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Terminating&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;3m
&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;Disaster recovery&lt;/h3&gt;
&lt;p&gt;Now, let's add some chaos. Looking at our first worker &lt;code&gt;xx-yy-zz-2&lt;/code&gt;, we can see which pods are running on the node:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;describe&lt;span class="w"&gt; &lt;/span&gt;node&lt;span class="w"&gt; &lt;/span&gt;ec2-xx-yy-zz-2.us-east-2.compute.amazonaws.com
...
Non-terminated&lt;span class="w"&gt; &lt;/span&gt;Pods:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;total&lt;span class="o"&gt;)&lt;/span&gt;
Namespace&lt;span class="w"&gt; &lt;/span&gt;Name&lt;span class="w"&gt; &lt;/span&gt;CPU&lt;span class="w"&gt; &lt;/span&gt;Requests&lt;span class="w"&gt; &lt;/span&gt;CPU&lt;span class="w"&gt; &lt;/span&gt;Limits&lt;span class="w"&gt; &lt;/span&gt;Memory&lt;span class="w"&gt; &lt;/span&gt;Requests&lt;span class="w"&gt; &lt;/span&gt;Memory&lt;span class="w"&gt; &lt;/span&gt;Limits
---------&lt;span class="w"&gt; &lt;/span&gt;----&lt;span class="w"&gt; &lt;/span&gt;------------&lt;span class="w"&gt; &lt;/span&gt;----------&lt;span class="w"&gt; &lt;/span&gt;---------------&lt;span class="w"&gt; &lt;/span&gt;-------------
openshift-monitoring&lt;span class="w"&gt; &lt;/span&gt;node-exporter-bqnzv&lt;span class="w"&gt; &lt;/span&gt;10m&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;20m&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;20Mi&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;40Mi&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;
openshift-node&lt;span class="w"&gt; &lt;/span&gt;sync-hjtmj&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;
openshift-sdn&lt;span class="w"&gt; &lt;/span&gt;ovs-55hw4&lt;span class="w"&gt; &lt;/span&gt;100m&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;200m&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;300Mi&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;4&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;400Mi&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;
openshift-sdn&lt;span class="w"&gt; &lt;/span&gt;sdn-rd7kp&lt;span class="w"&gt; &lt;/span&gt;100m&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;200Mi&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="nb"&gt;test&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;galera-node-0004&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="o"&gt;)&lt;/span&gt;
...
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So galera-node-0004 is running here, along with some other
infrastructure bits. Lets restart it from the AWS EC2 console and see
what happens...&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;nodes
NAME&lt;span class="w"&gt; &lt;/span&gt;STATUS&lt;span class="w"&gt; &lt;/span&gt;AGE
ec2-xx-yy-zz-1.us-east-2.compute.amazonaws.com&lt;span class="w"&gt; &lt;/span&gt;Ready&lt;span class="w"&gt; &lt;/span&gt;1d
ec2-xx-yy-zz-2.us-east-2.compute.amazonaws.com&lt;span class="w"&gt; &lt;/span&gt;NotReady&lt;span class="w"&gt; &lt;/span&gt;1d
ec2-xx-yy-zz-3.us-east-2.compute.amazonaws.com&lt;span class="w"&gt; &lt;/span&gt;Ready&lt;span class="w"&gt; &lt;/span&gt;1d
ec2-xx-yy-zz-4.us-east-2.compute.amazonaws.com&lt;span class="w"&gt; &lt;/span&gt;Ready&lt;span class="w"&gt; &lt;/span&gt;1d
ec2-xx-yy-zz-5.us-east-2.compute.amazonaws.com&lt;span class="w"&gt; &lt;/span&gt;Ready&lt;span class="w"&gt; &lt;/span&gt;1d
ec2-xx-yy-zz-6.us-east-2.compute.amazonaws.com&lt;span class="w"&gt; &lt;/span&gt;Ready&lt;span class="w"&gt; &lt;/span&gt;1d
ec2-xx-yy-zz-7.us-east-2.compute.amazonaws.com&lt;span class="w"&gt; &lt;/span&gt;Ready&lt;span class="w"&gt; &lt;/span&gt;1d
ec2-xx-yy-zz-8.us-east-2.compute.amazonaws.com&lt;span class="w"&gt; &lt;/span&gt;Ready&lt;span class="w"&gt; &lt;/span&gt;1d
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Eventually, we see galera-node-0004 enter an unknown state:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;pods
NAME&lt;span class="w"&gt; &lt;/span&gt;READY&lt;span class="w"&gt; &lt;/span&gt;STATUS&lt;span class="w"&gt; &lt;/span&gt;RESTARTS&lt;span class="w"&gt; &lt;/span&gt;AGE
galera-ansible-operator-bc6cd548-46b2r&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;50m
galera-node-0001&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;47m
galera-node-0002&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;22m
galera-node-0003&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;22m
galera-node-0004&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Unknown&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;16m
galera-node-0005&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;16m
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And in a while the pod will be terminated, after which the Ansible
operator will restart it:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;pods
NAME&lt;span class="w"&gt; &lt;/span&gt;READY&lt;span class="w"&gt; &lt;/span&gt;STATUS&lt;span class="w"&gt; &lt;/span&gt;RESTARTS&lt;span class="w"&gt; &lt;/span&gt;AGE
galera-ansible-operator-bc6cd548-46b2r&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;55m
galera-node-0001&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;52m
galera-node-0002&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;27m
galera-node-0003&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;27m
galera-node-0004&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;1m
galera-node-0005&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt; &lt;/span&gt;Running&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;21m
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;... and our cluster is back to its requested capacity!&lt;/p&gt;
&lt;h3&gt;Cleanup&lt;/h3&gt;
&lt;p&gt;Since this is a test we'll want to clean up after ourselves. When we're
done we use the delete_operator.sh script to remove the custom resource
and the operator deployment:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;./delete_operator.sh
galeraservice.galera.database.coreos.com&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"galera-example"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;deleted
deployment.apps&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"galera-ansible-operator"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;deleted
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In a couple of minutes, everything is gone:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;all
NAME&lt;span class="w"&gt; &lt;/span&gt;DOCKER&lt;span class="w"&gt; &lt;/span&gt;REPO&lt;span class="w"&gt; &lt;/span&gt;TAGS&lt;span class="w"&gt; &lt;/span&gt;UPDATED
is/galera-ansible-operator&lt;span class="w"&gt; &lt;/span&gt;docker-registry-default.router...:5000/test/galera-ansible-operator&lt;span class="w"&gt; &lt;/span&gt;latest&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;4&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;hours&lt;span class="w"&gt; &lt;/span&gt;ago
&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;Summary&lt;/h2&gt;
&lt;p&gt;The Galera operator is a work in progress and is most definitely not
ready for production. If you'd like to view the playbooks themselves,
you can see the code here:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/water-hole/galera-ansible-operator"&gt;https://github.com/water-hole/galera-ansible-operator&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;We're going to be continuing development on this with the goal of
making it the de facto example for other data storage applications.
Thanks for reading!&lt;/p&gt;</description><guid>https://ansible.com/blog/kubernetes-operators-ansible-deep-dive-part-2/</guid><pubDate>Thu, 01 Aug 2019 00:00:00 GMT</pubDate></item><item><title>Kubernetes Operators with Ansible Deep Dive, Part 1</title><link>https://ansible.com/blog/kubernetes-operators-ansible-deep-dive-part-1/</link><dc:creator>James Cammarata</dc:creator><description>&lt;h2&gt;Kubernetes Operators with Ansible Deep Dive, Part 1&lt;/h2&gt;
&lt;p&gt;This deep dive series assumes the reader has access to a Kubernetes test
environment. A tool like minikube is an acceptable platform for the
purposes of this article. If you are an existing Red Hat customer,
another option is spinning up an OpenShift cluster
through &lt;a href="https://cloud.redhat.com/"&gt;cloud.redhat.com&lt;/a&gt;. This
SaaS portal makes trying OpenShift a turnkey operation.&lt;/p&gt;
&lt;p&gt;In this part of this deep dive series, we'll:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Take a look at operators overall, and what they do in OpenShift/Kubernetes.&lt;/li&gt;
&lt;li&gt;Take a quick look at the Operator SDK, and why you'd want to use an Ansible operator rather than other kinds of operators provided by the SDK.&lt;/li&gt;
&lt;li&gt;And finally, how Ansible Operators are structured and the relevant files created by the Operator SDK.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;What Are Operators?&lt;/h3&gt;
&lt;p&gt;For those who may not be very familiar with Kubernetes, it is, in its
most simplistic description - a resource manager. Users specify how much
of a given resource they want and Kubernetes manages those resources to
achieve the state the user specified. These resources can be pods (which
contain one or more containers), persistent volumes, or even custom
resources defined by users.&lt;/p&gt;
&lt;p&gt;This makes Kubernetes useful for managing resources that don't contain
any state (like pods of web servers or load balancing resources).
However, Kubernetes doesn't provide any built-in logic for managing
resources like databases or caches which are stateful and sensitive to
restarts. Operators were created to bridge this gap by providing a way
for users to specify a piece of code (traditionally written in Golang)
tied to &lt;a href="https://docs.openshift.com/container-platform/4.1/applications/crds/crd-extending-api-with-crds.html"&gt;custom resource definitions&lt;/a&gt;
in Kubernetes.&lt;/p&gt;
&lt;p&gt;Operators were so named because they allow you to embed your operational logic of an application into an automated manager running on Kubernetes/OpenShift.&lt;/p&gt;
&lt;h3&gt;The Operator SDK, and a quick overview of Ansible Operators&lt;/h3&gt;
&lt;p&gt;Red Hat created the &lt;a href="https://blog.openshift.com/introducing-the-operator-framework/%26sa=D%26ust=1563546779219000"&gt;Operator Framework&lt;/a&gt;
to make the job of creating and managing operators easier across their full
lifetime. As part of the framework, the Operator SDK is tasked with
creating and building operators in an automated manner for users. Over
time it has grown to add several operator types. In 2018, we began work
on adding the Ansible Operator type to the SDK. We want to make it
easier to build operators in Kubernetes environments based on Ansible.&lt;/p&gt;
&lt;h4&gt;Why use Ansible for Operators?&lt;/h4&gt;
&lt;p&gt;At first, operators were written in Golang. This immediately sets the
bar somewhat high for anyone who wants to write an operator --- someone
has to know a relatively low-level programming language to get started.
On top of this, you must also be familiar with Kubernetes internals,
such as the API and how events are generated for resources.&lt;/p&gt;
&lt;p&gt;The Ansible Operator was created to address this short-coming. The
Ansible Operator consists of two main pieces:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;A small chunk of Golang code, which handles the interface between Kubernetes/OpenShift and the operator.&lt;/li&gt;
&lt;li&gt;A container, which receives events from the above code and runs Ansible Playbooks as required.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;That's it! The Ansible and Operator SDK abstract away all of the
difficult parts of writing an operator and allows you to focus on what
matters --- managing your applications. If you already have a large base
of Ansible knowledge in your organization, you can immediately begin
managing applications using Ansible Operator. A further added bonus of
using Ansible for your operators is that you immediately have access to
any module that Ansible can run. This allows folks to incorporate
off-cluster management tasks related to your application. For example:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Creating DNS entries for your newly deployed applications&lt;/li&gt;
&lt;li&gt;Spinning up resources external to your cluster, such as storage or
    networking&lt;/li&gt;
&lt;li&gt;More easily do off-site backups to external cloud services&lt;/li&gt;
&lt;li&gt;Manage external load balancing based on custom metrics&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;There are a number of possibilities that Kubernetes Operators written with Ansible can provide a potential solution for.&lt;/p&gt;
&lt;h3&gt;Creating a Kubernetes Operator with Ansible from scratch&lt;/h3&gt;
&lt;p&gt;First, &lt;a href="https://github.com/operator-framework/operator-sdk/blob/master/doc/user/install-operator-sdk.md"&gt;install the Operator SDK&lt;/a&gt;
following their instructions. Once the install is complete, we can create a new operator with the following command:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;$&lt;span class="w"&gt; &lt;/span&gt;operator-sdk&lt;span class="w"&gt; &lt;/span&gt;new&lt;span class="w"&gt; &lt;/span&gt;test-operator&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;--api-version&lt;span class="o"&gt;=&lt;/span&gt;test.ansible-operator.com/v1&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;--kind&lt;span class="o"&gt;=&lt;/span&gt;Test&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;--type&lt;span class="o"&gt;=&lt;/span&gt;ansible

INFO&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;0000&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;Creating&lt;span class="w"&gt; &lt;/span&gt;new&lt;span class="w"&gt; &lt;/span&gt;Ansible&lt;span class="w"&gt; &lt;/span&gt;operator&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'test-operator'&lt;/span&gt;.
...
INFO&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;0000&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;Project&lt;span class="w"&gt; &lt;/span&gt;creation&lt;span class="w"&gt; &lt;/span&gt;complete.

$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;test-operator/
&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;Kubernetes Operator with Ansible structure and files&lt;/h3&gt;
&lt;p&gt;[Now that we have our Operator skeleton, let's take a look at some of
the main files used when deploying Operators in general, as well as what
the Ansible Operator type generated specifically. These are the:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;watches.yaml&lt;/code&gt; file.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;build&lt;/code&gt; directory.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;deploy&lt;/code&gt; directory.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;roles&lt;/code&gt; directory.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;One other directory is present here as well: the molecule directory,
which contains files to automate testing your roles/playbooks
using &lt;a href="https://molecule.readthedocs.io/en/stable/%26sa=D%26ust=1563546779225000"&gt;Molecule&lt;/a&gt;.
We will not be covering the use of Molecule here it's noted for the sake
of being complete.&lt;/p&gt;
&lt;p&gt;If you run &lt;code&gt;ls -l&lt;/code&gt; in the above &lt;code&gt;test-operator&lt;/code&gt; directory, you see these files/directories there after creating the new operator skeleton.&lt;/p&gt;
&lt;h4&gt;The watches.yaml file&lt;/h4&gt;
&lt;p&gt;This file is used by the Ansible Operator to tell Kubernetes/OpenShift
which custom resources (based on the Group/Version/Kind fields) the
operator is responsible in handling. It is the glue that ties our custom
code to the Kubernetes API:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;&lt;span class="nn"&gt;---&lt;/span&gt;
&lt;span class="p p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;version&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;v1&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;group&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;test.ansible-operator.com&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;kind&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;Test&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;role&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;/opt/ansible/roles/test&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;specifying any other playbook boilerplate. However if you are running
more than one role in your operator you can change that line to be:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;playbook:&lt;span class="w"&gt; &lt;/span&gt;/opt/ansible/playbook.yaml
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Also, you'll need to tweak the &lt;code&gt;build/Dockerfile&lt;/code&gt; (more on this below) to
copy the playbook into the container so add this line:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;COPY&lt;span class="w"&gt; &lt;/span&gt;playbook.yaml&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;HOME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/playbook.yaml
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;You would then create the specified playbook in the same directory as
the &lt;code&gt;watches.yaml&lt;/code&gt; file.&lt;/p&gt;
&lt;h4&gt;The build directory&lt;/h4&gt;
&lt;p&gt;This directory contains a few files related to building the operator
artifact. Because operators are just another application to
OpenShift/Kubernetes, this artifact is a container built using
a &lt;code&gt;Dockerfile&lt;/code&gt;. The other files here are related to testing via Molecule, which we are not
going to cover in this blog series.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;Dockerfile&lt;/code&gt; is very simple, so we won't delve into it much other than to say it is based on
the ansible-operator image from &lt;a href="https://quay.io/%26sa=D%26ust=1563546779229000"&gt;quay.io&lt;/a&gt;, and copies the roles and watches.yml file into
the container image.&lt;/p&gt;
&lt;h4&gt;The deploy directory&lt;/h4&gt;
&lt;p&gt;This directory contains YAML files for deploying the operator into
OpenShift/K8s using the &lt;code&gt;oc&lt;/code&gt; CLI commands.&lt;/p&gt;
&lt;p&gt;The CustomResourceDefinition (CRD) and CustomResource (CR) are defined
in the &lt;code&gt;deploy/crds/&lt;/code&gt; directory. The CRD is what
the &lt;code&gt;watches.yaml&lt;/code&gt; file references, meaning
all instances (CRs) of this definition will be controlled by our operator.&lt;/p&gt;
&lt;p&gt;The CRD is defined in &lt;code&gt;deploy/crds/test_v1_test_crd.yaml&lt;/code&gt; and is mostly boilerplate
for OpenShift/Kubernetes:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;&lt;span class="nt"&gt;apiVersion&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;apiextensions.k8s.io/v1beta1&lt;/span&gt;
&lt;span class="nt"&gt;kind&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;CustomResourceDefinition&lt;/span&gt;
&lt;span class="nt"&gt;metadata&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;tests.test.ansible-operator.com&lt;/span&gt;
&lt;span class="nt"&gt;spec&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;You can see the operator-sdk command above filled in most of these
fields with the values we specified. By themselves, CRDs are not very
useful, you need actual instances of what they define --- this is what
CustomResources do. Our CustomResource (CR) is defined
in &lt;code&gt;deploy/crds/test_v1_test_cr.yaml&lt;/code&gt;, and is relatively short
(compared to the other YAML files, anyway):&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;&lt;span class="nt"&gt;apiVersion&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;test.ansible-operator.com/v1&lt;/span&gt;
&lt;span class="nt"&gt;kind&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;Test&lt;/span&gt;
&lt;span class="nt"&gt;metadata&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;example-test&lt;/span&gt;
&lt;span class="nt"&gt;spec&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;size&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;3&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Each of the values set under the spec entry become variables passed into
Ansible as extra variables. Using these, we can customize the behavior
of our operator. The default example creates an entry named size, which
we can use in our roles to dynamically scale the application our
operator is managing.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;deploy/role.yaml&lt;/code&gt; and &lt;code&gt;deploy/role_binding.yaml&lt;/code&gt;
(not shown), define some RBAC controls which give your login access to
manage the custom resources defined above. Role Based Access Control
(RBAC) is not covered in this post, so again we're just mentioning them
for completeness.&lt;/p&gt;
&lt;p&gt;Finally, the &lt;code&gt;deploy/operator.yaml&lt;/code&gt;:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;&lt;span class="nt"&gt;apiVersion&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;apps/v1&lt;/span&gt;
&lt;span class="nt"&gt;kind&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;Deployment&lt;/span&gt;
&lt;span class="nt"&gt;metadata&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;test-operator&lt;/span&gt;
&lt;span class="nt"&gt;spec&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This file is quite long, but mainly it creates a new Deployment
resource in OpenShift/Kubernetes, which helps ensure that our operator
stays up and running.&lt;/p&gt;
&lt;h4&gt;The roles directory&lt;/h4&gt;
&lt;p&gt;This is the directory where you place any roles you wish to include
with your operator, and should be familiar to experienced Ansible users.
As noted above, this directory is copied completely into the Ansible
Operator container, and roles here can be referenced in the &lt;code&gt;watches.yaml&lt;/code&gt;
file or other playbooks you include.&lt;/p&gt;
&lt;p&gt;Roles commonly use the &lt;code&gt;k8s&lt;/code&gt; module (included in Red
Hat Ansible Automation since the 2.6 release) to manage resources on the
cluster. If you are familiar with Kubernetes resource files, this module
will be very intuitive (the YAML from a resource file can be copy/pasted
directly as the input to this module). To learn more, you can read the
documentation for the k8s module here:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://docs.ansible.com/ansible/latest/modules/k8s_module.html%26sa=D%26ust=1563546779234000"&gt;https://docs.ansible.com/ansible/latest/modules/k8s_module.html&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;Summary&lt;/h3&gt;
&lt;p&gt;This concludes our deep dive into operators, Operator SDK, and Ansible
Operator creation and structure. Operators written using Ansible give
you the power of operators in general, while allowing you to leverage
preexisting Ansible expertise to quickly get up to speed on deploying
applications on OpenShift or Kubernetes.&lt;/p&gt;</description><guid>https://ansible.com/blog/kubernetes-operators-ansible-deep-dive-part-1/</guid><pubDate>Thu, 25 Jul 2019 00:00:00 GMT</pubDate></item></channel></rss>